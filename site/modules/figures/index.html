
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A web application to explore the mouse Lipid Brain Atlas.">
      
      
        <meta name="author" content="Colas Droin">
      
      
        <link rel="canonical" href="https://TOUPDATE.com/modules/figures/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>figures - LBAE technical documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#modules.figures" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LBAE technical documentation" class="md-header__button md-logo" aria-label="LBAE technical documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LBAE technical documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              figures
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ColasDroin/lbae" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LBAE technical documentation" class="md-nav__button md-logo" aria-label="LBAE technical documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    LBAE technical documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ColasDroin/lbae" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome page
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../main/" class="md-nav__link">
        main
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../app/" class="md-nav__link">
        app
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index_py/" class="md-nav__link">
        index
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Modules
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modules" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Modules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../atlas_labels/" class="md-nav__link">
        atlas_labels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../atlas/" class="md-nav__link">
        atlas
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          figures
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        figures
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules.figures" class="md-nav__link">
    modules.figures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.figures.Figures" class="md-nav__link">
    Figures
  </a>
  
    <nav class="md-nav" aria-label="Figures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.build_lipid_heatmap_from_image" class="md-nav__link">
    build_lipid_heatmap_from_image()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_3D_root_volume" class="md-nav__link">
    compute_3D_root_volume()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_3D_volume_figure" class="md-nav__link">
    compute_3D_volume_figure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_array_basic_images" class="md-nav__link">
    compute_array_basic_images()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_array_coordinates_3D" class="md-nav__link">
    compute_array_coordinates_3D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_barplots_enrichment" class="md-nav__link">
    compute_barplots_enrichment()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_clustergram_figure" class="md-nav__link">
    compute_clustergram_figure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_figure_basic_image" class="md-nav__link">
    compute_figure_basic_image()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_figure_slices_3D" class="md-nav__link">
    compute_figure_slices_3D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_heatmap_lipid_genes" class="md-nav__link">
    compute_heatmap_lipid_genes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_heatmap_per_lipid_selection" class="md-nav__link">
    compute_heatmap_per_lipid_selection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_heatmap_per_mz" class="md-nav__link">
    compute_heatmap_per_mz()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_image_per_lipid" class="md-nav__link">
    compute_image_per_lipid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_l_array_2D" class="md-nav__link">
    compute_l_array_2D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_normalization_factor_across_slices" class="md-nav__link">
    compute_normalization_factor_across_slices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_rgb_array_per_lipid_selection" class="md-nav__link">
    compute_rgb_array_per_lipid_selection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_rgb_image_per_lipid_selection" class="md-nav__link">
    compute_rgb_image_per_lipid_selection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_scatter_3D" class="md-nav__link">
    compute_scatter_3D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_spectrum_high_res" class="md-nav__link">
    compute_spectrum_high_res()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_spectrum_low_res" class="md-nav__link">
    compute_spectrum_low_res()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_treemaps_figure" class="md-nav__link">
    compute_treemaps_figure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.get_array_of_annotations" class="md-nav__link">
    get_array_of_annotations()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.get_surface" class="md-nav__link">
    get_surface()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.return_empty_spectrum" class="md-nav__link">
    return_empty_spectrum()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.return_heatmap_lipid" class="md-nav__link">
    return_heatmap_lipid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.shelve_all_arrays_annotation" class="md-nav__link">
    shelve_all_arrays_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.shelve_all_l_array_2D" class="md-nav__link">
    shelve_all_l_array_2D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.shelve_arrays_basic_figures" class="md-nav__link">
    shelve_arrays_basic_figures()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../launch/" class="md-nav__link">
        launch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../maldi_data/" class="md-nav__link">
        maldi_data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scRNAseq/" class="md-nav__link">
        scRNAseq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_8" type="checkbox" id="__nav_5_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_8">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tools" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_8">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/atlas/" class="md-nav__link">
        Atlas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/image/" class="md-nav__link">
        Image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/lookup_tables/" class="md-nav__link">
        Lookup tables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/maldi_conversion/" class="md-nav__link">
        Maldi conversion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/misc/" class="md-nav__link">
        Misc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/spectra/" class="md-nav__link">
        Spectra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/volume/" class="md-nav__link">
        Volume
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Pages
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pages" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Pages
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pages/home/" class="md-nav__link">
        home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pages/sidebar/" class="md-nav__link">
        sidebar
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pages/load_slice/" class="md-nav__link">
        load_slice
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pages/lipid_selection/" class="md-nav__link">
        lipid_selection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pages/region_analysis/" class="md-nav__link">
        region_analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pages/threeD_exploration/" class="md-nav__link">
        threeD_exploration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pages/scRNAseq/" class="md-nav__link">
        scRNAseq
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules.figures" class="md-nav__link">
    modules.figures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.figures.Figures" class="md-nav__link">
    Figures
  </a>
  
    <nav class="md-nav" aria-label="Figures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.build_lipid_heatmap_from_image" class="md-nav__link">
    build_lipid_heatmap_from_image()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_3D_root_volume" class="md-nav__link">
    compute_3D_root_volume()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_3D_volume_figure" class="md-nav__link">
    compute_3D_volume_figure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_array_basic_images" class="md-nav__link">
    compute_array_basic_images()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_array_coordinates_3D" class="md-nav__link">
    compute_array_coordinates_3D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_barplots_enrichment" class="md-nav__link">
    compute_barplots_enrichment()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_clustergram_figure" class="md-nav__link">
    compute_clustergram_figure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_figure_basic_image" class="md-nav__link">
    compute_figure_basic_image()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_figure_slices_3D" class="md-nav__link">
    compute_figure_slices_3D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_heatmap_lipid_genes" class="md-nav__link">
    compute_heatmap_lipid_genes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_heatmap_per_lipid_selection" class="md-nav__link">
    compute_heatmap_per_lipid_selection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_heatmap_per_mz" class="md-nav__link">
    compute_heatmap_per_mz()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_image_per_lipid" class="md-nav__link">
    compute_image_per_lipid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_l_array_2D" class="md-nav__link">
    compute_l_array_2D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_normalization_factor_across_slices" class="md-nav__link">
    compute_normalization_factor_across_slices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_rgb_array_per_lipid_selection" class="md-nav__link">
    compute_rgb_array_per_lipid_selection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_rgb_image_per_lipid_selection" class="md-nav__link">
    compute_rgb_image_per_lipid_selection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_scatter_3D" class="md-nav__link">
    compute_scatter_3D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_spectrum_high_res" class="md-nav__link">
    compute_spectrum_high_res()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_spectrum_low_res" class="md-nav__link">
    compute_spectrum_low_res()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.compute_treemaps_figure" class="md-nav__link">
    compute_treemaps_figure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.get_array_of_annotations" class="md-nav__link">
    get_array_of_annotations()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.get_surface" class="md-nav__link">
    get_surface()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.return_empty_spectrum" class="md-nav__link">
    return_empty_spectrum()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.return_heatmap_lipid" class="md-nav__link">
    return_heatmap_lipid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.shelve_all_arrays_annotation" class="md-nav__link">
    shelve_all_arrays_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.shelve_all_l_array_2D" class="md-nav__link">
    shelve_all_l_array_2D()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.figures.Figures.shelve_arrays_basic_figures" class="md-nav__link">
    shelve_arrays_basic_figures()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/ColasDroin/lbae/edit/master/docs/modules/figures.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>figures</h1>

<div class="doc doc-object doc-module">


<a id="modules.figures"></a>
  <div class="doc doc-contents first">
  
      <p>This class is used to produce the figures and widgets used in the app, themselves requiring data
from the MALDI imaging, and the Allen Brain Atlas, as well as the mapping between the two.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="modules.figures.Figures" class="doc doc-heading">
        <code>Figures</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>This class is used to produce the figures and widgets used in the app. It uses the special
attribute <strong>slots</strong> for faster access to the attributes. Parameters are ignored in the docstring
of the listed methods below to save space. Please consult the docstring of the actual methods
in the source-code for more information:</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>_data</code></td>
          <td>
                <code>MaldiData</code>
          </td>
          <td><p>MaldiData object, used to manipulate the raw MALDI data.</p></td>
        </tr>
        <tr>
          <td><code>_storage</code></td>
          <td>
                <code>Storage</code>
          </td>
          <td><p>Used to access the shelve database.</p></td>
        </tr>
        <tr>
          <td><code>_atlas</code></td>
          <td>
                <code>Atlas</code>
          </td>
          <td><p>Used to manipulate the objects coming from the Allen Brain Atlas.</p></td>
        </tr>
        <tr>
          <td><code>_scRNAseq</code></td>
          <td>
                <code>ScRNAseq</code>
          </td>
          <td><p>Used to manipulate the objects coming from the scRNAseq dataset.</p></td>
        </tr>
        <tr>
          <td><code>dic_normalization_factors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>Dictionnary of normalization factors across slices for
MAIA.</p></td>
        </tr>
    </tbody>
  </table>

<details class="methods">
  <summary>Methods</summary>
  <p><strong>init</strong>(): Initialize the Figures class.
compute_array_basic_images(): Computes a three-dimensional array representing all slices
    from the maldi_data acquisition (TIC) or the corresponding image from the atlas.
compute_figure_basic_image(): Computes a figure representing slices from the TIC or the
    corresponding image from the atlas.
compute_figure_slices_3D(): Computes a figure representing all slices from the maldi data in
    3D.
get_surface(): Computes a Plotly Surface representing the requested slice in 3D.
compute_image_per_lipid(): Allows to query the MALDI data to extract an image representing
    the intensity of each lipid in the requested slice.
compute_normalization_factor_across_slices(): Computes a dictionnary of normalization
    factors across all slices.
build_lipid_heatmap_from_image(): Converts a numpy array into a base64 string, a go.Image,
    or a Plotly Figure.
compute_heatmap_per_mz(): Computes a heatmap of the lipid expressed in the requested slice
    whose m/z is between the two provided boundaries.
compute_heatmap_per_lipid_selection(): Computes a heatmap of the sum of expression of the
    requested lipids in the requested slice.
compute_rgb_array_per_lipid_selection(): Computes a numpy RGB array of expression of the
    requested lipids in the requested slice.
compute_rgb_image_per_lipid_selection(): Similar to compute_heatmap_per_lipid_selection, but
    computes an RGB image instead of a heatmap.
compute_spectrum_low_res(): Returns the full (low-resolution) spectrum of the requested
    slice.
compute_spectrum_high_res(): Returns the full (high-resolution) spectrum of the requested
    slice between the two provided m/z boundaries.
return_empty_spectrum(): Returns an empty spectrum.
return_heatmap_lipid(): Either generate a Plotly Figure containing an empty go.Heatmap,
    or complete the figure passed as argument with a proper layout that matches the theme of
    the app.
compute_treemaps_figure(): Generates a Plotly Figure containing a treemap of the Allen Brain
    Atlas hierarchy.
compute_3D_root_volume(): Generate a go.Isosurface of the Allen Brain root structure,
    which will be used to enclose the display of lipid expression of other structures in the
    brain.
get_array_of_annotations(): Returns the array of annotations from the Allen Brain Atlas,
    subsampled to decrease the size of the output.
compute_l_array_2D(): Gets the list of expression per slice for all slices for the
    computation of the 3D brain volume.
compute_array_coordinates_3D(): Computes the list of coordinates and expression values for
    the voxels used in the 3D representation of the brain.
compute_3D_volume_figure(): Computes a Plotly Figure containing a go.Volume object
    representing the expression of the requested lipids in the selected regions.
compute_clustergram_figure(): Computes a Plotly Clustergram figure, allowing to cluster and
    compare the expression of all the MAIA-transformed lipids in the dataset in the selected
    regions.
compute_scatter_3D(): cmputes a figure representing, in a 3D scatter plot, the spots
    acquired using spatial scRNAseq experiments.
compute_barplots_enrichment(): Computes two figures representing, in barplots, the lipid
    expression in the spots acquired using spatial scRNAseq experiments, as well as how it
    can be explained by an elastic net regression using gene expression as explaing factors.
compute_heatmap_lipid_genes(): Computes a heatmap representing the expression of a
given lipid in the MALDI data and the expressions of the selected genes.
shelve_arrays_basic_figures(): Shelves in the database all the arrays of basic images
    computed in compute_figure_basic_image(), across all slices and all types of arrays.
shelve_all_l_array_2D(): Precomputes and shelves all the arrays of lipid expression used in
    a 3D representation of the brain.
shelve_all_arrays_annotation(): Precomputes and shelves the array of structure annotation
    used in a 3D representation of the brain.</p>
</details>

        <details class="quote">
          <summary>Source code in <code>modules/figures.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Figures</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class is used to produce the figures and widgets used in the app. It uses the special</span>
<span class="sd">    attribute __slots__ for faster access to the attributes. Parameters are ignored in the docstring</span>
<span class="sd">    of the listed methods below to save space. Please consult the docstring of the actual methods</span>
<span class="sd">    in the source-code for more information:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _data (MaldiData): MaldiData object, used to manipulate the raw MALDI data.</span>
<span class="sd">        _storage (Storage): Used to access the shelve database.</span>
<span class="sd">        _atlas (Atlas): Used to manipulate the objects coming from the Allen Brain Atlas.</span>
<span class="sd">        _scRNAseq (ScRNAseq): Used to manipulate the objects coming from the scRNAseq dataset.</span>
<span class="sd">        dic_normalization_factors (dict): Dictionnary of normalization factors across slices for</span>
<span class="sd">            MAIA.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __init__(): Initialize the Figures class.</span>
<span class="sd">        compute_array_basic_images(): Computes a three-dimensional array representing all slices</span>
<span class="sd">            from the maldi_data acquisition (TIC) or the corresponding image from the atlas.</span>
<span class="sd">        compute_figure_basic_image(): Computes a figure representing slices from the TIC or the</span>
<span class="sd">            corresponding image from the atlas.</span>
<span class="sd">        compute_figure_slices_3D(): Computes a figure representing all slices from the maldi data in</span>
<span class="sd">            3D.</span>
<span class="sd">        get_surface(): Computes a Plotly Surface representing the requested slice in 3D.</span>
<span class="sd">        compute_image_per_lipid(): Allows to query the MALDI data to extract an image representing</span>
<span class="sd">            the intensity of each lipid in the requested slice.</span>
<span class="sd">        compute_normalization_factor_across_slices(): Computes a dictionnary of normalization</span>
<span class="sd">            factors across all slices.</span>
<span class="sd">        build_lipid_heatmap_from_image(): Converts a numpy array into a base64 string, a go.Image,</span>
<span class="sd">            or a Plotly Figure.</span>
<span class="sd">        compute_heatmap_per_mz(): Computes a heatmap of the lipid expressed in the requested slice</span>
<span class="sd">            whose m/z is between the two provided boundaries.</span>
<span class="sd">        compute_heatmap_per_lipid_selection(): Computes a heatmap of the sum of expression of the</span>
<span class="sd">            requested lipids in the requested slice.</span>
<span class="sd">        compute_rgb_array_per_lipid_selection(): Computes a numpy RGB array of expression of the</span>
<span class="sd">            requested lipids in the requested slice.</span>
<span class="sd">        compute_rgb_image_per_lipid_selection(): Similar to compute_heatmap_per_lipid_selection, but</span>
<span class="sd">            computes an RGB image instead of a heatmap.</span>
<span class="sd">        compute_spectrum_low_res(): Returns the full (low-resolution) spectrum of the requested</span>
<span class="sd">            slice.</span>
<span class="sd">        compute_spectrum_high_res(): Returns the full (high-resolution) spectrum of the requested</span>
<span class="sd">            slice between the two provided m/z boundaries.</span>
<span class="sd">        return_empty_spectrum(): Returns an empty spectrum.</span>
<span class="sd">        return_heatmap_lipid(): Either generate a Plotly Figure containing an empty go.Heatmap,</span>
<span class="sd">            or complete the figure passed as argument with a proper layout that matches the theme of</span>
<span class="sd">            the app.</span>
<span class="sd">        compute_treemaps_figure(): Generates a Plotly Figure containing a treemap of the Allen Brain</span>
<span class="sd">            Atlas hierarchy.</span>
<span class="sd">        compute_3D_root_volume(): Generate a go.Isosurface of the Allen Brain root structure,</span>
<span class="sd">            which will be used to enclose the display of lipid expression of other structures in the</span>
<span class="sd">            brain.</span>
<span class="sd">        get_array_of_annotations(): Returns the array of annotations from the Allen Brain Atlas,</span>
<span class="sd">            subsampled to decrease the size of the output.</span>
<span class="sd">        compute_l_array_2D(): Gets the list of expression per slice for all slices for the</span>
<span class="sd">            computation of the 3D brain volume.</span>
<span class="sd">        compute_array_coordinates_3D(): Computes the list of coordinates and expression values for</span>
<span class="sd">            the voxels used in the 3D representation of the brain.</span>
<span class="sd">        compute_3D_volume_figure(): Computes a Plotly Figure containing a go.Volume object</span>
<span class="sd">            representing the expression of the requested lipids in the selected regions.</span>
<span class="sd">        compute_clustergram_figure(): Computes a Plotly Clustergram figure, allowing to cluster and</span>
<span class="sd">            compare the expression of all the MAIA-transformed lipids in the dataset in the selected</span>
<span class="sd">            regions.</span>
<span class="sd">        compute_scatter_3D(): cmputes a figure representing, in a 3D scatter plot, the spots</span>
<span class="sd">            acquired using spatial scRNAseq experiments.</span>
<span class="sd">        compute_barplots_enrichment(): Computes two figures representing, in barplots, the lipid</span>
<span class="sd">            expression in the spots acquired using spatial scRNAseq experiments, as well as how it</span>
<span class="sd">            can be explained by an elastic net regression using gene expression as explaing factors.</span>
<span class="sd">        compute_heatmap_lipid_genes(): Computes a heatmap representing the expression of a</span>
<span class="sd">        given lipid in the MALDI data and the expressions of the selected genes.</span>
<span class="sd">        shelve_arrays_basic_figures(): Shelves in the database all the arrays of basic images</span>
<span class="sd">            computed in compute_figure_basic_image(), across all slices and all types of arrays.</span>
<span class="sd">        shelve_all_l_array_2D(): Precomputes and shelves all the arrays of lipid expression used in</span>
<span class="sd">            a 3D representation of the brain.</span>
<span class="sd">        shelve_all_arrays_annotation(): Precomputes and shelves the array of structure annotation</span>
<span class="sd">            used in a 3D representation of the brain.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_data&quot;</span><span class="p">,</span> <span class="s2">&quot;_atlas&quot;</span><span class="p">,</span> <span class="s2">&quot;_scRNAseq&quot;</span><span class="p">,</span> <span class="s2">&quot;_storage&quot;</span><span class="p">,</span> <span class="s2">&quot;dic_normalization_factors&quot;</span><span class="p">]</span>

    <span class="c1"># ==============================================================================================</span>
    <span class="c1"># --- Constructor</span>
    <span class="c1"># ==============================================================================================</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maldi_data</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">scRNAseq</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Figures class.</span>

<span class="sd">        Args:</span>
<span class="sd">            maldi_data (MaldiData): MaldiData object, used to manipulate the raw MALDI data.</span>
<span class="sd">            storage (Storage): Used to access the shelve database.</span>
<span class="sd">            atlas (Atlas): Used to manipulate the objects coming from the Allen Brain Atlas.</span>
<span class="sd">            scRNAseq (ScRNAseq): Used to manipulate the objects coming from the scRNAseq dataset.</span>
<span class="sd">            sample (bool, optional): If True, only a fraction of the precomputations are made (for</span>
<span class="sd">                debug). Default to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Figures object&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># Attribute to easily access the maldi and allen brain atlas data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">maldi_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span> <span class="o">=</span> <span class="n">atlas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span> <span class="o">=</span> <span class="n">scRNAseq</span>

        <span class="c1"># attribute to access the shelve database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="n">storage</span>

        <span class="c1"># Dic of normalization factors across slices for MAIA normalized lipids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dic_normalization_factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/lipid_selection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dic_normalization_factors&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_normalization_factor_across_slices</span><span class="p">,</span>
            <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No cache since launched at startup</span>
        <span class="p">)</span>

        <span class="c1"># Check that treemaps has been computed already. If not, compute it and store it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/atlas_page/3D&quot;</span><span class="p">,</span> <span class="s2">&quot;treemaps&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/atlas_page/3D&quot;</span><span class="p">,</span>
                <span class="s2">&quot;treemaps&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_treemaps_figure</span><span class="p">,</span>
            <span class="p">),</span>

        <span class="c1"># Check that 3D slice figures have been computed already. If not, compute it and store it.</span>
        <span class="k">for</span> <span class="n">brain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;brain_1&quot;</span><span class="p">,</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;slices_3D_&quot;</span> <span class="o">+</span> <span class="n">brain</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                    <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;slices_3D&quot;</span><span class="p">,</span>
                    <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_figure_slices_3D</span><span class="p">,</span>
                    <span class="n">brain</span><span class="o">=</span><span class="n">brain</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Check that the 3D root volume figure has been computed already. If not, compute it and</span>
        <span class="c1"># store it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span> <span class="s2">&quot;scatter3D&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scatter3D&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_scatter_3D</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Check that the 3D scatter plot for scRNAseq data has been computed already. If not,</span>
        <span class="c1"># compute it and store it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_root&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume_root&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_3D_root_volume</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Check that the base figures for lipid/genes heatmap have been computed already. If not,</span>
        <span class="c1"># compute them and store them.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span> <span class="s2">&quot;base_heatmap_lipid_True&quot;</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span> <span class="s2">&quot;base_heatmap_lipid_False&quot;</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;base_heatmap_lipid&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_heatmap_lipid_genes</span><span class="p">,</span>
                <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;base_heatmap_lipid&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_heatmap_lipid_genes</span><span class="p">,</span>
                <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>

        <span class="c1"># Check that all basic figures in the load_slice page are present, if not, compute them</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_basic_figures_computed&quot;</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelve_arrays_basic_figures</span><span class="p">()</span>

        <span class="c1"># Check that the lipid distributions for all slices, and both brains, have been computed, if</span>
        <span class="c1"># not, compute them</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_expression_True_computed&quot;</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelve_all_l_array_2D</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_expression_False_computed&quot;</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelve_all_l_array_2D</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Check that all arrays of annotations have been computed, if not, compute them</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_annotation_computed&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelve_all_arrays_annotation</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Figures object instantiated&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># ==============================================================================================</span>
    <span class="c1"># --- Methods used mainly in load_slice</span>
    <span class="c1"># ==============================================================================================</span>

    <span class="k">def</span> <span class="nf">compute_array_basic_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_figure</span><span class="o">=</span><span class="s2">&quot;warped_data&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function computes and returns a three-dimensional array representing all slices from</span>
<span class="sd">        the maldi_data acquisition (TIC) or the corresponding image from the atlas. No spectral data</span>
<span class="sd">        is read in the process, as the arrays corresponding to the images are directly stored as</span>
<span class="sd">        tiff files in the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            type_figure (str, optional): To be chosen among &quot;original_data&quot;, &quot;warped_data&quot;,</span>
<span class="sd">                &quot;projection_corrected&quot;, &quot;atlas&quot;. Depending on the chosen type, the final array will</span>
<span class="sd">                correspond to either the original images (&quot;original_data&quot;), the warped and upscaled</span>
<span class="sd">                images (&quot;warped_data&quot;), the warped and upscaled images, whose pixels outside of</span>
<span class="sd">                annotations regions have been zero-ed out (&quot;projection_corrected&quot;), or the images</span>
<span class="sd">                from the Allen Brain atlas projected onto the same plane as the corresponding slice</span>
<span class="sd">                from the MALDI data (&quot;atlas&quot;). Default to &quot;warped_data&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray): A three-dimensional array representing all slices from the maldi_data</span>
<span class="sd">                acquisition (TIC) or the corresponding image from the atlas. The first dimension</span>
<span class="sd">                corresponds to the slices, the second and third to the images themselves.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check for all array types</span>
        <span class="k">if</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;original_data&quot;</span><span class="p">:</span>
            <span class="n">array_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">compute_padded_original_images</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;warped_data&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_sample_data</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;data_sample/tiff_files/warped_data.npz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">array_images</span> <span class="o">=</span> <span class="n">handle</span><span class="p">[</span><span class="s2">&quot;array_warped_data&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">array_images</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;data/tiff_files/warped_data.tif&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;projection_corrected&quot;</span><span class="p">:</span>
            <span class="n">array_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_corrected</span>
        <span class="k">elif</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;atlas&quot;</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">array_projected_images_atlas</span><span class="p">,</span>
                <span class="n">array_projected_simplified_id</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;atlas/atlas_objects&quot;</span><span class="p">,</span>
                <span class="s2">&quot;array_images_atlas&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">prepare_and_compute_array_images_atlas</span><span class="p">,</span>
                <span class="n">zero_out_of_annotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">array_images</span> <span class="o">=</span> <span class="n">array_projected_images_atlas</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The type of requested array &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">type_figure</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># If the array is not uint8, convert it to gain space</span>
        <span class="k">if</span> <span class="n">array_images</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
            <span class="n">array_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_images</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array_images</span>

    <span class="k">def</span> <span class="nf">compute_figure_basic_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">type_figure</span><span class="p">,</span> <span class="n">index_image</span><span class="p">,</span> <span class="n">plot_atlas_contours</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_contours</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function computes and returns a figure representing slices from the maldi_data</span>
<span class="sd">        acquisition (TIC) or the corresponding image from the atlas. The data is read directly from</span>
<span class="sd">        the array computed in self.compute_array_basic_images().</span>

<span class="sd">        Args:</span>
<span class="sd">            type_figure (str): To be chosen among &quot;original_data&quot;, &quot;warped_data&quot;,</span>
<span class="sd">                &quot;projection_corrected&quot;, &quot;atlas&quot;. Depending on the chosen type, the final figure will</span>
<span class="sd">                correspond to either the original images (&quot;original_data&quot;), the warped and upscaled</span>
<span class="sd">                images (&quot;warped_data&quot;), the warped and upscaled images, whose pixels outside of</span>
<span class="sd">                annotations regions have been zero-ed out (&quot;projection_corrected&quot;), or the images</span>
<span class="sd">                from the Allen Brain atlas projected onto the same plane as the corresponding slice</span>
<span class="sd">                from the MALDI data (&quot;atlas&quot;).</span>
<span class="sd">            index_image (int): Index of the requested slice image.</span>
<span class="sd">            plot_atlas_contours (bool, optional): If True, the atlas contours annotation is</span>
<span class="sd">                superimposed with the slice image. Defaults to True.</span>
<span class="sd">            only_contours (bool, optional): If True, only output the atlas contours annotation. All</span>
<span class="sd">                the other arugments but plot_atlas_contours (which must be True) get ignored.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            draw (bool, optional): If True, the figure can be drawed on (used for region selection,</span>
<span class="sd">                in page region_analysis). Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (go.Figure): A Plotly figure representing the requested slice image of the requested</span>
<span class="sd">                type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If only boundaries is requested, force the computation of atlas contours</span>
        <span class="k">if</span> <span class="n">only_contours</span><span class="p">:</span>
            <span class="n">plot_atlas_contours</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get array of images</span>
            <span class="n">array_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;array_basic_images&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_array_basic_images</span><span class="p">,</span>
                <span class="n">type_figure</span><span class="o">=</span><span class="n">type_figure</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Get image at specified index</span>
            <span class="n">array_image</span> <span class="o">=</span> <span class="n">array_images</span><span class="p">[</span><span class="n">index_image</span><span class="p">]</span>

        <span class="c1"># Add the contours if requested</span>
        <span class="k">if</span> <span class="n">plot_atlas_contours</span><span class="p">:</span>
            <span class="n">array_image_atlas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">list_projected_atlas_borders_arrays</span><span class="p">[</span><span class="n">index_image</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">array_image_atlas</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="c1"># Compute image from our data if not only the atlas annotations are requested</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_contours</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                    <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">convert_image_to_base64</span><span class="p">(</span>
                        <span class="n">array_image</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="n">array_image_atlas</span><span class="p">,</span> <span class="n">transparent_zeros</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">),</span>
                    <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Add the labels only if it&#39;s not a simple annotation illustration</span>
            <span class="c1"># fig.update_xaxes(</span>
            <span class="c1">#     title_text=self._atlas.bg_atlas.space.axis_labels[0][1], title_standoff=0</span>
            <span class="c1"># )</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                    <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">convert_image_to_base64</span><span class="p">(</span>
                        <span class="n">array_image_atlas</span><span class="p">,</span>
                        <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span>
                        <span class="n">decrease_resolution_factor</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Improve layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
            <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">dragmode</span><span class="o">=</span><span class="s2">&quot;drawclosedpath&quot;</span><span class="p">,</span>
                <span class="n">newshape</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="n">l_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_figure_slices_3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reduce_resolution_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">brain</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function computes and returns a figure representing the slices from the maldi data</span>
<span class="sd">        in 3D.</span>

<span class="sd">        Args:</span>
<span class="sd">            reduce_resolution_factor (int, optional): Divides (reduce) the initial resolution of the</span>
<span class="sd">                data. Needed as the resulting figure can be very heavy. Defaults to 20.</span>
<span class="sd">            brain (str, optional): Name of the brain to be used. Defaults to &#39;brain_1&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (go.Figure): A Plotly figure representing the slices from the MALDI acquisitions in 3D.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get transform parameters (a,u,v) for each slice</span>
        <span class="n">l_transform_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;atlas/atlas_objects&quot;</span><span class="p">,</span>
            <span class="s2">&quot;l_transform_parameters&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">compute_projection_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Reduce resolution of the slices</span>
        <span class="n">new_dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">original_length</span><span class="p">,</span> <span class="n">new_length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_corrected</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">n_slices</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">d1</span> <span class="o">/</span> <span class="n">reduce_resolution_factor</span><span class="p">)),</span>
                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">d2</span> <span class="o">/</span> <span class="n">reduce_resolution_factor</span><span class="p">)),</span>
            <span class="p">),</span>
        <span class="p">):</span>
            <span class="n">new_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">original_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_length</span><span class="p">))</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">new_dims</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
        <span class="n">array_projection_small</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_corrected</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>

        <span class="c1"># Build Figure, with several frames as it will be slidable</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
            <span class="n">frames</span><span class="o">=</span><span class="p">[</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_surface</span><span class="p">(</span>
                        <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">l_transform_parameters</span><span class="p">,</span>
                        <span class="n">array_projection_small</span><span class="p">,</span>
                        <span class="n">reduce_resolution_factor</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">brain</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_surface</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">brain</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">l_transform_parameters</span><span class="p">,</span>
                <span class="n">array_projection_small</span><span class="p">,</span>
                <span class="n">reduce_resolution_factor</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add a slider</span>
        <span class="k">def</span> <span class="nf">frame_args</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">},</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;immediate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fromcurrent&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;transition&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span> <span class="s2">&quot;easing&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">},</span>
            <span class="p">}</span>

        <span class="n">sliders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">frame_args</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;animate&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="s2">&quot;currentvalue&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="c1"># Layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">aspectratio</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>
                    <span class="n">autorange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                    <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">],</span>
                    <span class="n">autorange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                    <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>
                    <span class="n">autorange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                    <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
            <span class="n">sliders</span><span class="o">=</span><span class="n">sliders</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># No display of tick labels as they&#39;re wrong anyway</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="c1"># Part of this function could probably be compiled with numba with some effort, but there&#39;s no</span>
    <span class="c1"># need as it&#39;s precomupted in a reasonable time anyway.</span>
    <span class="k">def</span> <span class="nf">get_surface</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="n">l_transform_parameters</span><span class="p">,</span> <span class="n">array_projection</span><span class="p">,</span> <span class="n">reduce_resolution_factor</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns a Plotly Surface representing the requested slice in 3D.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): Index of the requested slice.</span>
<span class="sd">            l_transform_parameters (list(np.ndarray)): A list of tuples containing the parameters</span>
<span class="sd">                for the transformation of the slice coordinates from 2D to 3D and conversely.</span>
<span class="sd">            array_projection (np.ndarray): The coordinates of the requested slice in 2D.</span>
<span class="sd">            reduce_resolution_factor (int, optional): Divides (reduce) the initial resolution of the</span>
<span class="sd">                data. Needed as the resulting figure can be very heavy. Defaults to 20.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (go.Surface): A Plotly Surface representing the requested slice in 3D.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#  Get the parameters for the transformation of the coordinats from 2D to 3D</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">l_transform_parameters</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span>

        <span class="c1"># Build 3 empty lists, which will contain the 3D coordinates of the requested slice</span>
        <span class="n">ll_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ll_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ll_z</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over the first 2D coordinate of the slice</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">l_x</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">l_y</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">l_z</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Loop over the second 2D coordinate of the slice</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="c1"># Get rescaled 3D coordinates</span>
                <span class="n">x_atlas</span><span class="p">,</span> <span class="n">y_atlas</span><span class="p">,</span> <span class="n">z_atlas</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="n">slice_to_atlas_transform</span><span class="p">(</span>
                            <span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">reduce_resolution_factor</span><span class="p">,</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">reduce_resolution_factor</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span>
                    <span class="o">/</span> <span class="mi">1000</span>
                <span class="p">)</span>
                <span class="n">l_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_atlas</span><span class="p">)</span>
                <span class="n">l_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_atlas</span><span class="p">)</span>
                <span class="n">l_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_atlas</span><span class="p">)</span>

            <span class="c1"># In case the 3D coordinate was not acquired, skip the current coordinate</span>
            <span class="k">if</span> <span class="n">l_x</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">ll_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_x</span><span class="p">)</span>
                <span class="n">ll_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_y</span><span class="p">)</span>
                <span class="n">ll_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_z</span><span class="p">)</span>

        <span class="c1"># Build a 3D surface from the 3D coordinates for the current slice</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ll_z</span><span class="p">),</span>
            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ll_x</span><span class="p">),</span>
            <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ll_y</span><span class="p">),</span>
            <span class="n">surfacecolor</span><span class="o">=</span><span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">cmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
            <span class="n">opacityscale</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">surface</span>

    <span class="c1"># ==============================================================================================</span>
    <span class="c1"># --- Methods used mainly in lipid_selection</span>
    <span class="c1"># ==============================================================================================</span>

    <span class="k">def</span> <span class="nf">compute_image_per_lipid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">lb_mz</span><span class="p">,</span>
        <span class="n">hb_mz</span><span class="p">,</span>
        <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lipid_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function allows to query the MALDI data to extract an image in the form of a Numpy</span>
<span class="sd">        array representing the intensity of the lipid peaking between the values lb_mz and hb_mz in</span>
<span class="sd">        the spectral data, for the slice slice_index.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): Index of the requested slice.</span>
<span class="sd">            lb_mz (float): Lower boundary for the spectral data to query.</span>
<span class="sd">            hb_mz (float): Higher boundary for the spectral data to query.</span>
<span class="sd">            RGB_format (bool, optional): If True, the values in the array are between 0 and 255,</span>
<span class="sd">                given that the data has been normalized beforehand. Else, between 0 and 1. This</span>
<span class="sd">                parameter only makes sense if the data has been normalized beforehand. Defaults to</span>
<span class="sd">                True.</span>
<span class="sd">            normalize (bool, optional): If True, and the lipid has been MAIA transformed (and is</span>
<span class="sd">                provided with the parameter lipid_name) and apply_transform is True, the resulting</span>
<span class="sd">                array is normalized according to a factor computed across all slice. If MAIA has not</span>
<span class="sd">                been applied to the current selection or apply_transform is False, it is normalized</span>
<span class="sd">                according to the 99th percentile. Else, it is not normalized. Defaults to True.</span>
<span class="sd">            log (bool, optional): If True, the resulting array is log-transformed. This is useful in</span>
<span class="sd">                case of low expression. Defaults to False.</span>
<span class="sd">            projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">                matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">                most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">                information). Defaults to True.</span>
<span class="sd">            apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">                the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">                lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">            lipid_name (str, optional): Name of the lipid that must be MAIA-transformed, if</span>
<span class="sd">                apply_transform and normalize are True. Defaults to &quot;&quot;.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray): An image (in the form of a numpy array) representing the intensity of the</span>
<span class="sd">                lipid peaking between the values lb_mz and hb_mz in the spectral data, for the slice</span>
<span class="sd">                slice_index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering compute_image_per_lipid&quot;</span><span class="p">)</span>

        <span class="c1"># Get image from raw mass spec data</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
            <span class="n">compute_image_using_index_and_image_lookup</span><span class="p">,</span>
            <span class="n">cache_flask</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
            <span class="n">slice_index</span><span class="p">,</span>
            <span class="n">lb_mz</span><span class="p">,</span>
            <span class="n">hb_mz</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_spectra</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_pixels</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_mz</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_cumulated_lookup_mz_image</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_divider_lookup</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_peaks_transformed_lipids</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_corrective_factors</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Log-transform the image if requested</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># In case of bug, return None</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Normalize the image if requested</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="c1"># Normalize across slice if the lipid has been MAIA transformed</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">lipid_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">is_brain_1</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_normalization_factors</span> <span class="ow">and</span> <span class="n">apply_transform</span><span class="p">:</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_normalization_factors</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">lipid_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">is_brain_1</span><span class="p">(</span><span class="n">slice_index</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Normalization made with respect to percentile computed across all slices.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Normalize by 99 percentile</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">99.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">perc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">perc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">perc</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

        <span class="c1"># Turn to RGB format if requested</span>
        <span class="k">if</span> <span class="n">RGB_format</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">*=</span> <span class="mi">255</span>

        <span class="c1"># Change dtype if normalized and RGB to save space</span>
        <span class="k">if</span> <span class="n">normalize</span> <span class="ow">and</span> <span class="n">RGB_format</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Project image into cleaned and higher resolution version</span>
        <span class="k">if</span> <span class="n">projected_image</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">project_image</span><span class="p">(</span>
                <span class="n">slice_index</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_correspondence_corrected</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="k">def</span> <span class="nf">compute_normalization_factor_across_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function computes a dictionnary of normalization factors (used for MAIA-transformed</span>
<span class="sd">        lipids) across all slices (99th percentile of expression).</span>

<span class="sd">        Args:</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (dict): A dictionnary associating, for each MAIA-transformed lipid name, the 99th</span>
<span class="sd">                percentile of the intensity across all slices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Compute normalization factor across slices for MAIA transformed lipids...&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; It may takes a while&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Dictionnnary that will contain the percentile across all slices of a given brain</span>
        <span class="n">dic_max_percentile</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Function to compute the percentile across all slices</span>
        <span class="k">def</span> <span class="nf">_compute_percentile_across_slices</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">brain_1</span><span class="p">):</span>
            <span class="n">max_perc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lipid_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span>
                <span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span>
            <span class="p">):</span>
                <span class="c1"># Find lipid location</span>
                <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">index</span><span class="p">[</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">structure</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slice_index</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;cation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cation</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="c1"># If several lipids correspond to the selection, we have a problem...</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">l_lipid_loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># get final lipid name</span>
                    <span class="n">lipid_string</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">structure</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">cation</span>

                    <span class="c1"># get lipid bounds</span>
                    <span class="n">lb_mz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">])</span>
                    <span class="n">hb_mz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">])</span>

                    <span class="c1"># Get corresponding image</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
                        <span class="n">compute_image_using_index_and_image_lookup</span><span class="p">,</span>
                        <span class="n">cache_flask</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                        <span class="n">slice_index</span><span class="p">,</span>
                        <span class="n">lb_mz</span><span class="p">,</span>
                        <span class="n">hb_mz</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_spectra</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_pixels</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_mz</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_cumulated_lookup_mz_image</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_divider_lookup</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_peaks_transformed_lipids</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_corrective_factors</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                        <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Check 99th percentile for normalization</span>
                    <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">99.0</span><span class="p">)</span>

                    <span class="c1"># perc must be quite small in theory... otherwise it&#39;s a bug</span>
                    <span class="k">if</span> <span class="n">perc</span> <span class="o">&gt;</span> <span class="n">max_perc</span><span class="p">:</span>  <span class="c1"># and perc&lt;1:</span>
                        <span class="n">max_perc</span> <span class="o">=</span> <span class="n">perc</span>
            <span class="k">return</span> <span class="n">max_perc</span><span class="p">,</span> <span class="n">lipid_string</span>

        <span class="c1"># Simulate a click on all MAIA transformed lipids</span>
        <span class="k">for</span> <span class="n">brain_1</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">index</span><span class="p">,</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">mz</span><span class="p">),</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations_MAIA_transformed_lipids</span><span class="p">(</span><span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">max_perc</span><span class="p">,</span> <span class="n">lipid_string</span> <span class="o">=</span> <span class="n">_compute_percentile_across_slices</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">brain_1</span>
                <span class="p">)</span>
                <span class="c1"># Store max percentile across slices</span>
                <span class="n">dic_max_percentile</span><span class="p">[(</span><span class="n">lipid_string</span><span class="p">,</span> <span class="n">brain_1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">max_perc</span>

        <span class="k">return</span> <span class="n">dic_max_percentile</span>

    <span class="k">def</span> <span class="nf">build_lipid_heatmap_from_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">type_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">return_go_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function converts a numpy array into a base64 string, which can be returned</span>
<span class="sd">        directly, or itself be turned into a go.Image, which can be returned directly, or be</span>
<span class="sd">        turned into a Plotly Figure, which will be returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (np.ndarray): A numpy array representing the image to be converted. Possibly with</span>
<span class="sd">                several channels.</span>
<span class="sd">            return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">                returned directly, before any figure building. Defaults to False.</span>
<span class="sd">            draw (bool, optional): If True, the user will have the possibility to draw on the</span>
<span class="sd">                resulting Plotly Figure. Defaults to False.</span>
<span class="sd">            type_image (string, optional): The type of the image to be converted to a base64 string.</span>
<span class="sd">                If image_array is in 3D, type must be RGB. If 4D, type must be RGBA. Else, no</span>
<span class="sd">                requirement (None). Defaults to None.</span>
<span class="sd">            return_go_image (bool, optional): If True, the go.Image is returned directly, before</span>
<span class="sd">                being integrated to a Plotly Figure. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Depending on the inputted arguments, may either return a base64 string, a go.Image, or</span>
<span class="sd">                a Plotly Figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting image to string&quot;</span><span class="p">)</span>

        <span class="c1"># Set optimize to False to gain computation time</span>
        <span class="n">base64_string</span> <span class="o">=</span> <span class="n">convert_image_to_base64</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">type_image</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transparent_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Either return image directly</span>
        <span class="k">if</span> <span class="n">return_base64_string</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base64_string</span>

        <span class="c1"># Or compute heatmap as go image if needed</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting image to go image&quot;</span><span class="p">)</span>
        <span class="n">final_image</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">base64_string</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Potentially return the go image directly</span>
        <span class="k">if</span> <span class="n">return_go_image</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">final_image</span>

        <span class="c1"># Or build ploty graph</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>

        <span class="c1"># Improve graph layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">newshape</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">fillcolor</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="c1"># Do not specify height for now as plotly is buggued and resets if switching pages</span>
            <span class="c1"># height=500,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">layout_coloraxis_showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Set how the image should be annotated</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">dragmode</span><span class="o">=</span><span class="s2">&quot;drawclosedpath&quot;</span><span class="p">)</span>

        <span class="c1"># Set background color to zero</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning figure&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_heatmap_per_mz</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">lb_mz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hb_mz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function takes two boundaries and a slice index, and returns a heatmap of the lipid</span>
<span class="sd">        expressed in the slice whose m/z is between the two boundaries.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): The index of the requested slice.</span>
<span class="sd">            lb_mz (float, optional): The lower m/z boundary. Defaults to None.</span>
<span class="sd">            hb_mz (float, optional): The higher m/z boundary. Defaults to None.</span>
<span class="sd">            draw (bool, optional): If True, the user will have the possibility to draw on the</span>
<span class="sd">                resulting Plotly Figure. Defaults to False.</span>
<span class="sd">            projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">                matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">                most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">                information). Defaults to True.</span>
<span class="sd">            return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">                returned directly, before any figure building. Defaults to False.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Depending on the value return_base64_string, may either return a base64 string, or</span>
<span class="sd">                a Plotly Figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting figure computation, from mz boundaries&quot;</span><span class="p">)</span>

        <span class="c1"># Upper bound lower than the lowest m/z value and higher that the highest m/z value</span>
        <span class="k">if</span> <span class="n">lb_mz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lb_mz</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="k">if</span> <span class="n">hb_mz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hb_mz</span> <span class="o">=</span> <span class="mi">1800</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting image array&quot;</span><span class="p">)</span>

        <span class="c1"># Compute image with given bounds</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_image_per_lipid</span><span class="p">(</span>
            <span class="n">slice_index</span><span class="p">,</span>
            <span class="n">lb_mz</span><span class="p">,</span>
            <span class="n">hb_mz</span><span class="p">,</span>
            <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
            <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Compute corresponding figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lipid_heatmap_from_image</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="n">return_base64_string</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_heatmap_per_lipid_selection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">ll_t_bounds</span><span class="p">,</span>
        <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is very similar to compute_heatmap_per_mz, but it takes a list of lipid</span>
<span class="sd">        boundaries, possibly along with lipid names, instead of just two boundaries. It returns a</span>
<span class="sd">        heatmap of the sum of expression of the requested lipids in the slice.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): The index of the requested slice.</span>
<span class="sd">            ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">                list is used to separate image channels (although this is not used in the function).</span>
<span class="sd">                The second list is used to separate lipid.</span>
<span class="sd">            normalize (bool, optional): If True, and the lipid has been MAIA transformed (and is</span>
<span class="sd">                provided with the parameter lipid_name) and apply_transform is True, the resulting</span>
<span class="sd">                array is normalized according to a factor computed across all slice. If MAIA has not</span>
<span class="sd">                been applied to the current selection or apply_transform is False, it is normalized</span>
<span class="sd">                according to the 99th percentile. Else, it is not normalized. Defaults to True.</span>
<span class="sd">            projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">                matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">                most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">                information). Defaults to True.</span>
<span class="sd">            apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">                the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">                lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">            ll_lipid_names (list(list(int)), optional): List of list of lipid names that must be</span>
<span class="sd">                MAIA-transformed, if apply_transform and normalize are True. The first list is used</span>
<span class="sd">                to separate channels, when applicable. Defaults to None.</span>
<span class="sd">            return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">                returned directly, before any figure building. Defaults to False.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Depending on the value return_base64_string, may either return a base64 string, or</span>
<span class="sd">                a Plotly Figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute heatmap per lipid selection&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">))</span>

        <span class="c1"># Start from empty image and add selected lipids</span>
        <span class="c1"># * Caution: array must be int, float gets badly converted afterwards</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># Build empty lipid names if not provided</span>
        <span class="k">if</span> <span class="n">ll_lipid_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ll_lipid_names</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">l_t_bounds</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span><span class="p">]</span>

        <span class="c1"># Loop over channels</span>
        <span class="k">for</span> <span class="n">l_t_bounds</span><span class="p">,</span> <span class="n">l_lipid_names</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">ll_lipid_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l_t_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Loop over lipids</span>
                <span class="k">for</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">lipid_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_t_bounds</span><span class="p">,</span> <span class="n">l_lipid_names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">lb_mz</span><span class="p">,</span> <span class="n">hb_mz</span><span class="p">)</span> <span class="o">=</span> <span class="n">boundaries</span>

                        <span class="c1"># Cmpute expression image per lipid</span>
                        <span class="n">image_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_image_per_lipid</span><span class="p">(</span>
                            <span class="n">slice_index</span><span class="p">,</span>
                            <span class="n">lb_mz</span><span class="p">,</span>
                            <span class="n">hb_mz</span><span class="p">,</span>
                            <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
                            <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
                            <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
                            <span class="n">lipid_name</span><span class="o">=</span><span class="n">lipid_name</span><span class="p">,</span>
                            <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">image</span> <span class="o">+=</span> <span class="n">image_temp</span>

        <span class="c1"># Compute corresponding figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lipid_heatmap_from_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="n">return_base64_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_rgb_array_per_lipid_selection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">ll_t_bounds</span><span class="p">,</span>
        <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function computes a numpy RGB array (each pixel has 3 intensity values) of</span>
<span class="sd">        expression of the requested lipids (those whose m/z values are in ll_t_bounds) in the slice.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): The index of the requested slice.</span>
<span class="sd">            ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">                list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">            normalize_independently (bool, optional): If True, each lipid intensity array is</span>
<span class="sd">                normalized independently, regardless of other lipids or channel used. Defaults to</span>
<span class="sd">                True.</span>
<span class="sd">            projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">                matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">                most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">                information). Defaults to True.</span>
<span class="sd">            log (bool, optional): If True, the resulting array corresponds to log-transformed</span>
<span class="sd">                expression, for each lipid. Defaults to False.</span>
<span class="sd">            apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">                the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">                lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">            ll_lipid_names (list(list(int)), optional): List of list of lipid names that must be</span>
<span class="sd">                MAIA-transformed, if apply_transform and normalize are True. The first list is used</span>
<span class="sd">                to separate channels, when applicable. Defaults to None.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray): A three-dimensional RGB numpy array (of uint8 dtype). The first two</span>
<span class="sd">                dimensions correspond to the acquisition image shape, and the third dimension</span>
<span class="sd">                corresponds to the channels.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Empty lipid names if no names provided</span>
        <span class="k">if</span> <span class="n">ll_lipid_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ll_lipid_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">l_t_bounds</span><span class="p">]</span> <span class="k">if</span> <span class="n">l_t_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span>
            <span class="p">]</span>

        <span class="c1"># Build a list of empty images and add selected lipids for each channel</span>
        <span class="n">l_images</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over channels</span>
        <span class="k">for</span> <span class="n">l_boundaries</span><span class="p">,</span> <span class="n">l_names</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">ll_lipid_names</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">image_shape</span>
                <span class="k">if</span> <span class="n">projected_image</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">l_boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Loop over lipids</span>
                <span class="k">for</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">lipid_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_boundaries</span><span class="p">,</span> <span class="n">l_names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">lb_mz</span><span class="p">,</span> <span class="n">hb_mz</span><span class="p">)</span> <span class="o">=</span> <span class="n">boundaries</span>

                        <span class="c1"># Cmpute expression image per lipid</span>
                        <span class="n">image_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_image_per_lipid</span><span class="p">(</span>
                            <span class="n">slice_index</span><span class="p">,</span>
                            <span class="n">lb_mz</span><span class="p">,</span>
                            <span class="n">hb_mz</span><span class="p">,</span>
                            <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">normalize</span><span class="o">=</span><span class="n">normalize_independently</span><span class="p">,</span>
                            <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
                            <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
                            <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
                            <span class="n">lipid_name</span><span class="o">=</span><span class="n">lipid_name</span><span class="p">,</span>
                            <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">image_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">image</span> <span class="o">+=</span> <span class="n">image_temp</span>

            <span class="n">l_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Reoder axis to match plotly go.image requirements</span>
        <span class="n">array_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_images</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">array_image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_rgb_image_per_lipid_selection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">ll_t_bounds</span><span class="p">,</span>
        <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is very similar to compute_heatmap_per_lipid_selection, but it returns a</span>
<span class="sd">        RGB image instead of a heatmap.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): The index of the requested slice.</span>
<span class="sd">            ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">                list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">            normalize_independently (bool, optional): If True, each lipid intensity array is</span>
<span class="sd">                normalized independently, regardless of other lipids or channel used. Defaults to</span>
<span class="sd">                True.</span>
<span class="sd">            projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">                matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">                most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">                information). Defaults to True.</span>
<span class="sd">            log (bool, optional): If True, the resulting array corresponds to log-transformed</span>
<span class="sd">                expression, for each lipid. Defaults to False.</span>
<span class="sd">            return_image (bool, optional): If True, a go.Image is returned directly, instead of a</span>
<span class="sd">                Plotly Figure. Defaults to False.</span>
<span class="sd">            apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">                the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">                lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">            ll_lipid_names (list(list(int)), optional): List of list of lipid names that must be</span>
<span class="sd">                MAIA-transformed, if apply_transform and normalize are True. The first list is used</span>
<span class="sd">                to separate channels, when applicable. Defaults to None.</span>
<span class="sd">            return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">                returned directly, before any figure building. Defaults to False.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Depending on the inputted arguments, may either return a base64 string, a go.Image, or</span>
<span class="sd">                a Plotly Figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started RGB image computation for slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># Empty lipid names if no names provided</span>
        <span class="k">if</span> <span class="n">ll_lipid_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ll_lipid_names</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">l_t_bounds</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span><span class="p">]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Acquiring array_image for slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># Get RGB array for the current lipid selection</span>
        <span class="n">array_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rgb_array_per_lipid_selection</span><span class="p">(</span>
            <span class="n">slice_index</span><span class="p">,</span>
            <span class="n">ll_t_bounds</span><span class="p">,</span>
            <span class="n">normalize_independently</span><span class="o">=</span><span class="n">normalize_independently</span><span class="p">,</span>
            <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
            <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
            <span class="n">ll_lipid_names</span><span class="o">=</span><span class="n">ll_lipid_names</span><span class="p">,</span>
            <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning fig for slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># Build the correspondig figure</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lipid_heatmap_from_image</span><span class="p">(</span>
            <span class="n">array_image</span><span class="p">,</span>
            <span class="n">return_base64_string</span><span class="o">=</span><span class="n">return_base64_string</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">type_image</span><span class="o">=</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
            <span class="n">return_go_image</span><span class="o">=</span><span class="n">return_image</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_spectrum_low_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns the full (low-resolution) spectrum of the requested slice.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): The slice index of the requested slice.</span>
<span class="sd">            annotations (list(tuple), optional): A list of m/z boundaries (one for each lipid to</span>
<span class="sd">                annotate), corresponding to the position of colored box superimposed on the spectra.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (go.Figure): A Plotly Figure representing the low-resolution spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define figure data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum_downsampled</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum_downsampled</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">line_color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">],</span>
            <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tozeroy&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Define figure layout</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">rangeslider</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fixedrange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
            <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Low resolution spectrum (averaged across pixels)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span>
                <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Build figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

        <span class="c1"># Annotate selected lipids with vertical bars</span>
        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">annot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">annotations</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">annot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_vrect</span><span class="p">(</span>
                        <span class="n">x0</span><span class="o">=</span><span class="n">annot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">x1</span><span class="o">=</span><span class="n">annot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">fillcolor</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="n">color</span><span class="p">],</span>
                        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                        <span class="n">line_color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="n">color</span><span class="p">],</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_spectrum_high_res</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">lb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_xlim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">standardization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns the high-resolution spectrum of the requested slice between the two</span>
<span class="sd">        provided m/z boundaries lb and hb. If boundaries are not provided, it returns an empty</span>
<span class="sd">        spectrum.</span>

<span class="sd">        Args:</span>
<span class="sd">            slice_index (int): The slice index of the requested slice.</span>
<span class="sd">            lb (float, optional): The lower m/z boundary below which the spectrum to display must</span>
<span class="sd">                be cropped. Defaults to None.</span>
<span class="sd">            hb (float, optional): The higher m/z boundary below which the spectrum to display must</span>
<span class="sd">                be cropped. Defaults to None.</span>
<span class="sd">            annotations (list(tuple), optional): A list of m/z boundaries (one for each lipid to</span>
<span class="sd">                annotate), corresponding to the position of colored box superimposed on the spectra.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            force_xlim (bool, optional): If Truen the zoom level will be set to enclose lb and hb,</span>
<span class="sd">                although that may not be the tightest region to enclose the data. Defaults to False.</span>
<span class="sd">            plot (bool, optional): If False, only the plotting data (m/z and intensities arrays)</span>
<span class="sd">                will be returned. Defaults to True.</span>
<span class="sd">            standardization (bool, optional): If True, the displayed spectrum is standardized with</span>
<span class="sd">                MAIA when possible.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Depending on the value of the boundaries, and the plot parameter, it may return a Plotly</span>
<span class="sd">                Figure containing an empty spectrum, or a spectrum between the two</span>
<span class="sd">                provided boundaries, or the corresponding data of such a spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define default values for graph (empty)</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">([],)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">([],)</span>

        <span class="c1"># If boundaries are provided, get their index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_lb</span><span class="p">,</span> <span class="n">index_hb</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
                <span class="n">compute_index_boundaries</span><span class="p">,</span>
                <span class="n">cache_flask</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                <span class="n">slice_index</span><span class="p">,</span>
                <span class="n">lb</span><span class="p">,</span>
                <span class="n">hb</span><span class="p">,</span>
                <span class="n">array_spectra_avg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum</span><span class="p">(</span>
                    <span class="n">slice_index</span><span class="p">,</span> <span class="n">standardization</span><span class="o">=</span><span class="n">standardization</span>
                <span class="p">),</span>
                <span class="n">lookup_table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_mz_avg</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">return_x_y</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_lb</span><span class="p">:</span><span class="n">index_hb</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">index_lb</span><span class="p">:</span><span class="n">index_hb</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

            <span class="c1"># Get x, y in a thread safe fashion</span>
            <span class="c1"># No need to clean memory as it&#39;s really small</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
                <span class="n">return_x_y</span><span class="p">,</span>
                <span class="n">cache_flask</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                <span class="n">slice_index</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">standardization</span><span class="o">=</span><span class="n">standardization</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># In case download without plotting</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

        <span class="c1"># Define figure data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tozeroy&quot;</span><span class="p">)</span>

        <span class="c1"># Define figure layout</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">rangeslider</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fixedrange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;High resolution spectrum (averaged across pixels)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span>
                <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Build figure layout</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

        <span class="c1"># Annotate selected lipids with vertical bars</span>
        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">annotations</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lb</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hb</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_vrect</span><span class="p">(</span>
                            <span class="n">x0</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x1</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="n">color</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span>
                        <span class="p">)</span>

        <span class="c1"># In case we don&#39;t want to zoom in too much on the selected lipid</span>
        <span class="k">if</span> <span class="n">force_xlim</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">lb</span><span class="p">,</span> <span class="n">hb</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">return_empty_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns an empty spectrum, used to display when no spectrum is available.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Plotly Figure): A Plotly Figure representing an empty spectrum.&quot;&quot;&quot;</span>

        <span class="c1"># Define empty figure data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[],</span> <span class="n">y</span><span class="o">=</span><span class="p">[],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>

        <span class="c1"># Define figure layout</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Build figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

        <span class="c1"># Transparent background</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="c1"># ==============================================================================================</span>
    <span class="c1"># --- Methods used mainly in region_analysis</span>
    <span class="c1"># ==============================================================================================</span>

    <span class="k">def</span> <span class="nf">return_heatmap_lipid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is used to either generate a Plotly Figure containing an empty go.Heatmap,</span>
<span class="sd">        or complete the figure passed as argument with a proper layout that matches the theme of the</span>
<span class="sd">        app.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig (Plotly Figure, optional): A Plotly Figure whose layout must be completed. If None,</span>
<span class="sd">                a new figure will be generated. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Plotly Figure): A Plotly Figure containing an empty go.Heatmap, or complete the figure</span>
<span class="sd">                passed as argument with a proper layout that matches the theme of the app.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Build empty figure if not provided</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="p">[[]],</span> <span class="n">x</span><span class="o">=</span><span class="p">[],</span> <span class="n">y</span><span class="o">=</span><span class="p">[],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Improve figure layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
            <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Transparent background</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

        <span class="c1"># Dark Template</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="c1"># ==============================================================================================</span>
    <span class="c1"># --- Methods used mainly in threeD_exploration</span>
    <span class="c1"># ==============================================================================================</span>

    <span class="k">def</span> <span class="nf">compute_treemaps_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is used to generate a Plotly Figure containing a treemap of the Allen Brain</span>
<span class="sd">        Atlas hierarchy.</span>

<span class="sd">        Args:</span>
<span class="sd">            maxdepth (int, optional): The depth of the treemap to generate. Defaults to 5.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Plotly.Figure): A Plotly Figure containing a treemap of the Allen Brain Atlas</span>
<span class="sd">                hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Build treemaps from list of children and parents</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">treemap</span><span class="p">(</span>
            <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">l_nodes</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">l_parents</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span>
        <span class="p">)</span>

        <span class="c1"># Improve layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">uniformtext</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">minsize</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">root_color</span><span class="o">=</span><span class="s2">&quot;#1d3d5c&quot;</span><span class="p">)</span>

        <span class="c1"># Set background color to zero</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_3D_root_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">differentiate_borders</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is used to generate a go.Isosurface of the Allen Brain root structure,</span>
<span class="sd">        which will be used to enclose the display of lipid expression of other structures in the</span>
<span class="sd">        brain.</span>

<span class="sd">        Args:</span>
<span class="sd">            decrease_dimensionality_factor (int, optional): Decrease the dimensionnality of the</span>
<span class="sd">                brain to display, to get a lighter output. Defaults to 7.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (go.Isosurface): A semi-transparent go.Isosurface of the Allen Brain root structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get array of annotations, which associate coordinate to id</span>
        <span class="n">array_annotation_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># Subsample array of annotation the same way array_atlas was subsampled</span>
        <span class="n">array_annotation_root</span> <span class="o">=</span> <span class="n">array_annotation_root</span><span class="p">[</span>
            <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
            <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
            <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Bug correction for the last slice</span>
        <span class="n">array_annotation_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">array_annotation_root</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">array_annotation_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">array_annotation_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Get the volume array</span>
        <span class="n">array_atlas_borders_root</span> <span class="o">=</span> <span class="n">fill_array_borders</span><span class="p">(</span>
            <span class="n">array_annotation_root</span><span class="p">,</span>
            <span class="n">differentiate_borders</span><span class="o">=</span><span class="n">differentiate_borders</span><span class="p">,</span>
            <span class="n">color_near_borders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">keep_structure_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Compute the 3D grid</span>
        <span class="n">X_root</span><span class="p">,</span> <span class="n">Y_root</span><span class="p">,</span> <span class="n">Z_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
            <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">1000</span>
            <span class="o">*</span> <span class="mi">25</span>
            <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
            <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">1000</span>
            <span class="o">*</span> <span class="mi">25</span>
            <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
            <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">1000</span>
            <span class="o">*</span> <span class="mi">25</span>
            <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Compute the plot</span>
        <span class="n">brain_root_data</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Isosurface</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">X_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">y</span><span class="o">=</span><span class="n">Y_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">z</span><span class="o">=</span><span class="n">Z_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">value</span><span class="o">=</span><span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">isomin</span><span class="o">=-</span><span class="mf">0.21</span><span class="p">,</span>
            <span class="n">isomax</span><span class="o">=</span><span class="mf">2.55</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># max opacity</span>
            <span class="n">surface_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>  <span class="c1"># colorscale,</span>
            <span class="n">flatshading</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">brain_root_data</span>

    <span class="k">def</span> <span class="nf">get_array_of_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decrease_dimensionality_factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns the array of annotations from the Allen Brain Atlas, subsampled to</span>
<span class="sd">        decrease the size of the output.</span>
<span class="sd">        Args:</span>
<span class="sd">            decrease_dimensionality_factor (int): An integer used for subsampling the array. The</span>
<span class="sd">                higher, the higher the subsampling.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray): A 3D array of annotation, in which structures are annotated with specific</span>
<span class="sd">                identifiers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get subsampled array of annotations</span>
        <span class="n">array_annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span>
                <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
                <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
                <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Bug correction for the last slice</span>
        <span class="n">array_annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">array_annotation</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">array_annotation</span>

    <span class="k">def</span> <span class="nf">compute_l_array_2D</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ll_t_bounds</span><span class="p">,</span>
        <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is used to get the list of expression per slice for all slices for the</span>
<span class="sd">        computation of the 3D brain volume.</span>

<span class="sd">        Args:</span>
<span class="sd">            ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">                list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">            normalize_independently (bool, optional): If True, each lipid intensity array is</span>
<span class="sd">                normalized independently, regardless of other lipids or channel used. Defaults to</span>
<span class="sd">                True.</span>
<span class="sd">            high_res (bool, optional): If True, the returned list of arrays correspond to the</span>
<span class="sd">                warped/upscaled data. Defaults to False as this is a very heavy plot.</span>
<span class="sd">            brain_1 (bool, optional): If True, the returned list of arrays correspond to the</span>
<span class="sd">                brain 1 data. Else, to the brain 2 data. Defaults to True.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (list(np.ndarray)): A list of numpy arrays representing the expression of the requested</span>
<span class="sd">                lipids (through ll_t_bounds) for each slice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l_array_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Correct the indices for the potentially unused slices from brain 1</span>
        <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
            <span class="n">slice_index_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_index_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">))</span>

        <span class="c1"># Loop over slices and compute the expression of the requested lipids</span>
        <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">ll_t_bounds</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="c1"># Get the data as an expression image per lipid</span>
                <span class="n">array_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rgb_array_per_lipid_selection</span><span class="p">(</span>
                    <span class="n">slice_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">slice_index_offset</span><span class="p">,</span>
                    <span class="n">ll_t_bounds</span><span class="p">[</span><span class="n">slice_index</span><span class="p">],</span>
                    <span class="n">normalize_independently</span><span class="o">=</span><span class="n">normalize_independently</span><span class="p">,</span>
                    <span class="n">projected_image</span><span class="o">=</span><span class="n">high_res</span><span class="p">,</span>
                    <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">apply_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Sum array colors (i.e. lipids)</span>
                <span class="n">array_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">array_data</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Append data to l_array_data</span>
            <span class="n">l_array_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">))</span>  <span class="c1"># float16 to gain space</span>

        <span class="k">return</span> <span class="n">l_array_data</span>

    <span class="k">def</span> <span class="nf">compute_array_coordinates_3D</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">l_array_data</span><span class="p">,</span>
        <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This functions computes the list of coordinates and expression values for the voxels used</span>
<span class="sd">        in the 3D representation of the brain.</span>

<span class="sd">        Args:</span>
<span class="sd">            l_array_data (list(np.ndarray)): A list of numpy arrays representing lipid expression</span>
<span class="sd">                for each slice of the dataset.</span>
<span class="sd">            high_res (bool, optional): If True, the computations made correspond to the</span>
<span class="sd">                warped/upscaled data. Defaults to False as this is a very heavy plot.</span>
<span class="sd">            brain_1 (bool, optional): If True, the returned list of arrays correspond to the</span>
<span class="sd">                brain 1 data. Else, to the brain 2 data. Defaults to True.</span>
<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray, np.ndarray, np.ndarray, np.ndarray): 4 flat numpy arrays (3 for coordinates</span>
<span class="sd">                and 1 for expression).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing 3D arrays&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># Correct the indices for the potentially unused slices from brain 1</span>
        <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
            <span class="n">slice_index_init</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">slice_index_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_index_init</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">))</span>
            <span class="n">slice_index_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_number</span><span class="p">()</span>

        <span class="c1"># get list of original coordinates for each slice</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">high_res</span><span class="p">:</span>
            <span class="n">l_coor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">l_original_coor</span><span class="p">[</span><span class="n">slice_index_init</span><span class="p">:</span><span class="n">slice_index_end</span><span class="p">]</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">*</span> <span class="mi">400</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="mi">1311</span> <span class="o">*</span> <span class="mi">918</span>
            <span class="n">l_coor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="p">[</span><span class="n">slice_index_init</span><span class="p">:</span><span class="n">slice_index_end</span><span class="p">]</span>

        <span class="c1"># Initialize empty arrays with a large estimate for the orginal acquisition size</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="n">estimate</span> <span class="o">*</span> <span class="p">(</span><span class="n">slice_index_end</span> <span class="o">-</span> <span class="n">slice_index_init</span><span class="p">)</span>
        <span class="n">array_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">array_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">array_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">array_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">total_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size array_x: </span><span class="si">{</span><span class="n">array_x</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting slice iteration&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># get atlas shape and resolution</span>
        <span class="n">reference_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span>
        <span class="n">array_annotations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_array_data</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Get the averaged expression data for the current slice</span>
            <span class="n">array_data</span> <span class="o">=</span> <span class="n">l_array_data</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span>

            <span class="c1"># If array_data is not an array but a 0 float, skip it</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">array_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Remove pixels for which lipid expression is zero</span>
            <span class="n">array_data_stripped</span> <span class="o">=</span> <span class="n">array_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># array_data[array_data != 0].flatten()</span>

            <span class="c1"># Skip the current slice if expression is very sparse</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_data_stripped</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array_data_stripped</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Compute the percentile of expression to filter out lowly expressed pixels</span>
            <span class="c1"># Set to 0 for now, as no filtering is done</span>
            <span class="n">percentile</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># np.percentile(array_data_stripped, 10)</span>

            <span class="c1"># Get the coordinates of the pixels in the ccfv3</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">l_coor</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span>
            <span class="c1"># coordinates_stripped = coordinates[array_data != 0]</span>
            <span class="n">coordinates_stripped</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Get the data as 4 arrays (3 for coordinates and 1 for expression)</span>
            <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span><span class="p">,</span> <span class="n">total_index</span> <span class="o">=</span> <span class="n">filter_voxels</span><span class="p">(</span>
                <span class="n">array_data_stripped</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">coordinates_stripped</span><span class="p">,</span>
                <span class="n">array_annotations</span><span class="p">,</span>
                <span class="n">percentile</span><span class="p">,</span>
                <span class="n">array_x</span><span class="p">,</span>
                <span class="n">array_y</span><span class="p">,</span>
                <span class="n">array_z</span><span class="p">,</span>
                <span class="n">array_c</span><span class="p">,</span>
                <span class="n">total_index</span><span class="p">,</span>
                <span class="n">reference_shape</span><span class="p">,</span>
                <span class="n">resolution</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; done&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># Strip the arrays from the zeros</span>
        <span class="n">array_x</span> <span class="o">=</span> <span class="n">array_x</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span>
        <span class="n">array_y</span> <span class="o">=</span> <span class="n">array_y</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span>
        <span class="n">array_z</span> <span class="o">=</span> <span class="n">array_z</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span>
        <span class="c1"># * Caution, array_c should be a list to work with Plotly</span>
        <span class="n">array_c</span> <span class="o">=</span> <span class="n">array_c</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Return the arrays for the 3D figure</span>
        <span class="k">return</span> <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span>

    <span class="k">def</span> <span class="nf">compute_3D_volume_figure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">set_progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ll_t_bounds</span><span class="o">=</span><span class="p">[[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]],</span>
        <span class="n">name_lipid_1</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">name_lipid_2</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">name_lipid_3</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">set_id_regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">structure_guided_interpolation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_interpolated_array</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_individual_slice_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">divider_radius</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This figure computes a Plotly Figure containing a go.Volume object representing the</span>
<span class="sd">        expression of the requested lipids in the selected regions, interpolated between the slices.</span>
<span class="sd">        Lipid names are used to retrieve the expression data from the Shelve database.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_progress: Used as part of the Plotly long callbacks, to indicate the progress of the</span>
<span class="sd">                computation in the corresponding progress bar.</span>
<span class="sd">            ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">                list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">            name_lipid_1 (str, optional): Name of the first selected lipid. Defaults to &quot;&quot;.</span>
<span class="sd">            name_lipid_2 (str, optional): Name of the second selected lipid. Defaults to &quot;&quot;.</span>
<span class="sd">            name_lipid_3 (str, optional): Name of the third selected lipid. Defaults to &quot;&quot;.</span>
<span class="sd">            set_id_regions (set(int), optional): A set containing the identifiers of the brain</span>
<span class="sd">                regions (at the very bottom of the hierarchy) in which lipid expression is</span>
<span class="sd">                requested. Defaults to None, corresponding to the whole brain.</span>
<span class="sd">            decrease_dimensionality_factor (int): An integer used for subsampling the array of</span>
<span class="sd">                annotation, and therefore the resulting figure. The higher, the higher the</span>
<span class="sd">                subsampling. Needed as this is a very heavy plot. Defaults to 6.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">            structure_guided_interpolation (bool, optional): If True, the interpolation is done</span>
<span class="sd">                using the annotated structures. If False, the interpolation is done blindly.</span>
<span class="sd">            return_interpolated_array (bool): If True, the interpolated array is returned. Else, the</span>
<span class="sd">                corresponding Plotly figure is returned. Defaults to False.</span>
<span class="sd">            return_individual_slice_data (bool): If True, the individual slice data (not</span>
<span class="sd">                interpolated) is returned.</span>
<span class="sd">            divider_radius (int): The inverse radius of the sphere used to do the interpolation.</span>
<span class="sd">                Defaults to 16.</span>
<span class="sd">            brain_1 (bool): If True, the brain 1 data is used. Else, the brain 2 data is used.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Depending on the value of return_interpolated_array and return_individual_slice_data,</span>
<span class="sd">                returns either the (not) interpolated array of expression of the requested lipids</span>
<span class="sd">                in the selected regions, or a Plotly Figure containing a go.Volume object</span>
<span class="sd">                representing the interpolated expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">return_interpolated_array</span> <span class="ow">and</span> <span class="n">return_individual_slice_data</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cannot return both interpolated and not interpolated array... Returning the&quot;</span>
                <span class="s2">&quot; individual slice data.&quot;</span>
            <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting 3D volume computation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Loading array of annotations&quot;</span><span class="p">))</span>
        <span class="c1"># Get subsampled array of annotations</span>
        <span class="n">array_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;arrays_annotation&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array_of_annotations</span><span class="p">,</span>
            <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Get subsampled array of borders for each region</span>
        <span class="n">array_atlas_borders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_id_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_id_regions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">set_id_regions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_id_regions</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Computing brain borders&quot;</span><span class="p">))</span>

        <span class="c1"># Shelving this function is useless as it takes less than 0.1s to compute after</span>
        <span class="c1"># first compilation</span>
        <span class="n">array_atlas_borders</span> <span class="o">=</span> <span class="n">fill_array_borders</span><span class="p">(</span>
            <span class="n">array_annotation</span><span class="p">,</span>
            <span class="n">keep_structure_id</span><span class="o">=</span><span class="n">list_id_regions</span><span class="p">,</span>
            <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computed basic structure array&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;Computing expression for each lipid&quot;</span><span class="p">))</span>

        <span class="c1"># Get array of expression for each lipid</span>
        <span class="n">ll_array_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;arrays_expression_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">brain_1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_lipid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">ignore_arguments_naming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_l_array_2D</span><span class="p">,</span>
                <span class="n">ll_t_bounds</span><span class="o">=</span><span class="p">[[</span><span class="n">l_t_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span><span class="p">],</span>
                <span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">,</span>
                <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name_lipid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">name_lipid_1</span><span class="p">,</span> <span class="n">name_lipid_2</span><span class="p">,</span> <span class="n">name_lipid_3</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Averaging expression for each lipid&quot;</span><span class="p">))</span>

        <span class="c1"># Average array of expression over lipid</span>
        <span class="n">l_array_data_avg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># * number of lipids is hardcoded</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">ll_array_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">slice_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">avg</span> <span class="o">+=</span> <span class="n">s</span>

            <span class="c1"># In case there&#39;s no data for the current slice, set the average to 0</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">l_array_data_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaged expression over all lipids&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;Getting slice coordinates&quot;</span><span class="p">))</span>

        <span class="c1"># Get the 3D array of expression and coordinates</span>
        <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_array_coordinates_3D</span><span class="p">(</span>
            <span class="n">l_array_data_avg</span><span class="p">,</span> <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">return_individual_slice_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computed array of expression in original space&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;Filling a new brain with expression&quot;</span><span class="p">))</span>

        <span class="c1"># Compute the rescaled array of expression for each slice averaged over projected lipids</span>
        <span class="n">array_slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">array_atlas_borders</span><span class="p">)</span>
        <span class="n">array_for_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">array_atlas_borders</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">array_x_scaled</span> <span class="o">=</span> <span class="n">array_x</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span> <span class="o">/</span> <span class="n">decrease_dimensionality_factor</span>
        <span class="n">array_y_scaled</span> <span class="o">=</span> <span class="n">array_y</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span> <span class="o">/</span> <span class="n">decrease_dimensionality_factor</span>
        <span class="n">array_z_scaled</span> <span class="o">=</span> <span class="n">array_z</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span> <span class="o">/</span> <span class="n">decrease_dimensionality_factor</span>

        <span class="n">array_slices</span> <span class="o">=</span> <span class="n">fill_array_slices</span><span class="p">(</span>
            <span class="n">array_x_scaled</span><span class="p">,</span>
            <span class="n">array_y_scaled</span><span class="p">,</span>
            <span class="n">array_z_scaled</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_c</span><span class="p">),</span>
            <span class="n">array_slices</span><span class="p">,</span>
            <span class="n">array_for_avg</span><span class="p">,</span>
            <span class="n">limit_value_inside</span><span class="o">=-</span><span class="mf">1.99999</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filled basic structure array with array of expression&quot;</span><span class="p">)</span>

        <span class="c1"># Get the corresponding coordinates</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
            <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">1000</span>
            <span class="o">*</span> <span class="mi">25</span>
            <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
            <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">1000</span>
            <span class="o">*</span> <span class="mi">25</span>
            <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
            <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">1000</span>
            <span class="o">*</span> <span class="mi">25</span>
            <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Built arrays of coordinates&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_id_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span> <span class="o">=</span> <span class="n">crop_array</span><span class="p">(</span><span class="n">array_annotation</span><span class="p">,</span> <span class="n">list_id_regions</span><span class="p">)</span>
            <span class="n">array_annotation</span> <span class="o">=</span> <span class="n">array_annotation</span><span class="p">[</span>
                <span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">]</span>
            <span class="n">array_slices</span> <span class="o">=</span> <span class="n">array_slices</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cropped the figure to only keep areas in which lipids are expressed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;Interpolating expression&quot;</span><span class="p">))</span>

        <span class="c1"># Compute an array containing the lipid expression interpolated for every voxel</span>
        <span class="n">array_interpolated</span> <span class="o">=</span> <span class="n">fill_array_interpolation</span><span class="p">(</span>
            <span class="n">array_annotation</span><span class="p">,</span>
            <span class="n">array_slices</span><span class="p">,</span>
            <span class="n">divider_radius</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
            <span class="n">limit_value_inside</span><span class="o">=-</span><span class="mf">1.99999</span><span class="p">,</span>
            <span class="n">structure_guided</span><span class="o">=</span><span class="n">structure_guided_interpolation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished interpolation between slices&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_interpolated_array</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">array_interpolated</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;Building figure&quot;</span><span class="p">))</span>

        <span class="c1"># Get root figure</span>
        <span class="n">root_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume_root&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_3D_root_volume</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Building final figure&quot;</span><span class="p">)</span>

        <span class="c1"># Build figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">array_interpolated</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">isomin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                    <span class="n">isomax</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                    <span class="n">opacityscale</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                    <span class="p">],</span>
                    <span class="n">surface_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">root_data</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Hide grey background</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Set background color to zero</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done computing 3D volume figure&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;Returning figure&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_clustergram_figure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">set_progress</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="p">,</span>
        <span class="n">l_selected_regions</span><span class="p">,</span>
        <span class="n">percentile</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
        <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function computes a Plotly Clustergram figure, allowing to cluster and compare the</span>
<span class="sd">        expression of all the MAIA-transformed lipids in the dataset in the selected regions.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_progress: Used as part of the Plotly long callbacks, to indicate the progress of the</span>
<span class="sd">                computation in the corresponding progress bar.</span>
<span class="sd">            cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">                None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">            l_selected_regions (list(int), optional): A list containing the identifiers of the brain</span>
<span class="sd">                regions (at the very bottom of the hierarchy) whose border must be annotated.</span>
<span class="sd">            percentile (int, optional): The percentile of average expression below which the lipids</span>
<span class="sd">                must be discarded (to get rid of low expression noise). Defaults to 90.</span>
<span class="sd">            brain_1 (bool): If True, the brain 1 data is used. Else, the brain 2 data is used.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (go.Figure): a Plotly Clustergram figure clustering and comparing the expression of all</span>
<span class="sd">                the MAIA-transformed lipids in the dataset in the selected regions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing clustergram figure&quot;</span><span class="p">)</span>

        <span class="c1"># Memoize result as it&#39;s called everytime a filtering is done</span>
        <span class="nd">@cache_flask</span><span class="o">.</span><span class="n">memoize</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">return_df_avg_lipids</span><span class="p">(</span><span class="n">l_selected_regions</span><span class="p">):</span>
            <span class="n">dic_avg_lipids</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">l_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="n">l_slices</span><span class="p">:</span>
                <span class="c1"># Display progress every 10 slices</span>
                <span class="k">if</span> <span class="n">slice_index</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">set_progress</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">slice_index</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_slices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
                            <span class="s2">&quot;Loading slice n°&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">l_spectra</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">l_selected_regions</span><span class="p">:</span>
                    <span class="n">long_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">dic_acronym_name</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">dic_existing_masks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">dic_existing_masks</span><span class="p">[</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                            <span class="n">grah_scattergl_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">get_projected_mask_and_spectrum</span><span class="p">(</span>
                                <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">long_region</span><span class="p">,</span> <span class="n">MAIA_correction</span><span class="o">=</span><span class="kc">True</span>
                            <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">l_spectra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grah_scattergl_data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">l_spectra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s2">&quot;The masks have not been precomputed. Please precompute them before&quot;</span>
                            <span class="s2">&quot; running this function.&quot;</span>
                        <span class="p">)</span>
                <span class="n">ll_idx_labels</span> <span class="o">=</span> <span class="n">global_lipid_index_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l_spectra</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing dictionnary for averaging slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">))</span>

                <span class="c1"># Compute average expression for each lipid and each selection</span>
                <span class="n">set_lipids_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">ll_lipids_idx</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ll_avg_intensity</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">n_sel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_spectra</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">l_idx_labels</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_spectra</span><span class="p">,</span> <span class="n">ll_idx_labels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">array_intensity_with_lipids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">array_idx_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_idx_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

                        <span class="n">l_lipids_idx</span><span class="p">,</span> <span class="n">l_avg_intensity</span> <span class="o">=</span> <span class="n">compute_avg_intensity_per_lipid</span><span class="p">(</span>
                            <span class="n">array_intensity_with_lipids</span><span class="p">,</span> <span class="n">array_idx_labels</span>
                        <span class="p">)</span>
                        <span class="n">set_lipids_idx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">l_lipids_idx</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l_lipids_idx</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">l_avg_intensity</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">ll_lipids_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_lipids_idx</span><span class="p">)</span>
                    <span class="n">ll_avg_intensity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_avg_intensity</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">l_lipids</span><span class="p">,</span> <span class="n">l_avg_intensity</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">ll_lipids_idx</span><span class="p">,</span> <span class="n">ll_avg_intensity</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">l_lipids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">lipid</span><span class="p">,</span> <span class="n">intensity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_lipids</span><span class="p">,</span> <span class="n">l_avg_intensity</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">lipid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dic_avg_lipids</span><span class="p">:</span>
                                <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sel</span><span class="p">):</span>
                                    <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                            <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all lipid values across slices&quot;</span><span class="p">)</span>

            <span class="c1"># Average intensity per slice</span>
            <span class="k">for</span> <span class="n">lipid</span> <span class="ow">in</span> <span class="n">dic_avg_lipids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sel</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">dic_avg_lipids</span><span class="p">,</span>
                <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">l_selected_regions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sel</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df_avg_intensity_lipids</span>

        <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">return_df_avg_lipids</span><span class="p">(</span><span class="n">l_selected_regions</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging done for all slices&quot;</span><span class="p">)</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;Loading data&quot;</span><span class="p">))</span>

        <span class="c1"># Exclude very lowly expressed lipids</span>
        <span class="n">df_min_expression</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="p">[</span>
            <span class="n">df_min_expression</span> <span class="o">&gt;</span> <span class="n">df_min_expression</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">percentile</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_selected_regions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),</span> <span class="p">:</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">l_selected_regions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lowly expressed lipids excluded&quot;</span><span class="p">)</span>

        <span class="c1"># Replace idx_lipids by actual name</span>
        <span class="n">df_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span>
        <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">idx</span><span class="p">:</span> <span class="n">df_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">df_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">df_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;cation&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lipid indexes replaced by names&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing plot&quot;</span><span class="p">)</span>
        <span class="c1"># Plot</span>
        <span class="n">fig_heatmap_lipids</span> <span class="o">=</span> <span class="n">Clustergram</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">column_labels</span><span class="o">=</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="n">row_labels</span><span class="o">=</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="n">hidden_labels</span><span class="o">=</span><span class="s2">&quot;row&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">color_map</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">display_ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Set background color to zero</span>
        <span class="n">fig_heatmap_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
        <span class="n">fig_heatmap_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig_heatmap_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

        <span class="n">set_progress</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;Returning figure&quot;</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning figure&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig_heatmap_lipids</span>

    <span class="c1"># ==============================================================================================</span>
    <span class="c1"># --- Methods used in scRNAseq page</span>
    <span class="c1"># ==============================================================================================</span>

    <span class="k">def</span> <span class="nf">compute_scatter_3D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This functions computes a figure representing, in a 3D scatter plot, the spots acquired</span>
<span class="sd">        using spatial scRNAseq experiments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Plotly.Figure): A Plotly Figure containing a go.Scatter3d object representing the</span>
<span class="sd">                acquired spots.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing 3D scatter plot for scRNAseq experiments&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="c1"># Get scatter figure for the scRNAseq spots</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">xmol</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">zmol</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">ymol</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># Get root figure</span>
        <span class="n">root_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume_root&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_3D_root_volume</span><span class="p">,</span>
            <span class="n">differentiate_borders</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Remove inside of volume</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">),</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Change orientation</span>
        <span class="n">root_data_y</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="n">root_data_z</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data_z</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">root_data_y</span>

        <span class="c1"># Remove parts of brain that prevent from clicking points</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">root_data_y_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data_y_copy</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)]</span>

        <span class="c1"># Block interaction for skull</span>
        <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;hoverinfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;skip&quot;</span>
        <span class="n">scatter</span><span class="p">[</span><span class="s2">&quot;hoverinfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

        <span class="c1"># Build figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">root_data</span><span class="p">,</span> <span class="n">scatter</span><span class="p">])</span>

        <span class="c1"># Hide background</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Click on a point to see the corresponding scRNAseq data&quot;</span><span class="p">,</span>
            <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Set background color to zero</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

        <span class="c1"># Change orientation to have scatter dots face the reader</span>
        <span class="n">x_eye</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">y_eye</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">z_eye</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="c1"># up=dict(x=0, y=0, z=0),</span>
            <span class="c1"># center=dict(x=0, y=0, z=0),</span>
            <span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_eye</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_eye</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z_eye</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">compute_barplots_enrichment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">idx_dot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This functions computes two figures representing, in barplots, the lipid expression in</span>
<span class="sd">        the spots acquired using spatial scRNAseq experiments, as well as how it can be explained by</span>
<span class="sd">        an elastic net regression using gene expression as explaing factors.</span>

<span class="sd">        Args:</span>
<span class="sd">            brain_1 (bool, optional): If True, the barplot will be displayed with the regression</span>
<span class="sd">                coefficients computed from for the first brain.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Plotly.Figure, Plotly.Figure, list(str), list(str)): Two Plotly Figures containing each</span>
<span class="sd">                a go.Bar object representing the standardized lipid expression in the scRNAseq</span>
<span class="sd">                spots, and the elastic net regression coefficients for each lipid (bar). The two</span>
<span class="sd">                lists contain the corresponding names of the genes and lipids represented.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing barplot for scRNAseq experiments&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_1</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_1</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_1</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_1</span>
            <span class="n">l_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_score_brain_1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_2</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_2</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_2</span>
            <span class="n">l_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_score_brain_2</span>

        <span class="c1"># Turn expression into enrichment score</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="p">(</span><span class="n">expression</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Take the average expression across all spots, or the expression in the selected spot</span>
        <span class="k">if</span> <span class="n">idx_dot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">idx_dot</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Sort lipids by enrichment</span>
        <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expression</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">]</span>

        <span class="c1"># Get arrays for plotting</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">l_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_score</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>

        <span class="c1"># Limit to the 24 most expressed genes (in the most enriched lipid),</span>
        <span class="c1"># for only 24 colors are sharply distinguishable by naked eye</span>
        <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">index_sorted</span><span class="p">[:</span><span class="mi">24</span><span class="p">]]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">names</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">[:</span><span class="mi">24</span><span class="p">]]</span>

        <span class="c1"># Normalize to 1</span>
        <span class="c1"># y = (y.T / np.sum(abs(y), axis=1) * expression).T</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Incorporate score in the mix</span>
        <span class="c1"># y = np.vstack((y.T * l_score, (1 - l_score) * expression * np.ones((len(y),)))).T</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">l_score</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l_score</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),))))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="s2">&quot;Unexplained&quot;</span><span class="p">)</span>

        <span class="c1"># Limit to 40 lipids for clarity</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">40</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[:</span><span class="mi">40</span><span class="p">]</span>

        <span class="c1"># Plot figure</span>
        <span class="n">fig_lipids</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">fig_lipids</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">expression</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Hide background</span>
        <span class="n">fig_lipids</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Lipid expression enrichment in selected spot (z-score)&quot;</span><span class="p">,</span>
            <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span>
            <span class="c1"># margin=dict(t=0, r=0, b=0, l=0),</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Set background color to zero</span>
        <span class="n">fig_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
        <span class="n">fig_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

        <span class="c1"># Plot figure</span>
        <span class="n">fig_genes</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">y_gene</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">names</span><span class="p">)):</span>
            <span class="n">fig_genes</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">y_gene</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">marker_pattern_shape</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">y_gene</span><span class="p">],</span>  <span class="c1"># Doesn&#39;t work...</span>
                    <span class="n">marker_color</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">23</span> <span class="k">else</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                    <span class="n">hovertext</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx_lipid</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx_lipid</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot; (Fraction of (absolute) total elastic net coefficients)&quot;</span>
                        <span class="k">for</span> <span class="n">idx_lipid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Hide background</span>
        <span class="n">fig_genes</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Elastic net coefficients, representing how lipid is explained by the corresponding&quot;</span>
                <span class="s2">&quot; gene&quot;</span>
            <span class="p">),</span>
            <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span>
            <span class="c1"># margin=dict(t=0, r=0, b=0, l=0),</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Set background color to zero</span>
        <span class="n">fig_genes</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
        <span class="n">fig_genes</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
        <span class="n">fig_genes</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

        <span class="k">return</span> <span class="n">fig_lipids</span><span class="p">,</span> <span class="n">fig_genes</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">compute_heatmap_lipid_genes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lipid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">l_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initial_frame</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">set_progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This functions computes a heatmap representing, on the left side, the expression of a</span>
<span class="sd">        given lipid in the (low-resolution, interpolated) MALDI data, and the right side, the</span>
<span class="sd">        expressions of the selected genes (in l_genes) in the scRNAseq experiments from the</span>
<span class="sd">        molecular atlas data.</span>

<span class="sd">        Args:</span>
<span class="sd">            lipid (str): The name of the lipid to be displayed. If None, the most expressed lipid</span>
<span class="sd">                will be displayed. Defaults to None.</span>
<span class="sd">            l_genes (list): The list of gene names to be displayed. If None, the three most</span>
<span class="sd">                expressed genes will be displayed. Defaults to None.</span>
<span class="sd">            initial_frame   (int, optional): The frame on which the slider is initialized.</span>
<span class="sd">            brain_1 (bool, optional): If True, the heatmap will be computed with the data coming</span>
<span class="sd">                from the first brain. Else, from the 2nd brain. Defaults to False.</span>
<span class="sd">            set_progress: Used as part of the Plotly long callbacks, to indicate the progress of the</span>
<span class="sd">                computation in the corresponding progress bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Plotly.Figure): A Plotly Figure containing a go.Heatmap object representing the</span>
<span class="sd">                expression of the selected lipid and genes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing heatmap for scRNAseq experiments&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Loading data&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_1</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_1</span>
            <span class="n">name_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_1</span>
            <span class="n">name_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_1</span>
            <span class="n">array_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_1</span>
            <span class="n">array_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_genes_brain_1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_2</span>
            <span class="n">name_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_2</span>
            <span class="n">name_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_2</span>
            <span class="n">array_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_2</span>
            <span class="n">array_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_genes_brain_2</span>

        <span class="c1"># Get the most expressed lipid and genes if not provided</span>
        <span class="k">if</span> <span class="n">lipid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l_genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array_lipids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expression</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">]</span>
            <span class="n">lipids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>
            <span class="n">y_sorted</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y_sorted</span> <span class="o">=</span> <span class="n">y_sorted</span><span class="p">[:,</span> <span class="n">index_sorted</span><span class="p">]</span>
            <span class="n">genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">name_genes</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>
            <span class="n">lipid</span> <span class="o">=</span> <span class="n">lipids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">l_genes</span> <span class="o">=</span> <span class="n">genes</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Get coordinates</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">xmol</span>
        <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">ymol</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">zmol</span>

        <span class="c1"># Get idx lipid and genes</span>
        <span class="k">if</span> <span class="n">lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx_lipid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">name_lipids</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lipid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_lipid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">l_idx_genes_with_None</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">name_genes</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span> <span class="k">if</span> <span class="n">gene</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">l_genes</span>
        <span class="p">]</span>
        <span class="n">l_idx_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_gene</span> <span class="k">for</span> <span class="n">idx_gene</span> <span class="ow">in</span> <span class="n">l_idx_genes_with_None</span> <span class="k">if</span> <span class="n">idx_gene</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Build grids on which the data will be interpolated</span>
        <span class="n">x_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">y_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">z_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_domain</span><span class="p">,</span> <span class="n">y_domain</span><span class="p">,</span> <span class="n">z_domain</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;Preparing interpolation&quot;</span><span class="p">))</span>

        <span class="c1"># Build data from interpolation since sampling is irregular</span>
        <span class="k">if</span> <span class="n">idx_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid_lipid</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">array_lipids</span><span class="p">[:,</span> <span class="n">idx_lipid</span><span class="p">],</span>
                <span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid_lipid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_idx_genes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">grid_genes</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">array_genes</span><span class="p">[:,</span> <span class="n">l_idx_genes</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_idx_genes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">grid_genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">griddata</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                            <span class="n">array_genes</span><span class="p">[:,</span> <span class="n">idx_genes</span><span class="p">],</span>
                            <span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">idx_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">idx_genes</span> <span class="ow">in</span> <span class="n">l_idx_genes_with_None</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid_genes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">75</span><span class="p">,</span> <span class="s2">&quot;Finished interpolation... Building figure&quot;</span><span class="p">))</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Build Figure, with several frames as it will be slidable</span>
        <span class="k">if</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_lipid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_heatmap</span><span class="p">(</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">grid_lipid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                    <span class="n">visible</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">initial_frame</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_heatmap</span><span class="p">(</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">grid_genes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                        <span class="n">visible</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">initial_frame</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">grid_genes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
                        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">visible</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">initial_frame</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_lipid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;restyle&quot;</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;visible&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">)],</span>
                    <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="n">grid_lipid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

            <span class="n">sliders</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">active</span><span class="o">=</span><span class="n">initial_frame</span><span class="p">,</span>
                    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
                    <span class="n">pad</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="nb">len</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">currentvalue</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Layout</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Comparison between lipid and gene expression&quot;</span><span class="p">,</span>
                <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">title_y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
                <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
                <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
                <span class="n">sliders</span><span class="o">=</span><span class="n">sliders</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># No display of tick labels as they&#39;re wrong anyway</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                    <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
                <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
                <span class="n">yaxis_scaleanchor</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Reverse y axis if Image has been used</span>
            <span class="k">if</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Remove tick labels</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide x axis ticks</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide y axis ticks</span>

            <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">set_progress</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;Returning figure&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fig</span>

    <span class="c1"># ==============================================================================================</span>
    <span class="c1"># --- Methods used for shelving results</span>
    <span class="c1"># ==============================================================================================</span>

    <span class="k">def</span> <span class="nf">shelve_arrays_basic_figures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function shelves in the database all the arrays of basic images computed in</span>
<span class="sd">        self.compute_figure_basic_image(), across all slices and all types of arrays. This forces</span>
<span class="sd">        the precomputations of these arrays, and allows to access them faster. Once everything has</span>
<span class="sd">        been shelved, a boolean value is stored in the shelve database, to indicate that the arrays</span>
<span class="sd">        do not need to be recomputed at next app startup.</span>

<span class="sd">        Args:</span>
<span class="sd">            force_update (bool, optional): If True, the function will not overwrite existing files.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx_slice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_number</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">type_figure</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;original_data&quot;</span><span class="p">,</span> <span class="s2">&quot;warped_data&quot;</span><span class="p">,</span> <span class="s2">&quot;projection_corrected&quot;</span><span class="p">,</span> <span class="s2">&quot;atlas&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">display_annotations</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                    <span class="c1"># Force no annotation for the original data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                        <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;figure_basic_image&quot;</span><span class="p">,</span>
                        <span class="n">force_update</span><span class="o">=</span><span class="n">force_update</span><span class="p">,</span>
                        <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_figure_basic_image</span><span class="p">,</span>
                        <span class="n">type_figure</span><span class="o">=</span><span class="n">type_figure</span><span class="p">,</span>
                        <span class="n">index_image</span><span class="o">=</span><span class="n">idx_slice</span><span class="p">,</span>
                        <span class="n">plot_atlas_contours</span><span class="o">=</span><span class="n">display_annotations</span>
                        <span class="k">if</span> <span class="n">type_figure</span> <span class="o">!=</span> <span class="s2">&quot;original_data&quot;</span>
                        <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">dump_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_basic_figures_computed&quot;</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">shelve_all_l_array_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This functions precomputes and shelves all the arrays of lipid expression used in a 3D</span>
<span class="sd">        representation of the brain (through self.compute_3D_volume_figure()). Once everything has</span>
<span class="sd">        been shelved, a boolean value is stored in the shelve database, to indicate that the arrays</span>
<span class="sd">        do not need to be recomputed at next app startup.</span>

<span class="sd">        Args:</span>
<span class="sd">            force_update (bool, optional): If True, the function will not overwrite existing files.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            sample (bool, optional): If True, only a fraction of the precomputations are made (for</span>
<span class="sd">                debug). Default to False.</span>
<span class="sd">            brain_1 (bool, optional): If True, the data is precomputed for the brain 1. Else for</span>
<span class="sd">                the brain 2. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Count number of lipids processed for sampling</span>
        <span class="n">n_processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only a sample of the lipid arrays will be computed!&quot;</span><span class="p">)</span>

        <span class="c1"># Simulate a click on all lipid names</span>
        <span class="n">df_annotations_MAIA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations_MAIA_transformed_lipids</span><span class="p">(</span><span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_annotations_MAIA</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="n">structures</span> <span class="o">=</span> <span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">structures</span><span class="p">):</span>
                <span class="n">cations</span> <span class="o">=</span> <span class="n">df_annotations_MAIA</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">structure</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">cation</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cation</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cations</span><span class="p">):</span>
                    <span class="n">l_selected_lipids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span>
                        <span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span>
                    <span class="p">):</span>
                        <span class="c1"># Find lipid location</span>
                        <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">index</span><span class="p">[</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">structure</span><span class="p">)</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slice_index</span><span class="p">)</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;cation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cation</span><span class="p">)</span>
                            <span class="p">]</span>
                            <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="p">)</span>

                        <span class="c1"># If several lipids correspond to the selection, we have a problem...</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;More than one lipid corresponds to the selection&quot;</span><span class="p">)</span>
                            <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">l_lipid_loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="c1"># If no lipid correspond to the selection, set to -1</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># add lipid index for each slice</span>
                        <span class="n">l_selected_lipids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># Get final lipid name</span>
                    <span class="n">lipid_string</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">structure</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cation</span>

                    <span class="c1"># If lipid is present in at least one slice</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">l_selected_lipids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="c1"># Build the list of mz boundaries for each peak and each index</span>
                        <span class="n">lll_lipid_bounds</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">[</span>
                                <span class="p">[</span>
                                    <span class="p">(</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">]),</span>
                                        <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]),</span>
                                    <span class="p">)</span>
                                <span class="p">]</span>
                                <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                                <span class="k">else</span> <span class="kc">None</span>
                                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lipid_1_index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">]</span>
                            <span class="k">for</span> <span class="n">lipid_1_index</span> <span class="ow">in</span> <span class="n">l_selected_lipids</span>
                        <span class="p">]</span>

                        <span class="c1"># Compute 3D figures, selection is limited to one lipid</span>
                        <span class="n">name_lipid</span> <span class="o">=</span> <span class="n">lipid_string</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;arrays_expression_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">brain_1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_lipid</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span><span class="p">,</span>
                            <span class="n">force_update</span><span class="o">=</span><span class="n">force_update</span><span class="p">,</span>
                            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_l_array_2D</span><span class="p">,</span>
                            <span class="n">ignore_arguments_naming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">ll_t_bounds</span><span class="o">=</span><span class="n">lll_lipid_bounds</span><span class="p">,</span>
                            <span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">,</span>
                            <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No cache needed since launched at startup</span>
                        <span class="p">)</span>

                        <span class="n">n_processed</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">n_processed</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">sample</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Variable to signal everything has been computed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">dump_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_expression_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">brain_1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_computed&quot;</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">shelve_all_arrays_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This functions precomputes and shelves the array of structure annotation used in a</span>
<span class="sd">        3D representation of the brain (through self.compute_3D_volume_figure()), at different</span>
<span class="sd">        resolutions. Once everything has been shelved, a boolean value is stored in the shelve</span>
<span class="sd">        database, to indicate that the arrays do not need to be recomputed at next app startup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">decrease_dimensionality_factor</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;arrays_annotation&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array_of_annotations</span><span class="p">,</span>
                <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Variable to signal everything has been computed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">dump_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_annotation_computed&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">maldi_data</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">scRNAseq</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the Figures class.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>maldi_data</code></td>
          <td>
                <code>MaldiData</code>
          </td>
          <td><p>MaldiData object, used to manipulate the raw MALDI data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage</code></td>
          <td>
                <code>Storage</code>
          </td>
          <td><p>Used to access the shelve database.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>atlas</code></td>
          <td>
                <code>Atlas</code>
          </td>
          <td><p>Used to manipulate the objects coming from the Allen Brain Atlas.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>scRNAseq</code></td>
          <td>
                <code>ScRNAseq</code>
          </td>
          <td><p>Used to manipulate the objects coming from the scRNAseq dataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sample</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, only a fraction of the precomputations are made (for
debug). Default to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maldi_data</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">scRNAseq</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the Figures class.</span>

<span class="sd">    Args:</span>
<span class="sd">        maldi_data (MaldiData): MaldiData object, used to manipulate the raw MALDI data.</span>
<span class="sd">        storage (Storage): Used to access the shelve database.</span>
<span class="sd">        atlas (Atlas): Used to manipulate the objects coming from the Allen Brain Atlas.</span>
<span class="sd">        scRNAseq (ScRNAseq): Used to manipulate the objects coming from the scRNAseq dataset.</span>
<span class="sd">        sample (bool, optional): If True, only a fraction of the precomputations are made (for</span>
<span class="sd">            debug). Default to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Figures object&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># Attribute to easily access the maldi and allen brain atlas data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">maldi_data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span> <span class="o">=</span> <span class="n">atlas</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span> <span class="o">=</span> <span class="n">scRNAseq</span>

    <span class="c1"># attribute to access the shelve database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="n">storage</span>

    <span class="c1"># Dic of normalization factors across slices for MAIA normalized lipids</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dic_normalization_factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/lipid_selection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dic_normalization_factors&quot;</span><span class="p">,</span>
        <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_normalization_factor_across_slices</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No cache since launched at startup</span>
    <span class="p">)</span>

    <span class="c1"># Check that treemaps has been computed already. If not, compute it and store it.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/atlas_page/3D&quot;</span><span class="p">,</span> <span class="s2">&quot;treemaps&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/atlas_page/3D&quot;</span><span class="p">,</span>
            <span class="s2">&quot;treemaps&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_treemaps_figure</span><span class="p">,</span>
        <span class="p">),</span>

    <span class="c1"># Check that 3D slice figures have been computed already. If not, compute it and store it.</span>
    <span class="k">for</span> <span class="n">brain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;brain_1&quot;</span><span class="p">,</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;slices_3D_&quot;</span> <span class="o">+</span> <span class="n">brain</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
                <span class="s2">&quot;slices_3D&quot;</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_figure_slices_3D</span><span class="p">,</span>
                <span class="n">brain</span><span class="o">=</span><span class="n">brain</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Check that the 3D root volume figure has been computed already. If not, compute it and</span>
    <span class="c1"># store it.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span> <span class="s2">&quot;scatter3D&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scatter3D&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_scatter_3D</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Check that the 3D scatter plot for scRNAseq data has been computed already. If not,</span>
    <span class="c1"># compute it and store it.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_root&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume_root&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_3D_root_volume</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Check that the base figures for lipid/genes heatmap have been computed already. If not,</span>
    <span class="c1"># compute them and store them.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span> <span class="s2">&quot;base_heatmap_lipid_True&quot;</span>
    <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span> <span class="s2">&quot;base_heatmap_lipid_False&quot;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base_heatmap_lipid&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_heatmap_lipid_genes</span><span class="p">,</span>
            <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/scRNAseq_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base_heatmap_lipid&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_heatmap_lipid_genes</span><span class="p">,</span>
            <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>

    <span class="c1"># Check that all basic figures in the load_slice page are present, if not, compute them</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_basic_figures_computed&quot;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelve_arrays_basic_figures</span><span class="p">()</span>

    <span class="c1"># Check that the lipid distributions for all slices, and both brains, have been computed, if</span>
    <span class="c1"># not, compute them</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_expression_True_computed&quot;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelve_all_l_array_2D</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_expression_False_computed&quot;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelve_all_l_array_2D</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Check that all arrays of annotations have been computed, if not, compute them</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">check_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_annotation_computed&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelve_all_arrays_annotation</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Figures object instantiated&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.build_lipid_heatmap_from_image" class="doc doc-heading">
<code class="highlight language-python"><span class="n">build_lipid_heatmap_from_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">type_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_go_image</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function converts a numpy array into a base64 string, which can be returned
directly, or itself be turned into a go.Image, which can be returned directly, or be
turned into a Plotly Figure, which will be returned.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>image</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array representing the image to be converted. Possibly with
several channels.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>return_base64_string</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the base64 string of the image is
returned directly, before any figure building. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>draw</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the user will have the possibility to draw on the
resulting Plotly Figure. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>type_image</code></td>
          <td>
                <code>string</code>
          </td>
          <td><p>The type of the image to be converted to a base64 string.
If image_array is in 3D, type must be RGB. If 4D, type must be RGBA. Else, no
requirement (None). Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>return_go_image</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the go.Image is returned directly, before
being integrated to a Plotly Figure. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Depending on the inputted arguments, may either return a base64 string, a go.Image, or
a Plotly Figure.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_lipid_heatmap_from_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">,</span>
    <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">type_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_go_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function converts a numpy array into a base64 string, which can be returned</span>
<span class="sd">    directly, or itself be turned into a go.Image, which can be returned directly, or be</span>
<span class="sd">    turned into a Plotly Figure, which will be returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (np.ndarray): A numpy array representing the image to be converted. Possibly with</span>
<span class="sd">            several channels.</span>
<span class="sd">        return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">            returned directly, before any figure building. Defaults to False.</span>
<span class="sd">        draw (bool, optional): If True, the user will have the possibility to draw on the</span>
<span class="sd">            resulting Plotly Figure. Defaults to False.</span>
<span class="sd">        type_image (string, optional): The type of the image to be converted to a base64 string.</span>
<span class="sd">            If image_array is in 3D, type must be RGB. If 4D, type must be RGBA. Else, no</span>
<span class="sd">            requirement (None). Defaults to None.</span>
<span class="sd">        return_go_image (bool, optional): If True, the go.Image is returned directly, before</span>
<span class="sd">            being integrated to a Plotly Figure. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Depending on the inputted arguments, may either return a base64 string, a go.Image, or</span>
<span class="sd">            a Plotly Figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting image to string&quot;</span><span class="p">)</span>

    <span class="c1"># Set optimize to False to gain computation time</span>
    <span class="n">base64_string</span> <span class="o">=</span> <span class="n">convert_image_to_base64</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">type_image</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transparent_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="c1"># Either return image directly</span>
    <span class="k">if</span> <span class="n">return_base64_string</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base64_string</span>

    <span class="c1"># Or compute heatmap as go image if needed</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting image to go image&quot;</span><span class="p">)</span>
    <span class="n">final_image</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
        <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">base64_string</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Potentially return the go image directly</span>
    <span class="k">if</span> <span class="n">return_go_image</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">final_image</span>

    <span class="c1"># Or build ploty graph</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>

    <span class="c1"># Improve graph layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">newshape</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">fillcolor</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="c1"># Do not specify height for now as plotly is buggued and resets if switching pages</span>
        <span class="c1"># height=500,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">layout_coloraxis_showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Set how the image should be annotated</span>
    <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">dragmode</span><span class="o">=</span><span class="s2">&quot;drawclosedpath&quot;</span><span class="p">)</span>

    <span class="c1"># Set background color to zero</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning figure&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_3D_root_volume" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_3D_root_volume</span><span class="p">(</span><span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">differentiate_borders</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function is used to generate a go.Isosurface of the Allen Brain root structure,
which will be used to enclose the display of lipid expression of other structures in the
brain.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>decrease_dimensionality_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Decrease the dimensionnality of the
brain to display, to get a lighter output. Defaults to 7.</p></td>
          <td>
                <code>7</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="plotly.graph_objects">go</span>.<span title="plotly.graph_objects.Isosurface">Isosurface</span></code>
          </td>
          <td><p>A semi-transparent go.Isosurface of the Allen Brain root structure.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_3D_root_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">differentiate_borders</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to generate a go.Isosurface of the Allen Brain root structure,</span>
<span class="sd">    which will be used to enclose the display of lipid expression of other structures in the</span>
<span class="sd">    brain.</span>

<span class="sd">    Args:</span>
<span class="sd">        decrease_dimensionality_factor (int, optional): Decrease the dimensionnality of the</span>
<span class="sd">            brain to display, to get a lighter output. Defaults to 7.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (go.Isosurface): A semi-transparent go.Isosurface of the Allen Brain root structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get array of annotations, which associate coordinate to id</span>
    <span class="n">array_annotation_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># Subsample array of annotation the same way array_atlas was subsampled</span>
    <span class="n">array_annotation_root</span> <span class="o">=</span> <span class="n">array_annotation_root</span><span class="p">[</span>
        <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
        <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
        <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Bug correction for the last slice</span>
    <span class="n">array_annotation_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">array_annotation_root</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">array_annotation_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">array_annotation_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get the volume array</span>
    <span class="n">array_atlas_borders_root</span> <span class="o">=</span> <span class="n">fill_array_borders</span><span class="p">(</span>
        <span class="n">array_annotation_root</span><span class="p">,</span>
        <span class="n">differentiate_borders</span><span class="o">=</span><span class="n">differentiate_borders</span><span class="p">,</span>
        <span class="n">color_near_borders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">keep_structure_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Compute the 3D grid</span>
    <span class="n">X_root</span><span class="p">,</span> <span class="n">Y_root</span><span class="p">,</span> <span class="n">Z_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
        <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">/</span> <span class="mi">1000</span>
        <span class="o">*</span> <span class="mi">25</span>
        <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
        <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="o">/</span> <span class="mi">1000</span>
        <span class="o">*</span> <span class="mi">25</span>
        <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
        <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="o">/</span> <span class="mi">1000</span>
        <span class="o">*</span> <span class="mi">25</span>
        <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Compute the plot</span>
    <span class="n">brain_root_data</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Isosurface</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">X_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">Y_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">z</span><span class="o">=</span><span class="n">Z_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">value</span><span class="o">=</span><span class="n">array_atlas_borders_root</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">isomin</span><span class="o">=-</span><span class="mf">0.21</span><span class="p">,</span>
        <span class="n">isomax</span><span class="o">=</span><span class="mf">2.55</span><span class="p">,</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># max opacity</span>
        <span class="n">surface_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>  <span class="c1"># colorscale,</span>
        <span class="n">flatshading</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">brain_root_data</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_3D_volume_figure" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_3D_volume_figure</span><span class="p">(</span><span class="n">set_progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ll_t_bounds</span><span class="o">=</span><span class="p">[[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]],</span> <span class="n">name_lipid_1</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name_lipid_2</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name_lipid_3</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">set_id_regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">structure_guided_interpolation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_interpolated_array</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_individual_slice_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">divider_radius</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This figure computes a Plotly Figure containing a go.Volume object representing the
expression of the requested lipids in the selected regions, interpolated between the slices.
Lipid names are used to retrieve the expression data from the Shelve database.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>set_progress</code></td>
          <td>
          </td>
          <td><p>Used as part of the Plotly long callbacks, to indicate the progress of the
computation in the corresponding progress bar.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>ll_t_bounds</code></td>
          <td>
                <code>list(list(tuple</code>
          </td>
          <td><p>A list of lists of lipid boundaries (tuples). The first
list is used to separate image channels. The second list is used to separate lipid.</p></td>
          <td>
                <code>[[(None, None)]]</code>
          </td>
        </tr>
        <tr>
          <td><code>name_lipid_1</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the first selected lipid. Defaults to "".</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>name_lipid_2</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the second selected lipid. Defaults to "".</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>name_lipid_3</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the third selected lipid. Defaults to "".</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>set_id_regions</code></td>
          <td>
                <code>set(int)</code>
          </td>
          <td><p>A set containing the identifiers of the brain
regions (at the very bottom of the hierarchy) in which lipid expression is
requested. Defaults to None, corresponding to the whole brain.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>decrease_dimensionality_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>An integer used for subsampling the array of
annotation, and therefore the resulting figure. The higher, the higher the
subsampling. Needed as this is a very heavy plot. Defaults to 6.</p></td>
          <td>
                <code>6</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>structure_guided_interpolation</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the interpolation is done
using the annotated structures. If False, the interpolation is done blindly.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>return_interpolated_array</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the interpolated array is returned. Else, the
corresponding Plotly figure is returned. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>return_individual_slice_data</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the individual slice data (not
interpolated) is returned.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>divider_radius</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The inverse radius of the sphere used to do the interpolation.
Defaults to 16.</p></td>
          <td>
                <code>16</code>
          </td>
        </tr>
        <tr>
          <td><code>brain_1</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the brain 1 data is used. Else, the brain 2 data is used.
Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Depending on the value of return_interpolated_array and return_individual_slice_data,
returns either the (not) interpolated array of expression of the requested lipids
in the selected regions, or a Plotly Figure containing a go.Volume object
representing the interpolated expression.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_3D_volume_figure</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">set_progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ll_t_bounds</span><span class="o">=</span><span class="p">[[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]],</span>
    <span class="n">name_lipid_1</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">name_lipid_2</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">name_lipid_3</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">set_id_regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">structure_guided_interpolation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_interpolated_array</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">return_individual_slice_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">divider_radius</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This figure computes a Plotly Figure containing a go.Volume object representing the</span>
<span class="sd">    expression of the requested lipids in the selected regions, interpolated between the slices.</span>
<span class="sd">    Lipid names are used to retrieve the expression data from the Shelve database.</span>

<span class="sd">    Args:</span>
<span class="sd">        set_progress: Used as part of the Plotly long callbacks, to indicate the progress of the</span>
<span class="sd">            computation in the corresponding progress bar.</span>
<span class="sd">        ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">            list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">        name_lipid_1 (str, optional): Name of the first selected lipid. Defaults to &quot;&quot;.</span>
<span class="sd">        name_lipid_2 (str, optional): Name of the second selected lipid. Defaults to &quot;&quot;.</span>
<span class="sd">        name_lipid_3 (str, optional): Name of the third selected lipid. Defaults to &quot;&quot;.</span>
<span class="sd">        set_id_regions (set(int), optional): A set containing the identifiers of the brain</span>
<span class="sd">            regions (at the very bottom of the hierarchy) in which lipid expression is</span>
<span class="sd">            requested. Defaults to None, corresponding to the whole brain.</span>
<span class="sd">        decrease_dimensionality_factor (int): An integer used for subsampling the array of</span>
<span class="sd">            annotation, and therefore the resulting figure. The higher, the higher the</span>
<span class="sd">            subsampling. Needed as this is a very heavy plot. Defaults to 6.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">        structure_guided_interpolation (bool, optional): If True, the interpolation is done</span>
<span class="sd">            using the annotated structures. If False, the interpolation is done blindly.</span>
<span class="sd">        return_interpolated_array (bool): If True, the interpolated array is returned. Else, the</span>
<span class="sd">            corresponding Plotly figure is returned. Defaults to False.</span>
<span class="sd">        return_individual_slice_data (bool): If True, the individual slice data (not</span>
<span class="sd">            interpolated) is returned.</span>
<span class="sd">        divider_radius (int): The inverse radius of the sphere used to do the interpolation.</span>
<span class="sd">            Defaults to 16.</span>
<span class="sd">        brain_1 (bool): If True, the brain 1 data is used. Else, the brain 2 data is used.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Depending on the value of return_interpolated_array and return_individual_slice_data,</span>
<span class="sd">            returns either the (not) interpolated array of expression of the requested lipids</span>
<span class="sd">            in the selected regions, or a Plotly Figure containing a go.Volume object</span>
<span class="sd">            representing the interpolated expression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">return_interpolated_array</span> <span class="ow">and</span> <span class="n">return_individual_slice_data</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Cannot return both interpolated and not interpolated array... Returning the&quot;</span>
            <span class="s2">&quot; individual slice data.&quot;</span>
        <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting 3D volume computation&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Loading array of annotations&quot;</span><span class="p">))</span>
    <span class="c1"># Get subsampled array of annotations</span>
    <span class="n">array_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
        <span class="s2">&quot;arrays_annotation&quot;</span><span class="p">,</span>
        <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array_of_annotations</span><span class="p">,</span>
        <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get subsampled array of borders for each region</span>
    <span class="n">array_atlas_borders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_id_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_id_regions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">set_id_regions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_id_regions</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Computing brain borders&quot;</span><span class="p">))</span>

    <span class="c1"># Shelving this function is useless as it takes less than 0.1s to compute after</span>
    <span class="c1"># first compilation</span>
    <span class="n">array_atlas_borders</span> <span class="o">=</span> <span class="n">fill_array_borders</span><span class="p">(</span>
        <span class="n">array_annotation</span><span class="p">,</span>
        <span class="n">keep_structure_id</span><span class="o">=</span><span class="n">list_id_regions</span><span class="p">,</span>
        <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computed basic structure array&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;Computing expression for each lipid&quot;</span><span class="p">))</span>

    <span class="c1"># Get array of expression for each lipid</span>
    <span class="n">ll_array_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;arrays_expression_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">brain_1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_lipid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ignore_arguments_naming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_l_array_2D</span><span class="p">,</span>
            <span class="n">ll_t_bounds</span><span class="o">=</span><span class="p">[[</span><span class="n">l_t_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span><span class="p">],</span>
            <span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">,</span>
            <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name_lipid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">name_lipid_1</span><span class="p">,</span> <span class="n">name_lipid_2</span><span class="p">,</span> <span class="n">name_lipid_3</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Averaging expression for each lipid&quot;</span><span class="p">))</span>

    <span class="c1"># Average array of expression over lipid</span>
    <span class="n">l_array_data_avg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># * number of lipids is hardcoded</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ll_array_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">slice_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">avg</span> <span class="o">+=</span> <span class="n">s</span>

        <span class="c1"># In case there&#39;s no data for the current slice, set the average to 0</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">l_array_data_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaged expression over all lipids&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;Getting slice coordinates&quot;</span><span class="p">))</span>

    <span class="c1"># Get the 3D array of expression and coordinates</span>
    <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_array_coordinates_3D</span><span class="p">(</span>
        <span class="n">l_array_data_avg</span><span class="p">,</span> <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_individual_slice_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computed array of expression in original space&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;Filling a new brain with expression&quot;</span><span class="p">))</span>

    <span class="c1"># Compute the rescaled array of expression for each slice averaged over projected lipids</span>
    <span class="n">array_slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">array_atlas_borders</span><span class="p">)</span>
    <span class="n">array_for_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">array_atlas_borders</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">array_x_scaled</span> <span class="o">=</span> <span class="n">array_x</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span> <span class="o">/</span> <span class="n">decrease_dimensionality_factor</span>
    <span class="n">array_y_scaled</span> <span class="o">=</span> <span class="n">array_y</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span> <span class="o">/</span> <span class="n">decrease_dimensionality_factor</span>
    <span class="n">array_z_scaled</span> <span class="o">=</span> <span class="n">array_z</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span> <span class="o">/</span> <span class="n">decrease_dimensionality_factor</span>

    <span class="n">array_slices</span> <span class="o">=</span> <span class="n">fill_array_slices</span><span class="p">(</span>
        <span class="n">array_x_scaled</span><span class="p">,</span>
        <span class="n">array_y_scaled</span><span class="p">,</span>
        <span class="n">array_z_scaled</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_c</span><span class="p">),</span>
        <span class="n">array_slices</span><span class="p">,</span>
        <span class="n">array_for_avg</span><span class="p">,</span>
        <span class="n">limit_value_inside</span><span class="o">=-</span><span class="mf">1.99999</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filled basic structure array with array of expression&quot;</span><span class="p">)</span>

    <span class="c1"># Get the corresponding coordinates</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
        <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">/</span> <span class="mi">1000</span>
        <span class="o">*</span> <span class="mi">25</span>
        <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
        <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="o">/</span> <span class="mi">1000</span>
        <span class="o">*</span> <span class="mi">25</span>
        <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
        <span class="mi">0</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="o">/</span> <span class="mi">1000</span>
        <span class="o">*</span> <span class="mi">25</span>
        <span class="o">*</span> <span class="n">decrease_dimensionality_factor</span> <span class="p">:</span> <span class="n">array_atlas_borders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Built arrays of coordinates&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">set_id_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span> <span class="o">=</span> <span class="n">crop_array</span><span class="p">(</span><span class="n">array_annotation</span><span class="p">,</span> <span class="n">list_id_regions</span><span class="p">)</span>
        <span class="n">array_annotation</span> <span class="o">=</span> <span class="n">array_annotation</span><span class="p">[</span>
            <span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">array_slices</span> <span class="o">=</span> <span class="n">array_slices</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">x_min</span> <span class="p">:</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span> <span class="p">:</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_min</span> <span class="p">:</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cropped the figure to only keep areas in which lipids are expressed&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;Interpolating expression&quot;</span><span class="p">))</span>

    <span class="c1"># Compute an array containing the lipid expression interpolated for every voxel</span>
    <span class="n">array_interpolated</span> <span class="o">=</span> <span class="n">fill_array_interpolation</span><span class="p">(</span>
        <span class="n">array_annotation</span><span class="p">,</span>
        <span class="n">array_slices</span><span class="p">,</span>
        <span class="n">divider_radius</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">limit_value_inside</span><span class="o">=-</span><span class="mf">1.99999</span><span class="p">,</span>
        <span class="n">structure_guided</span><span class="o">=</span><span class="n">structure_guided_interpolation</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished interpolation between slices&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_interpolated_array</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">array_interpolated</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;Building figure&quot;</span><span class="p">))</span>

    <span class="c1"># Get root figure</span>
    <span class="n">root_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
        <span class="s2">&quot;volume_root&quot;</span><span class="p">,</span>
        <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_3D_root_volume</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Building final figure&quot;</span><span class="p">)</span>

    <span class="c1"># Build figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">z</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">value</span><span class="o">=</span><span class="n">array_interpolated</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">isomin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                <span class="n">isomax</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">opacityscale</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">[</span><span class="o">-</span><span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">surface_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">root_data</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Hide grey background</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Set background color to zero</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done computing 3D volume figure&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;Returning figure&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_array_basic_images" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_array_basic_images</span><span class="p">(</span><span class="n">type_figure</span><span class="o">=</span><span class="s1">&#39;warped_data&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function computes and returns a three-dimensional array representing all slices from
the maldi_data acquisition (TIC) or the corresponding image from the atlas. No spectral data
is read in the process, as the arrays corresponding to the images are directly stored as
tiff files in the dataset.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>type_figure</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>To be chosen among "original_data", "warped_data",
"projection_corrected", "atlas". Depending on the chosen type, the final array will
correspond to either the original images ("original_data"), the warped and upscaled
images ("warped_data"), the warped and upscaled images, whose pixels outside of
annotations regions have been zero-ed out ("projection_corrected"), or the images
from the Allen Brain atlas projected onto the same plane as the corresponding slice
from the MALDI data ("atlas"). Default to "warped_data".</p></td>
          <td>
                <code>&#39;warped_data&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A three-dimensional array representing all slices from the maldi_data
acquisition (TIC) or the corresponding image from the atlas. The first dimension
corresponds to the slices, the second and third to the images themselves.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_array_basic_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_figure</span><span class="o">=</span><span class="s2">&quot;warped_data&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes and returns a three-dimensional array representing all slices from</span>
<span class="sd">    the maldi_data acquisition (TIC) or the corresponding image from the atlas. No spectral data</span>
<span class="sd">    is read in the process, as the arrays corresponding to the images are directly stored as</span>
<span class="sd">    tiff files in the dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        type_figure (str, optional): To be chosen among &quot;original_data&quot;, &quot;warped_data&quot;,</span>
<span class="sd">            &quot;projection_corrected&quot;, &quot;atlas&quot;. Depending on the chosen type, the final array will</span>
<span class="sd">            correspond to either the original images (&quot;original_data&quot;), the warped and upscaled</span>
<span class="sd">            images (&quot;warped_data&quot;), the warped and upscaled images, whose pixels outside of</span>
<span class="sd">            annotations regions have been zero-ed out (&quot;projection_corrected&quot;), or the images</span>
<span class="sd">            from the Allen Brain atlas projected onto the same plane as the corresponding slice</span>
<span class="sd">            from the MALDI data (&quot;atlas&quot;). Default to &quot;warped_data&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A three-dimensional array representing all slices from the maldi_data</span>
<span class="sd">            acquisition (TIC) or the corresponding image from the atlas. The first dimension</span>
<span class="sd">            corresponds to the slices, the second and third to the images themselves.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check for all array types</span>
    <span class="k">if</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;original_data&quot;</span><span class="p">:</span>
        <span class="n">array_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">compute_padded_original_images</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;warped_data&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_sample_data</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;data_sample/tiff_files/warped_data.npz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">array_images</span> <span class="o">=</span> <span class="n">handle</span><span class="p">[</span><span class="s2">&quot;array_warped_data&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">array_images</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;data/tiff_files/warped_data.tif&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;projection_corrected&quot;</span><span class="p">:</span>
        <span class="n">array_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_corrected</span>
    <span class="k">elif</span> <span class="n">type_figure</span> <span class="o">==</span> <span class="s2">&quot;atlas&quot;</span><span class="p">:</span>
        <span class="p">(</span>
            <span class="n">array_projected_images_atlas</span><span class="p">,</span>
            <span class="n">array_projected_simplified_id</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;atlas/atlas_objects&quot;</span><span class="p">,</span>
            <span class="s2">&quot;array_images_atlas&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">prepare_and_compute_array_images_atlas</span><span class="p">,</span>
            <span class="n">zero_out_of_annotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">array_images</span> <span class="o">=</span> <span class="n">array_projected_images_atlas</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The type of requested array &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">type_figure</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># If the array is not uint8, convert it to gain space</span>
    <span class="k">if</span> <span class="n">array_images</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
        <span class="n">array_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_images</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array_images</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_array_coordinates_3D" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_array_coordinates_3D</span><span class="p">(</span><span class="n">l_array_data</span><span class="p">,</span> <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This functions computes the list of coordinates and expression values for the voxels used
in the 3D representation of the brain.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>l_array_data</code></td>
          <td>
                <code>list(np.ndarray</code>
          </td>
          <td><p>A list of numpy arrays representing lipid expression
for each slice of the dataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>high_res</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the computations made correspond to the
warped/upscaled data. Defaults to False as this is a very heavy plot.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>brain_1</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the returned list of arrays correspond to the
brain 1 data. Else, to the brain 2 data. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>4 flat numpy arrays (3 for coordinates
and 1 for expression).</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_array_coordinates_3D</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">l_array_data</span><span class="p">,</span>
    <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions computes the list of coordinates and expression values for the voxels used</span>
<span class="sd">    in the 3D representation of the brain.</span>

<span class="sd">    Args:</span>
<span class="sd">        l_array_data (list(np.ndarray)): A list of numpy arrays representing lipid expression</span>
<span class="sd">            for each slice of the dataset.</span>
<span class="sd">        high_res (bool, optional): If True, the computations made correspond to the</span>
<span class="sd">            warped/upscaled data. Defaults to False as this is a very heavy plot.</span>
<span class="sd">        brain_1 (bool, optional): If True, the returned list of arrays correspond to the</span>
<span class="sd">            brain 1 data. Else, to the brain 2 data. Defaults to True.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray, np.ndarray, np.ndarray, np.ndarray): 4 flat numpy arrays (3 for coordinates</span>
<span class="sd">            and 1 for expression).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing 3D arrays&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># Correct the indices for the potentially unused slices from brain 1</span>
    <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
        <span class="n">slice_index_init</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">slice_index_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slice_index_init</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">))</span>
        <span class="n">slice_index_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_number</span><span class="p">()</span>

    <span class="c1"># get list of original coordinates for each slice</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">high_res</span><span class="p">:</span>
        <span class="n">l_coor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">l_original_coor</span><span class="p">[</span><span class="n">slice_index_init</span><span class="p">:</span><span class="n">slice_index_end</span><span class="p">]</span>
        <span class="n">estimate</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">*</span> <span class="mi">400</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">estimate</span> <span class="o">=</span> <span class="mi">1311</span> <span class="o">*</span> <span class="mi">918</span>
        <span class="n">l_coor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="p">[</span><span class="n">slice_index_init</span><span class="p">:</span><span class="n">slice_index_end</span><span class="p">]</span>

    <span class="c1"># Initialize empty arrays with a large estimate for the orginal acquisition size</span>
    <span class="n">max_size</span> <span class="o">=</span> <span class="n">estimate</span> <span class="o">*</span> <span class="p">(</span><span class="n">slice_index_end</span> <span class="o">-</span> <span class="n">slice_index_init</span><span class="p">)</span>
    <span class="n">array_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">array_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">array_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">array_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">total_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size array_x: </span><span class="si">{</span><span class="n">array_x</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting slice iteration&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># get atlas shape and resolution</span>
    <span class="n">reference_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span>
    <span class="n">array_annotations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_array_data</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Get the averaged expression data for the current slice</span>
        <span class="n">array_data</span> <span class="o">=</span> <span class="n">l_array_data</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span>

        <span class="c1"># If array_data is not an array but a 0 float, skip it</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">array_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Remove pixels for which lipid expression is zero</span>
        <span class="n">array_data_stripped</span> <span class="o">=</span> <span class="n">array_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># array_data[array_data != 0].flatten()</span>

        <span class="c1"># Skip the current slice if expression is very sparse</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_data_stripped</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array_data_stripped</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Compute the percentile of expression to filter out lowly expressed pixels</span>
        <span class="c1"># Set to 0 for now, as no filtering is done</span>
        <span class="n">percentile</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># np.percentile(array_data_stripped, 10)</span>

        <span class="c1"># Get the coordinates of the pixels in the ccfv3</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">l_coor</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span>
        <span class="c1"># coordinates_stripped = coordinates[array_data != 0]</span>
        <span class="n">coordinates_stripped</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Get the data as 4 arrays (3 for coordinates and 1 for expression)</span>
        <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span><span class="p">,</span> <span class="n">total_index</span> <span class="o">=</span> <span class="n">filter_voxels</span><span class="p">(</span>
            <span class="n">array_data_stripped</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">coordinates_stripped</span><span class="p">,</span>
            <span class="n">array_annotations</span><span class="p">,</span>
            <span class="n">percentile</span><span class="p">,</span>
            <span class="n">array_x</span><span class="p">,</span>
            <span class="n">array_y</span><span class="p">,</span>
            <span class="n">array_z</span><span class="p">,</span>
            <span class="n">array_c</span><span class="p">,</span>
            <span class="n">total_index</span><span class="p">,</span>
            <span class="n">reference_shape</span><span class="p">,</span>
            <span class="n">resolution</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; done&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># Strip the arrays from the zeros</span>
    <span class="n">array_x</span> <span class="o">=</span> <span class="n">array_x</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span>
    <span class="n">array_y</span> <span class="o">=</span> <span class="n">array_y</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span>
    <span class="n">array_z</span> <span class="o">=</span> <span class="n">array_z</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span>
    <span class="c1"># * Caution, array_c should be a list to work with Plotly</span>
    <span class="n">array_c</span> <span class="o">=</span> <span class="n">array_c</span><span class="p">[:</span><span class="n">total_index</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Return the arrays for the 3D figure</span>
    <span class="k">return</span> <span class="n">array_x</span><span class="p">,</span> <span class="n">array_y</span><span class="p">,</span> <span class="n">array_z</span><span class="p">,</span> <span class="n">array_c</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_barplots_enrichment" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_barplots_enrichment</span><span class="p">(</span><span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">idx_dot</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This functions computes two figures representing, in barplots, the lipid expression in
the spots acquired using spatial scRNAseq experiments, as well as how it can be explained by
an elastic net regression using gene expression as explaing factors.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>brain_1</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the barplot will be displayed with the regression
coefficients computed from for the first brain.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Plotly.<span title="Plotly.Figure">Figure</span>, Plotly.<span title="Plotly.Figure">Figure</span>, list(str), list(str)</code>
          </td>
          <td><p>Two Plotly Figures containing each
a go.Bar object representing the standardized lipid expression in the scRNAseq
spots, and the elastic net regression coefficients for each lipid (bar). The two
lists contain the corresponding names of the genes and lipids represented.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_barplots_enrichment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">idx_dot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions computes two figures representing, in barplots, the lipid expression in</span>
<span class="sd">    the spots acquired using spatial scRNAseq experiments, as well as how it can be explained by</span>
<span class="sd">    an elastic net regression using gene expression as explaing factors.</span>

<span class="sd">    Args:</span>
<span class="sd">        brain_1 (bool, optional): If True, the barplot will be displayed with the regression</span>
<span class="sd">            coefficients computed from for the first brain.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Plotly.Figure, Plotly.Figure, list(str), list(str)): Two Plotly Figures containing each</span>
<span class="sd">            a go.Bar object representing the standardized lipid expression in the scRNAseq</span>
<span class="sd">            spots, and the elastic net regression coefficients for each lipid (bar). The two</span>
<span class="sd">            lists contain the corresponding names of the genes and lipids represented.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing barplot for scRNAseq experiments&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_1</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_1</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_1</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_1</span>
        <span class="n">l_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_score_brain_1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_2</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_2</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_2</span>
        <span class="n">l_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_score_brain_2</span>

    <span class="c1"># Turn expression into enrichment score</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="p">(</span><span class="n">expression</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Take the average expression across all spots, or the expression in the selected spot</span>
    <span class="k">if</span> <span class="n">idx_dot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">idx_dot</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Sort lipids by enrichment</span>
    <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expression</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">]</span>

    <span class="c1"># Get arrays for plotting</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">l_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_score</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>

    <span class="c1"># Limit to the 24 most expressed genes (in the most enriched lipid),</span>
    <span class="c1"># for only 24 colors are sharply distinguishable by naked eye</span>
    <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">index_sorted</span><span class="p">[:</span><span class="mi">24</span><span class="p">]]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">names</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">[:</span><span class="mi">24</span><span class="p">]]</span>

    <span class="c1"># Normalize to 1</span>
    <span class="c1"># y = (y.T / np.sum(abs(y), axis=1) * expression).T</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Incorporate score in the mix</span>
    <span class="c1"># y = np.vstack((y.T * l_score, (1 - l_score) * expression * np.ones((len(y),)))).T</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">l_score</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l_score</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),))))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="s2">&quot;Unexplained&quot;</span><span class="p">)</span>

    <span class="c1"># Limit to 40 lipids for clarity</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">40</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[:</span><span class="mi">40</span><span class="p">]</span>

    <span class="c1"># Plot figure</span>
    <span class="n">fig_lipids</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="n">fig_lipids</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">expression</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Hide background</span>
    <span class="n">fig_lipids</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Lipid expression enrichment in selected spot (z-score)&quot;</span><span class="p">,</span>
        <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span>
        <span class="c1"># margin=dict(t=0, r=0, b=0, l=0),</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Set background color to zero</span>
    <span class="n">fig_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
    <span class="n">fig_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

    <span class="c1"># Plot figure</span>
    <span class="n">fig_genes</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">y_gene</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">names</span><span class="p">)):</span>
        <span class="n">fig_genes</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">y_gene</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">marker_pattern_shape</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">y_gene</span><span class="p">],</span>  <span class="c1"># Doesn&#39;t work...</span>
                <span class="n">marker_color</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">23</span> <span class="k">else</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="n">hovertext</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx_lipid</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx_lipid</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot; (Fraction of (absolute) total elastic net coefficients)&quot;</span>
                    <span class="k">for</span> <span class="n">idx_lipid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Hide background</span>
    <span class="n">fig_genes</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Elastic net coefficients, representing how lipid is explained by the corresponding&quot;</span>
            <span class="s2">&quot; gene&quot;</span>
        <span class="p">),</span>
        <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span>
        <span class="c1"># margin=dict(t=0, r=0, b=0, l=0),</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Set background color to zero</span>
    <span class="n">fig_genes</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
    <span class="n">fig_genes</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig_genes</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

    <span class="k">return</span> <span class="n">fig_lipids</span><span class="p">,</span> <span class="n">fig_genes</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_clustergram_figure" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_clustergram_figure</span><span class="p">(</span><span class="n">set_progress</span><span class="p">,</span> <span class="n">cache_flask</span><span class="p">,</span> <span class="n">l_selected_regions</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function computes a Plotly Clustergram figure, allowing to cluster and compare the
expression of all the MAIA-transformed lipids in the dataset in the selected regions.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>set_progress</code></td>
          <td>
          </td>
          <td><p>Used as part of the Plotly long callbacks, to indicate the progress of the
computation in the corresponding progress bar.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>l_selected_regions</code></td>
          <td>
                <code>list(int)</code>
          </td>
          <td><p>A list containing the identifiers of the brain
regions (at the very bottom of the hierarchy) whose border must be annotated.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>percentile</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The percentile of average expression below which the lipids
must be discarded (to get rid of low expression noise). Defaults to 90.</p></td>
          <td>
                <code>90</code>
          </td>
        </tr>
        <tr>
          <td><code>brain_1</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the brain 1 data is used. Else, the brain 2 data is used.
Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="plotly.graph_objects">go</span>.<span title="plotly.graph_objects.Figure">Figure</span></code>
          </td>
          <td><p>a Plotly Clustergram figure clustering and comparing the expression of all
the MAIA-transformed lipids in the dataset in the selected regions.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_clustergram_figure</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">set_progress</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="p">,</span>
    <span class="n">l_selected_regions</span><span class="p">,</span>
    <span class="n">percentile</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes a Plotly Clustergram figure, allowing to cluster and compare the</span>
<span class="sd">    expression of all the MAIA-transformed lipids in the dataset in the selected regions.</span>

<span class="sd">    Args:</span>
<span class="sd">        set_progress: Used as part of the Plotly long callbacks, to indicate the progress of the</span>
<span class="sd">            computation in the corresponding progress bar.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">        l_selected_regions (list(int), optional): A list containing the identifiers of the brain</span>
<span class="sd">            regions (at the very bottom of the hierarchy) whose border must be annotated.</span>
<span class="sd">        percentile (int, optional): The percentile of average expression below which the lipids</span>
<span class="sd">            must be discarded (to get rid of low expression noise). Defaults to 90.</span>
<span class="sd">        brain_1 (bool): If True, the brain 1 data is used. Else, the brain 2 data is used.</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (go.Figure): a Plotly Clustergram figure clustering and comparing the expression of all</span>
<span class="sd">            the MAIA-transformed lipids in the dataset in the selected regions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing clustergram figure&quot;</span><span class="p">)</span>

    <span class="c1"># Memoize result as it&#39;s called everytime a filtering is done</span>
    <span class="nd">@cache_flask</span><span class="o">.</span><span class="n">memoize</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">return_df_avg_lipids</span><span class="p">(</span><span class="n">l_selected_regions</span><span class="p">):</span>
        <span class="n">dic_avg_lipids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">l_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="n">l_slices</span><span class="p">:</span>
            <span class="c1"># Display progress every 10 slices</span>
            <span class="k">if</span> <span class="n">slice_index</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">set_progress</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">slice_index</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_slices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
                        <span class="s2">&quot;Loading slice n°&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">l_spectra</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">l_selected_regions</span><span class="p">:</span>
                <span class="n">long_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">dic_acronym_name</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">dic_existing_masks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">dic_existing_masks</span><span class="p">[</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">grah_scattergl_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">get_projected_mask_and_spectrum</span><span class="p">(</span>
                            <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">long_region</span><span class="p">,</span> <span class="n">MAIA_correction</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">l_spectra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grah_scattergl_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l_spectra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;The masks have not been precomputed. Please precompute them before&quot;</span>
                        <span class="s2">&quot; running this function.&quot;</span>
                    <span class="p">)</span>
            <span class="n">ll_idx_labels</span> <span class="o">=</span> <span class="n">global_lipid_index_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l_spectra</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing dictionnary for averaging slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">))</span>

            <span class="c1"># Compute average expression for each lipid and each selection</span>
            <span class="n">set_lipids_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">ll_lipids_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ll_avg_intensity</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n_sel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_spectra</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">l_idx_labels</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_spectra</span><span class="p">,</span> <span class="n">ll_idx_labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">array_intensity_with_lipids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">array_idx_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_idx_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

                    <span class="n">l_lipids_idx</span><span class="p">,</span> <span class="n">l_avg_intensity</span> <span class="o">=</span> <span class="n">compute_avg_intensity_per_lipid</span><span class="p">(</span>
                        <span class="n">array_intensity_with_lipids</span><span class="p">,</span> <span class="n">array_idx_labels</span>
                    <span class="p">)</span>
                    <span class="n">set_lipids_idx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">l_lipids_idx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l_lipids_idx</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">l_avg_intensity</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">ll_lipids_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_lipids_idx</span><span class="p">)</span>
                <span class="n">ll_avg_intensity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_avg_intensity</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">l_lipids</span><span class="p">,</span> <span class="n">l_avg_intensity</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">ll_lipids_idx</span><span class="p">,</span> <span class="n">ll_avg_intensity</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">l_lipids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">lipid</span><span class="p">,</span> <span class="n">intensity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_lipids</span><span class="p">,</span> <span class="n">l_avg_intensity</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">lipid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dic_avg_lipids</span><span class="p">:</span>
                            <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sel</span><span class="p">):</span>
                                <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all lipid values across slices&quot;</span><span class="p">)</span>

        <span class="c1"># Average intensity per slice</span>
        <span class="k">for</span> <span class="n">lipid</span> <span class="ow">in</span> <span class="n">dic_avg_lipids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sel</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dic_avg_lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="n">dic_avg_lipids</span><span class="p">,</span>
            <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">l_selected_regions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sel</span><span class="p">)],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df_avg_intensity_lipids</span>

    <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">return_df_avg_lipids</span><span class="p">(</span><span class="n">l_selected_regions</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging done for all slices&quot;</span><span class="p">)</span>
    <span class="n">set_progress</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;Loading data&quot;</span><span class="p">))</span>

    <span class="c1"># Exclude very lowly expressed lipids</span>
    <span class="n">df_min_expression</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="p">[</span>
        <span class="n">df_min_expression</span> <span class="o">&gt;</span> <span class="n">df_min_expression</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">percentile</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_selected_regions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df_avg_intensity_lipids</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),</span> <span class="p">:</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">l_selected_regions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lowly expressed lipids excluded&quot;</span><span class="p">)</span>

    <span class="c1"># Replace idx_lipids by actual name</span>
    <span class="n">df_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span>
    <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">idx</span><span class="p">:</span> <span class="n">df_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
        <span class="o">+</span> <span class="n">df_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
        <span class="o">+</span> <span class="n">df_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;cation&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lipid indexes replaced by names&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing plot&quot;</span><span class="p">)</span>
    <span class="c1"># Plot</span>
    <span class="n">fig_heatmap_lipids</span> <span class="o">=</span> <span class="n">Clustergram</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">column_labels</span><span class="o">=</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">row_labels</span><span class="o">=</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">hidden_labels</span><span class="o">=</span><span class="s2">&quot;row&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_avg_intensity_lipids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">color_map</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">display_ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Set background color to zero</span>
    <span class="n">fig_heatmap_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
    <span class="n">fig_heatmap_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig_heatmap_lipids</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

    <span class="n">set_progress</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;Returning figure&quot;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning figure&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig_heatmap_lipids</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_figure_basic_image" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_figure_basic_image</span><span class="p">(</span><span class="n">type_figure</span><span class="p">,</span> <span class="n">index_image</span><span class="p">,</span> <span class="n">plot_atlas_contours</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_contours</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function computes and returns a figure representing slices from the maldi_data
acquisition (TIC) or the corresponding image from the atlas. The data is read directly from
the array computed in self.compute_array_basic_images().</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>type_figure</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>To be chosen among "original_data", "warped_data",
"projection_corrected", "atlas". Depending on the chosen type, the final figure will
correspond to either the original images ("original_data"), the warped and upscaled
images ("warped_data"), the warped and upscaled images, whose pixels outside of
annotations regions have been zero-ed out ("projection_corrected"), or the images
from the Allen Brain atlas projected onto the same plane as the corresponding slice
from the MALDI data ("atlas").</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>index_image</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index of the requested slice image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>plot_atlas_contours</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the atlas contours annotation is
superimposed with the slice image. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>only_contours</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, only output the atlas contours annotation. All
the other arugments but plot_atlas_contours (which must be True) get ignored.
Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>draw</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the figure can be drawed on (used for region selection,
in page region_analysis). Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="plotly.graph_objects">go</span>.<span title="plotly.graph_objects.Figure">Figure</span></code>
          </td>
          <td><p>A Plotly figure representing the requested slice image of the requested
type.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_figure_basic_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">type_figure</span><span class="p">,</span> <span class="n">index_image</span><span class="p">,</span> <span class="n">plot_atlas_contours</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_contours</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes and returns a figure representing slices from the maldi_data</span>
<span class="sd">    acquisition (TIC) or the corresponding image from the atlas. The data is read directly from</span>
<span class="sd">    the array computed in self.compute_array_basic_images().</span>

<span class="sd">    Args:</span>
<span class="sd">        type_figure (str): To be chosen among &quot;original_data&quot;, &quot;warped_data&quot;,</span>
<span class="sd">            &quot;projection_corrected&quot;, &quot;atlas&quot;. Depending on the chosen type, the final figure will</span>
<span class="sd">            correspond to either the original images (&quot;original_data&quot;), the warped and upscaled</span>
<span class="sd">            images (&quot;warped_data&quot;), the warped and upscaled images, whose pixels outside of</span>
<span class="sd">            annotations regions have been zero-ed out (&quot;projection_corrected&quot;), or the images</span>
<span class="sd">            from the Allen Brain atlas projected onto the same plane as the corresponding slice</span>
<span class="sd">            from the MALDI data (&quot;atlas&quot;).</span>
<span class="sd">        index_image (int): Index of the requested slice image.</span>
<span class="sd">        plot_atlas_contours (bool, optional): If True, the atlas contours annotation is</span>
<span class="sd">            superimposed with the slice image. Defaults to True.</span>
<span class="sd">        only_contours (bool, optional): If True, only output the atlas contours annotation. All</span>
<span class="sd">            the other arugments but plot_atlas_contours (which must be True) get ignored.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        draw (bool, optional): If True, the figure can be drawed on (used for region selection,</span>
<span class="sd">            in page region_analysis). Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (go.Figure): A Plotly figure representing the requested slice image of the requested</span>
<span class="sd">            type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If only boundaries is requested, force the computation of atlas contours</span>
    <span class="k">if</span> <span class="n">only_contours</span><span class="p">:</span>
        <span class="n">plot_atlas_contours</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get array of images</span>
        <span class="n">array_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;array_basic_images&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_array_basic_images</span><span class="p">,</span>
            <span class="n">type_figure</span><span class="o">=</span><span class="n">type_figure</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Get image at specified index</span>
        <span class="n">array_image</span> <span class="o">=</span> <span class="n">array_images</span><span class="p">[</span><span class="n">index_image</span><span class="p">]</span>

    <span class="c1"># Add the contours if requested</span>
    <span class="k">if</span> <span class="n">plot_atlas_contours</span><span class="p">:</span>
        <span class="n">array_image_atlas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">list_projected_atlas_borders_arrays</span><span class="p">[</span><span class="n">index_image</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">array_image_atlas</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="c1"># Compute image from our data if not only the atlas annotations are requested</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">only_contours</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">convert_image_to_base64</span><span class="p">(</span>
                    <span class="n">array_image</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="n">array_image_atlas</span><span class="p">,</span> <span class="n">transparent_zeros</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">),</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Add the labels only if it&#39;s not a simple annotation illustration</span>
        <span class="c1"># fig.update_xaxes(</span>
        <span class="c1">#     title_text=self._atlas.bg_atlas.space.axis_labels[0][1], title_standoff=0</span>
        <span class="c1"># )</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">convert_image_to_base64</span><span class="p">(</span>
                    <span class="n">array_image_atlas</span><span class="p">,</span>
                    <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span>
                    <span class="n">decrease_resolution_factor</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Improve layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
        <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">dragmode</span><span class="o">=</span><span class="s2">&quot;drawclosedpath&quot;</span><span class="p">,</span>
            <span class="n">newshape</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">fillcolor</span><span class="o">=</span><span class="n">l_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_figure_slices_3D" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_figure_slices_3D</span><span class="p">(</span><span class="n">reduce_resolution_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">brain</span><span class="o">=</span><span class="s1">&#39;brain_1&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function computes and returns a figure representing the slices from the maldi data
in 3D.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>reduce_resolution_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Divides (reduce) the initial resolution of the
data. Needed as the resulting figure can be very heavy. Defaults to 20.</p></td>
          <td>
                <code>20</code>
          </td>
        </tr>
        <tr>
          <td><code>brain</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the brain to be used. Defaults to 'brain_1'.</p></td>
          <td>
                <code>&#39;brain_1&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="plotly.graph_objects">go</span>.<span title="plotly.graph_objects.Figure">Figure</span></code>
          </td>
          <td><p>A Plotly figure representing the slices from the MALDI acquisitions in 3D.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_figure_slices_3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reduce_resolution_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">brain</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes and returns a figure representing the slices from the maldi data</span>
<span class="sd">    in 3D.</span>

<span class="sd">    Args:</span>
<span class="sd">        reduce_resolution_factor (int, optional): Divides (reduce) the initial resolution of the</span>
<span class="sd">            data. Needed as the resulting figure can be very heavy. Defaults to 20.</span>
<span class="sd">        brain (str, optional): Name of the brain to be used. Defaults to &#39;brain_1&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (go.Figure): A Plotly figure representing the slices from the MALDI acquisitions in 3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get transform parameters (a,u,v) for each slice</span>
    <span class="n">l_transform_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;atlas/atlas_objects&quot;</span><span class="p">,</span>
        <span class="s2">&quot;l_transform_parameters&quot;</span><span class="p">,</span>
        <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">compute_projection_parameters</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Reduce resolution of the slices</span>
    <span class="n">new_dims</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_coordinates_warped_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">original_length</span><span class="p">,</span> <span class="n">new_length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_corrected</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="n">n_slices</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">d1</span> <span class="o">/</span> <span class="n">reduce_resolution_factor</span><span class="p">)),</span>
            <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">d2</span> <span class="o">/</span> <span class="n">reduce_resolution_factor</span><span class="p">)),</span>
        <span class="p">),</span>
    <span class="p">):</span>
        <span class="n">new_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">original_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_length</span><span class="p">))</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">new_dims</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
    <span class="n">array_projection_small</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_corrected</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>

    <span class="c1"># Build Figure, with several frames as it will be slidable</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">frames</span><span class="o">=</span><span class="p">[</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_surface</span><span class="p">(</span>
                    <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">l_transform_parameters</span><span class="p">,</span>
                    <span class="n">array_projection_small</span><span class="p">,</span>
                    <span class="n">reduce_resolution_factor</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">brain</span><span class="p">))</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_surface</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">brain</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">l_transform_parameters</span><span class="p">,</span>
            <span class="n">array_projection_small</span><span class="p">,</span>
            <span class="n">reduce_resolution_factor</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Add a slider</span>
    <span class="k">def</span> <span class="nf">frame_args</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">},</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;immediate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fromcurrent&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transition&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span> <span class="s2">&quot;easing&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">},</span>
        <span class="p">}</span>

    <span class="n">sliders</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
            <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">frame_args</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;animate&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">&quot;currentvalue&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># Layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">aspectratio</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>
                <span class="n">autorange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">],</span>
                <span class="n">autorange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>
                <span class="n">autorange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
        <span class="n">sliders</span><span class="o">=</span><span class="n">sliders</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># No display of tick labels as they&#39;re wrong anyway</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_heatmap_lipid_genes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_heatmap_lipid_genes</span><span class="p">(</span><span class="n">lipid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_frame</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">set_progress</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This functions computes a heatmap representing, on the left side, the expression of a
given lipid in the (low-resolution, interpolated) MALDI data, and the right side, the
expressions of the selected genes (in l_genes) in the scRNAseq experiments from the
molecular atlas data.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lipid</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the lipid to be displayed. If None, the most expressed lipid
will be displayed. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>l_genes</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The list of gene names to be displayed. If None, the three most
expressed genes will be displayed. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>initial_frame</code></td>
          <td>
                <code>  (int</code>
          </td>
          <td><p>The frame on which the slider is initialized.</p></td>
          <td>
                <code>5</code>
          </td>
        </tr>
        <tr>
          <td><code>brain_1</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the heatmap will be computed with the data coming
from the first brain. Else, from the 2nd brain. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>set_progress</code></td>
          <td>
          </td>
          <td><p>Used as part of the Plotly long callbacks, to indicate the progress of the
computation in the corresponding progress bar.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Plotly.<span title="Plotly.Figure">Figure</span></code>
          </td>
          <td><p>A Plotly Figure containing a go.Heatmap object representing the
expression of the selected lipid and genes.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_heatmap_lipid_genes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">lipid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">l_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">initial_frame</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">brain_1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">set_progress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions computes a heatmap representing, on the left side, the expression of a</span>
<span class="sd">    given lipid in the (low-resolution, interpolated) MALDI data, and the right side, the</span>
<span class="sd">    expressions of the selected genes (in l_genes) in the scRNAseq experiments from the</span>
<span class="sd">    molecular atlas data.</span>

<span class="sd">    Args:</span>
<span class="sd">        lipid (str): The name of the lipid to be displayed. If None, the most expressed lipid</span>
<span class="sd">            will be displayed. Defaults to None.</span>
<span class="sd">        l_genes (list): The list of gene names to be displayed. If None, the three most</span>
<span class="sd">            expressed genes will be displayed. Defaults to None.</span>
<span class="sd">        initial_frame   (int, optional): The frame on which the slider is initialized.</span>
<span class="sd">        brain_1 (bool, optional): If True, the heatmap will be computed with the data coming</span>
<span class="sd">            from the first brain. Else, from the 2nd brain. Defaults to False.</span>
<span class="sd">        set_progress: Used as part of the Plotly long callbacks, to indicate the progress of the</span>
<span class="sd">            computation in the corresponding progress bar.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Plotly.Figure): A Plotly Figure containing a go.Heatmap object representing the</span>
<span class="sd">            expression of the selected lipid and genes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing heatmap for scRNAseq experiments&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Loading data&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_1</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_1</span>
        <span class="n">name_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_1</span>
        <span class="n">name_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_1</span>
        <span class="n">array_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_1</span>
        <span class="n">array_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_genes_brain_1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_coef_brain_2</span>
        <span class="n">name_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_genes_brain_2</span>
        <span class="n">name_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">l_name_lipids_brain_2</span>
        <span class="n">array_lipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_lipids_brain_2</span>
        <span class="n">array_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">array_exp_genes_brain_2</span>

    <span class="c1"># Get the most expressed lipid and genes if not provided</span>
    <span class="k">if</span> <span class="n">lipid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l_genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array_lipids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expression</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">]</span>
        <span class="n">lipids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>
        <span class="n">y_sorted</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index_sorted</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">index_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_sorted</span> <span class="o">=</span> <span class="n">y_sorted</span><span class="p">[:,</span> <span class="n">index_sorted</span><span class="p">]</span>
        <span class="n">genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">name_genes</span><span class="p">)[</span><span class="n">index_sorted</span><span class="p">]</span>
        <span class="n">lipid</span> <span class="o">=</span> <span class="n">lipids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l_genes</span> <span class="o">=</span> <span class="n">genes</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Get coordinates</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">xmol</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">ymol</span>
    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">zmol</span>

    <span class="c1"># Get idx lipid and genes</span>
    <span class="k">if</span> <span class="n">lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">idx_lipid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">name_lipids</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lipid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx_lipid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">l_idx_genes_with_None</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">name_genes</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span> <span class="k">if</span> <span class="n">gene</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">l_genes</span>
    <span class="p">]</span>
    <span class="n">l_idx_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_gene</span> <span class="k">for</span> <span class="n">idx_gene</span> <span class="ow">in</span> <span class="n">l_idx_genes_with_None</span> <span class="k">if</span> <span class="n">idx_gene</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># Build grids on which the data will be interpolated</span>
    <span class="n">x_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">y_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">z_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_domain</span><span class="p">,</span> <span class="n">y_domain</span><span class="p">,</span> <span class="n">z_domain</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;Preparing interpolation&quot;</span><span class="p">))</span>

    <span class="c1"># Build data from interpolation since sampling is irregular</span>
    <span class="k">if</span> <span class="n">idx_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">grid_lipid</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">array_lipids</span><span class="p">[:,</span> <span class="n">idx_lipid</span><span class="p">],</span>
            <span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid_lipid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_idx_genes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">grid_genes</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">array_genes</span><span class="p">[:,</span> <span class="n">l_idx_genes</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_idx_genes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">grid_genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">griddata</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="n">array_genes</span><span class="p">[:,</span> <span class="n">idx_genes</span><span class="p">],</span>
                        <span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">idx_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx_genes</span> <span class="ow">in</span> <span class="n">l_idx_genes_with_None</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid_genes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_progress</span><span class="p">((</span><span class="mi">75</span><span class="p">,</span> <span class="s2">&quot;Finished interpolation... Building figure&quot;</span><span class="p">))</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Build Figure, with several frames as it will be slidable</span>
    <span class="k">if</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_lipid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_heatmap</span><span class="p">(</span>
                <span class="n">z</span><span class="o">=</span><span class="n">grid_lipid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                <span class="n">visible</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">initial_frame</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_heatmap</span><span class="p">(</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">grid_genes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                    <span class="n">visible</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">initial_frame</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">grid_genes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">visible</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">initial_frame</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
    <span class="k">if</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_lipid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;restyle&quot;</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;visible&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">)],</span>
                <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="n">grid_lipid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">grid_lipid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="n">sliders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">active</span><span class="o">=</span><span class="n">initial_frame</span><span class="p">,</span>
                <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
                <span class="n">pad</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                <span class="nb">len</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">currentvalue</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Comparison between lipid and gene expression&quot;</span><span class="p">,</span>
            <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">title_y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
            <span class="n">sliders</span><span class="o">=</span><span class="n">sliders</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># No display of tick labels as they&#39;re wrong anyway</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.)&quot;</span><span class="p">,</span>
            <span class="n">yaxis_scaleanchor</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Reverse y axis if Image has been used</span>
        <span class="k">if</span> <span class="n">grid_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_genes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Remove tick labels</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide x axis ticks</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide y axis ticks</span>

        <span class="k">if</span> <span class="n">set_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_progress</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;Returning figure&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_heatmap_per_lipid_selection" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_heatmap_per_lipid_selection</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function is very similar to compute_heatmap_per_mz, but it takes a list of lipid
boundaries, possibly along with lipid names, instead of just two boundaries. It returns a
heatmap of the sum of expression of the requested lipids in the slice.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ll_t_bounds</code></td>
          <td>
                <code>list(list(tuple</code>
          </td>
          <td><p>A list of lists of lipid boundaries (tuples). The first
list is used to separate image channels (although this is not used in the function).
The second list is used to separate lipid.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>normalize</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, and the lipid has been MAIA transformed (and is
provided with the parameter lipid_name) and apply_transform is True, the resulting
array is normalized according to a factor computed across all slice. If MAIA has not
been applied to the current selection or apply_transform is False, it is normalized
according to the 99th percentile. Else, it is not normalized. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>projected_image</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the pixels of the original acquisition get
matched to a higher-resolution, warped space. The gaps are filled by duplicating the
most appropriate pixels (see dosctring of Atlas.project_image() for more
information). Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>apply_transform</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, applies the MAIA transform (if possible) to
the current selection, given that the parameter normalize is also True, and that
lipid_name corresponds to an existing lipid. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>ll_lipid_names</code></td>
          <td>
                <code>list(list(int))</code>
          </td>
          <td><p>List of list of lipid names that must be
MAIA-transformed, if apply_transform and normalize are True. The first list is used
to separate channels, when applicable. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>return_base64_string</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the base64 string of the image is
returned directly, before any figure building. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Depending on the value return_base64_string, may either return a base64 string, or
a Plotly Figure.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_heatmap_per_lipid_selection</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">ll_t_bounds</span><span class="p">,</span>
    <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is very similar to compute_heatmap_per_mz, but it takes a list of lipid</span>
<span class="sd">    boundaries, possibly along with lipid names, instead of just two boundaries. It returns a</span>
<span class="sd">    heatmap of the sum of expression of the requested lipids in the slice.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): The index of the requested slice.</span>
<span class="sd">        ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">            list is used to separate image channels (although this is not used in the function).</span>
<span class="sd">            The second list is used to separate lipid.</span>
<span class="sd">        normalize (bool, optional): If True, and the lipid has been MAIA transformed (and is</span>
<span class="sd">            provided with the parameter lipid_name) and apply_transform is True, the resulting</span>
<span class="sd">            array is normalized according to a factor computed across all slice. If MAIA has not</span>
<span class="sd">            been applied to the current selection or apply_transform is False, it is normalized</span>
<span class="sd">            according to the 99th percentile. Else, it is not normalized. Defaults to True.</span>
<span class="sd">        projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">            matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">            most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">            information). Defaults to True.</span>
<span class="sd">        apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">            the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">            lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">        ll_lipid_names (list(list(int)), optional): List of list of lipid names that must be</span>
<span class="sd">            MAIA-transformed, if apply_transform and normalize are True. The first list is used</span>
<span class="sd">            to separate channels, when applicable. Defaults to None.</span>
<span class="sd">        return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">            returned directly, before any figure building. Defaults to False.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Depending on the value return_base64_string, may either return a base64 string, or</span>
<span class="sd">            a Plotly Figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute heatmap per lipid selection&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">))</span>

    <span class="c1"># Start from empty image and add selected lipids</span>
    <span class="c1"># * Caution: array must be int, float gets badly converted afterwards</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># Build empty lipid names if not provided</span>
    <span class="k">if</span> <span class="n">ll_lipid_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ll_lipid_names</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">l_t_bounds</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span><span class="p">]</span>

    <span class="c1"># Loop over channels</span>
    <span class="k">for</span> <span class="n">l_t_bounds</span><span class="p">,</span> <span class="n">l_lipid_names</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">ll_lipid_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">l_t_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Loop over lipids</span>
            <span class="k">for</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">lipid_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_t_bounds</span><span class="p">,</span> <span class="n">l_lipid_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">lb_mz</span><span class="p">,</span> <span class="n">hb_mz</span><span class="p">)</span> <span class="o">=</span> <span class="n">boundaries</span>

                    <span class="c1"># Cmpute expression image per lipid</span>
                    <span class="n">image_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_image_per_lipid</span><span class="p">(</span>
                        <span class="n">slice_index</span><span class="p">,</span>
                        <span class="n">lb_mz</span><span class="p">,</span>
                        <span class="n">hb_mz</span><span class="p">,</span>
                        <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
                        <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
                        <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
                        <span class="n">lipid_name</span><span class="o">=</span><span class="n">lipid_name</span><span class="p">,</span>
                        <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">image</span> <span class="o">+=</span> <span class="n">image_temp</span>

    <span class="c1"># Compute corresponding figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lipid_heatmap_from_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="n">return_base64_string</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_heatmap_per_mz" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_heatmap_per_mz</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">lb_mz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hb_mz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function takes two boundaries and a slice index, and returns a heatmap of the lipid
expressed in the slice whose m/z is between the two boundaries.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>lb_mz</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The lower m/z boundary. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>hb_mz</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The higher m/z boundary. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>draw</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the user will have the possibility to draw on the
resulting Plotly Figure. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>projected_image</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the pixels of the original acquisition get
matched to a higher-resolution, warped space. The gaps are filled by duplicating the
most appropriate pixels (see dosctring of Atlas.project_image() for more
information). Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>return_base64_string</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the base64 string of the image is
returned directly, before any figure building. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Depending on the value return_base64_string, may either return a base64 string, or
a Plotly Figure.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_heatmap_per_mz</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">lb_mz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hb_mz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function takes two boundaries and a slice index, and returns a heatmap of the lipid</span>
<span class="sd">    expressed in the slice whose m/z is between the two boundaries.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): The index of the requested slice.</span>
<span class="sd">        lb_mz (float, optional): The lower m/z boundary. Defaults to None.</span>
<span class="sd">        hb_mz (float, optional): The higher m/z boundary. Defaults to None.</span>
<span class="sd">        draw (bool, optional): If True, the user will have the possibility to draw on the</span>
<span class="sd">            resulting Plotly Figure. Defaults to False.</span>
<span class="sd">        projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">            matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">            most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">            information). Defaults to True.</span>
<span class="sd">        return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">            returned directly, before any figure building. Defaults to False.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Depending on the value return_base64_string, may either return a base64 string, or</span>
<span class="sd">            a Plotly Figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting figure computation, from mz boundaries&quot;</span><span class="p">)</span>

    <span class="c1"># Upper bound lower than the lowest m/z value and higher that the highest m/z value</span>
    <span class="k">if</span> <span class="n">lb_mz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lb_mz</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="k">if</span> <span class="n">hb_mz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hb_mz</span> <span class="o">=</span> <span class="mi">1800</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting image array&quot;</span><span class="p">)</span>

    <span class="c1"># Compute image with given bounds</span>
    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_image_per_lipid</span><span class="p">(</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">lb_mz</span><span class="p">,</span>
        <span class="n">hb_mz</span><span class="p">,</span>
        <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Compute corresponding figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lipid_heatmap_from_image</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="n">return_base64_string</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_image_per_lipid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_image_per_lipid</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">lb_mz</span><span class="p">,</span> <span class="n">hb_mz</span><span class="p">,</span> <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lipid_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function allows to query the MALDI data to extract an image in the form of a Numpy
array representing the intensity of the lipid peaking between the values lb_mz and hb_mz in
the spectral data, for the slice slice_index.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>lb_mz</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Lower boundary for the spectral data to query.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>hb_mz</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>Higher boundary for the spectral data to query.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>RGB_format</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the values in the array are between 0 and 255,
given that the data has been normalized beforehand. Else, between 0 and 1. This
parameter only makes sense if the data has been normalized beforehand. Defaults to
True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>normalize</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, and the lipid has been MAIA transformed (and is
provided with the parameter lipid_name) and apply_transform is True, the resulting
array is normalized according to a factor computed across all slice. If MAIA has not
been applied to the current selection or apply_transform is False, it is normalized
according to the 99th percentile. Else, it is not normalized. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>log</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the resulting array is log-transformed. This is useful in
case of low expression. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>projected_image</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the pixels of the original acquisition get
matched to a higher-resolution, warped space. The gaps are filled by duplicating the
most appropriate pixels (see dosctring of Atlas.project_image() for more
information). Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>apply_transform</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, applies the MAIA transform (if possible) to
the current selection, given that the parameter normalize is also True, and that
lipid_name corresponds to an existing lipid. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>lipid_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the lipid that must be MAIA-transformed, if
apply_transform and normalize are True. Defaults to "".</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>An image (in the form of a numpy array) representing the intensity of the
lipid peaking between the values lb_mz and hb_mz in the spectral data, for the slice
slice_index.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_image_per_lipid</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">lb_mz</span><span class="p">,</span>
    <span class="n">hb_mz</span><span class="p">,</span>
    <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">lipid_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function allows to query the MALDI data to extract an image in the form of a Numpy</span>
<span class="sd">    array representing the intensity of the lipid peaking between the values lb_mz and hb_mz in</span>
<span class="sd">    the spectral data, for the slice slice_index.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): Index of the requested slice.</span>
<span class="sd">        lb_mz (float): Lower boundary for the spectral data to query.</span>
<span class="sd">        hb_mz (float): Higher boundary for the spectral data to query.</span>
<span class="sd">        RGB_format (bool, optional): If True, the values in the array are between 0 and 255,</span>
<span class="sd">            given that the data has been normalized beforehand. Else, between 0 and 1. This</span>
<span class="sd">            parameter only makes sense if the data has been normalized beforehand. Defaults to</span>
<span class="sd">            True.</span>
<span class="sd">        normalize (bool, optional): If True, and the lipid has been MAIA transformed (and is</span>
<span class="sd">            provided with the parameter lipid_name) and apply_transform is True, the resulting</span>
<span class="sd">            array is normalized according to a factor computed across all slice. If MAIA has not</span>
<span class="sd">            been applied to the current selection or apply_transform is False, it is normalized</span>
<span class="sd">            according to the 99th percentile. Else, it is not normalized. Defaults to True.</span>
<span class="sd">        log (bool, optional): If True, the resulting array is log-transformed. This is useful in</span>
<span class="sd">            case of low expression. Defaults to False.</span>
<span class="sd">        projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">            matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">            most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">            information). Defaults to True.</span>
<span class="sd">        apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">            the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">            lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">        lipid_name (str, optional): Name of the lipid that must be MAIA-transformed, if</span>
<span class="sd">            apply_transform and normalize are True. Defaults to &quot;&quot;.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): An image (in the form of a numpy array) representing the intensity of the</span>
<span class="sd">            lipid peaking between the values lb_mz and hb_mz in the spectral data, for the slice</span>
<span class="sd">            slice_index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering compute_image_per_lipid&quot;</span><span class="p">)</span>

    <span class="c1"># Get image from raw mass spec data</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
        <span class="n">compute_image_using_index_and_image_lookup</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">lb_mz</span><span class="p">,</span>
        <span class="n">hb_mz</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_spectra</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_pixels</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_mz</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_cumulated_lookup_mz_image</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_divider_lookup</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_peaks_transformed_lipids</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_corrective_factors</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Log-transform the image if requested</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># In case of bug, return None</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Normalize the image if requested</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="c1"># Normalize across slice if the lipid has been MAIA transformed</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">lipid_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">is_brain_1</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_normalization_factors</span> <span class="ow">and</span> <span class="n">apply_transform</span><span class="p">:</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_normalization_factors</span><span class="p">[</span>
                <span class="p">(</span><span class="n">lipid_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">is_brain_1</span><span class="p">(</span><span class="n">slice_index</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Normalization made with respect to percentile computed across all slices.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normalize by 99 percentile</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">99.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">perc</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

    <span class="c1"># Turn to RGB format if requested</span>
    <span class="k">if</span> <span class="n">RGB_format</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">*=</span> <span class="mi">255</span>

    <span class="c1"># Change dtype if normalized and RGB to save space</span>
    <span class="k">if</span> <span class="n">normalize</span> <span class="ow">and</span> <span class="n">RGB_format</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># Project image into cleaned and higher resolution version</span>
    <span class="k">if</span> <span class="n">projected_image</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">project_image</span><span class="p">(</span>
            <span class="n">slice_index</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">array_projection_correspondence_corrected</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_l_array_2D" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_l_array_2D</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function is used to get the list of expression per slice for all slices for the
computation of the 3D brain volume.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ll_t_bounds</code></td>
          <td>
                <code>list(list(tuple</code>
          </td>
          <td><p>A list of lists of lipid boundaries (tuples). The first
list is used to separate image channels. The second list is used to separate lipid.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>normalize_independently</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, each lipid intensity array is
normalized independently, regardless of other lipids or channel used. Defaults to
True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>high_res</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the returned list of arrays correspond to the
warped/upscaled data. Defaults to False as this is a very heavy plot.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>brain_1</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the returned list of arrays correspond to the
brain 1 data. Else, to the brain 2 data. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list(<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>)</code>
          </td>
          <td><p>A list of numpy arrays representing the expression of the requested
lipids (through ll_t_bounds) for each slice.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_l_array_2D</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ll_t_bounds</span><span class="p">,</span>
    <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">high_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to get the list of expression per slice for all slices for the</span>
<span class="sd">    computation of the 3D brain volume.</span>

<span class="sd">    Args:</span>
<span class="sd">        ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">            list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">        normalize_independently (bool, optional): If True, each lipid intensity array is</span>
<span class="sd">            normalized independently, regardless of other lipids or channel used. Defaults to</span>
<span class="sd">            True.</span>
<span class="sd">        high_res (bool, optional): If True, the returned list of arrays correspond to the</span>
<span class="sd">            warped/upscaled data. Defaults to False as this is a very heavy plot.</span>
<span class="sd">        brain_1 (bool, optional): If True, the returned list of arrays correspond to the</span>
<span class="sd">            brain 1 data. Else, to the brain 2 data. Defaults to True.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (list(np.ndarray)): A list of numpy arrays representing the expression of the requested</span>
<span class="sd">            lipids (through ll_t_bounds) for each slice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l_array_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Correct the indices for the potentially unused slices from brain 1</span>
    <span class="k">if</span> <span class="n">brain_1</span><span class="p">:</span>
        <span class="n">slice_index_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slice_index_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span><span class="p">))</span>

    <span class="c1"># Loop over slices and compute the expression of the requested lipids</span>
    <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">ll_t_bounds</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="c1"># Get the data as an expression image per lipid</span>
            <span class="n">array_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rgb_array_per_lipid_selection</span><span class="p">(</span>
                <span class="n">slice_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">slice_index_offset</span><span class="p">,</span>
                <span class="n">ll_t_bounds</span><span class="p">[</span><span class="n">slice_index</span><span class="p">],</span>
                <span class="n">normalize_independently</span><span class="o">=</span><span class="n">normalize_independently</span><span class="p">,</span>
                <span class="n">projected_image</span><span class="o">=</span><span class="n">high_res</span><span class="p">,</span>
                <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">apply_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Sum array colors (i.e. lipids)</span>
            <span class="n">array_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">array_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Append data to l_array_data</span>
        <span class="n">l_array_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">))</span>  <span class="c1"># float16 to gain space</span>

    <span class="k">return</span> <span class="n">l_array_data</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_normalization_factor_across_slices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_normalization_factor_across_slices</span><span class="p">(</span><span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function computes a dictionnary of normalization factors (used for MAIA-transformed
lipids) across all slices (99th percentile of expression).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionnary associating, for each MAIA-transformed lipid name, the 99th
percentile of the intensity across all slices.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_normalization_factor_across_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes a dictionnary of normalization factors (used for MAIA-transformed</span>
<span class="sd">    lipids) across all slices (99th percentile of expression).</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (dict): A dictionnary associating, for each MAIA-transformed lipid name, the 99th</span>
<span class="sd">            percentile of the intensity across all slices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Compute normalization factor across slices for MAIA transformed lipids...&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; It may takes a while&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Dictionnnary that will contain the percentile across all slices of a given brain</span>
    <span class="n">dic_max_percentile</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Function to compute the percentile across all slices</span>
    <span class="k">def</span> <span class="nf">_compute_percentile_across_slices</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">brain_1</span><span class="p">):</span>
        <span class="n">max_perc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lipid_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span>
            <span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span>
        <span class="p">):</span>
            <span class="c1"># Find lipid location</span>
            <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span>
                <span class="o">.</span><span class="n">index</span><span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">structure</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slice_index</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;cation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cation</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c1"># If several lipids correspond to the selection, we have a problem...</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">l_lipid_loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># get final lipid name</span>
                <span class="n">lipid_string</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">structure</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">cation</span>

                <span class="c1"># get lipid bounds</span>
                <span class="n">lb_mz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">])</span>
                <span class="n">hb_mz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">])</span>

                <span class="c1"># Get corresponding image</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
                    <span class="n">compute_image_using_index_and_image_lookup</span><span class="p">,</span>
                    <span class="n">cache_flask</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                    <span class="n">slice_index</span><span class="p">,</span>
                    <span class="n">lb_mz</span><span class="p">,</span>
                    <span class="n">hb_mz</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_spectra</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_pixels</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_mz</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_cumulated_lookup_mz_image</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_divider_lookup</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_peaks_transformed_lipids</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_corrective_factors</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                    <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Check 99th percentile for normalization</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">99.0</span><span class="p">)</span>

                <span class="c1"># perc must be quite small in theory... otherwise it&#39;s a bug</span>
                <span class="k">if</span> <span class="n">perc</span> <span class="o">&gt;</span> <span class="n">max_perc</span><span class="p">:</span>  <span class="c1"># and perc&lt;1:</span>
                    <span class="n">max_perc</span> <span class="o">=</span> <span class="n">perc</span>
        <span class="k">return</span> <span class="n">max_perc</span><span class="p">,</span> <span class="n">lipid_string</span>

    <span class="c1"># Simulate a click on all MAIA transformed lipids</span>
    <span class="k">for</span> <span class="n">brain_1</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">index</span><span class="p">,</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">mz</span><span class="p">),</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations_MAIA_transformed_lipids</span><span class="p">(</span><span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">max_perc</span><span class="p">,</span> <span class="n">lipid_string</span> <span class="o">=</span> <span class="n">_compute_percentile_across_slices</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">brain_1</span>
            <span class="p">)</span>
            <span class="c1"># Store max percentile across slices</span>
            <span class="n">dic_max_percentile</span><span class="p">[(</span><span class="n">lipid_string</span><span class="p">,</span> <span class="n">brain_1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">max_perc</span>

    <span class="k">return</span> <span class="n">dic_max_percentile</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_rgb_array_per_lipid_selection" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_rgb_array_per_lipid_selection</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function computes a numpy RGB array (each pixel has 3 intensity values) of
expression of the requested lipids (those whose m/z values are in ll_t_bounds) in the slice.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ll_t_bounds</code></td>
          <td>
                <code>list(list(tuple</code>
          </td>
          <td><p>A list of lists of lipid boundaries (tuples). The first
list is used to separate image channels. The second list is used to separate lipid.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>normalize_independently</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, each lipid intensity array is
normalized independently, regardless of other lipids or channel used. Defaults to
True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>projected_image</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the pixels of the original acquisition get
matched to a higher-resolution, warped space. The gaps are filled by duplicating the
most appropriate pixels (see dosctring of Atlas.project_image() for more
information). Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>log</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the resulting array corresponds to log-transformed
expression, for each lipid. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>apply_transform</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, applies the MAIA transform (if possible) to
the current selection, given that the parameter normalize is also True, and that
lipid_name corresponds to an existing lipid. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>ll_lipid_names</code></td>
          <td>
                <code>list(list(int))</code>
          </td>
          <td><p>List of list of lipid names that must be
MAIA-transformed, if apply_transform and normalize are True. The first list is used
to separate channels, when applicable. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A three-dimensional RGB numpy array (of uint8 dtype). The first two
dimensions correspond to the acquisition image shape, and the third dimension
corresponds to the channels.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_rgb_array_per_lipid_selection</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">ll_t_bounds</span><span class="p">,</span>
    <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes a numpy RGB array (each pixel has 3 intensity values) of</span>
<span class="sd">    expression of the requested lipids (those whose m/z values are in ll_t_bounds) in the slice.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): The index of the requested slice.</span>
<span class="sd">        ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">            list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">        normalize_independently (bool, optional): If True, each lipid intensity array is</span>
<span class="sd">            normalized independently, regardless of other lipids or channel used. Defaults to</span>
<span class="sd">            True.</span>
<span class="sd">        projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">            matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">            most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">            information). Defaults to True.</span>
<span class="sd">        log (bool, optional): If True, the resulting array corresponds to log-transformed</span>
<span class="sd">            expression, for each lipid. Defaults to False.</span>
<span class="sd">        apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">            the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">            lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">        ll_lipid_names (list(list(int)), optional): List of list of lipid names that must be</span>
<span class="sd">            MAIA-transformed, if apply_transform and normalize are True. The first list is used</span>
<span class="sd">            to separate channels, when applicable. Defaults to None.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A three-dimensional RGB numpy array (of uint8 dtype). The first two</span>
<span class="sd">            dimensions correspond to the acquisition image shape, and the third dimension</span>
<span class="sd">            corresponds to the channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Empty lipid names if no names provided</span>
    <span class="k">if</span> <span class="n">ll_lipid_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ll_lipid_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">l_t_bounds</span><span class="p">]</span> <span class="k">if</span> <span class="n">l_t_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span>
        <span class="p">]</span>

    <span class="c1"># Build a list of empty images and add selected lipids for each channel</span>
    <span class="n">l_images</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop over channels</span>
    <span class="k">for</span> <span class="n">l_boundaries</span><span class="p">,</span> <span class="n">l_names</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">ll_lipid_names</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">image_shape</span>
            <span class="k">if</span> <span class="n">projected_image</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">l_boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Loop over lipids</span>
            <span class="k">for</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">lipid_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_boundaries</span><span class="p">,</span> <span class="n">l_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">lb_mz</span><span class="p">,</span> <span class="n">hb_mz</span><span class="p">)</span> <span class="o">=</span> <span class="n">boundaries</span>

                    <span class="c1"># Cmpute expression image per lipid</span>
                    <span class="n">image_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_image_per_lipid</span><span class="p">(</span>
                        <span class="n">slice_index</span><span class="p">,</span>
                        <span class="n">lb_mz</span><span class="p">,</span>
                        <span class="n">hb_mz</span><span class="p">,</span>
                        <span class="n">RGB_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">normalize</span><span class="o">=</span><span class="n">normalize_independently</span><span class="p">,</span>
                        <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
                        <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
                        <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
                        <span class="n">lipid_name</span><span class="o">=</span><span class="n">lipid_name</span><span class="p">,</span>
                        <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">image_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">image</span> <span class="o">+=</span> <span class="n">image_temp</span>

        <span class="n">l_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Reoder axis to match plotly go.image requirements</span>
    <span class="n">array_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_images</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">array_image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_rgb_image_per_lipid_selection" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_rgb_image_per_lipid_selection</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">ll_t_bounds</span><span class="p">,</span> <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function is very similar to compute_heatmap_per_lipid_selection, but it returns a
RGB image instead of a heatmap.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ll_t_bounds</code></td>
          <td>
                <code>list(list(tuple</code>
          </td>
          <td><p>A list of lists of lipid boundaries (tuples). The first
list is used to separate image channels. The second list is used to separate lipid.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>normalize_independently</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, each lipid intensity array is
normalized independently, regardless of other lipids or channel used. Defaults to
True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>projected_image</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the pixels of the original acquisition get
matched to a higher-resolution, warped space. The gaps are filled by duplicating the
most appropriate pixels (see dosctring of Atlas.project_image() for more
information). Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>log</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the resulting array corresponds to log-transformed
expression, for each lipid. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>return_image</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, a go.Image is returned directly, instead of a
Plotly Figure. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>apply_transform</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, applies the MAIA transform (if possible) to
the current selection, given that the parameter normalize is also True, and that
lipid_name corresponds to an existing lipid. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>ll_lipid_names</code></td>
          <td>
                <code>list(list(int))</code>
          </td>
          <td><p>List of list of lipid names that must be
MAIA-transformed, if apply_transform and normalize are True. The first list is used
to separate channels, when applicable. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>return_base64_string</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the base64 string of the image is
returned directly, before any figure building. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Depending on the inputted arguments, may either return a base64 string, a go.Image, or
a Plotly Figure.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_rgb_image_per_lipid_selection</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">ll_t_bounds</span><span class="p">,</span>
    <span class="n">normalize_independently</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">projected_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">return_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ll_lipid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_base64_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is very similar to compute_heatmap_per_lipid_selection, but it returns a</span>
<span class="sd">    RGB image instead of a heatmap.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): The index of the requested slice.</span>
<span class="sd">        ll_t_bounds (list(list(tuple))): A list of lists of lipid boundaries (tuples). The first</span>
<span class="sd">            list is used to separate image channels. The second list is used to separate lipid.</span>
<span class="sd">        normalize_independently (bool, optional): If True, each lipid intensity array is</span>
<span class="sd">            normalized independently, regardless of other lipids or channel used. Defaults to</span>
<span class="sd">            True.</span>
<span class="sd">        projected_image (bool, optional): If True, the pixels of the original acquisition get</span>
<span class="sd">            matched to a higher-resolution, warped space. The gaps are filled by duplicating the</span>
<span class="sd">            most appropriate pixels (see dosctring of Atlas.project_image() for more</span>
<span class="sd">            information). Defaults to True.</span>
<span class="sd">        log (bool, optional): If True, the resulting array corresponds to log-transformed</span>
<span class="sd">            expression, for each lipid. Defaults to False.</span>
<span class="sd">        return_image (bool, optional): If True, a go.Image is returned directly, instead of a</span>
<span class="sd">            Plotly Figure. Defaults to False.</span>
<span class="sd">        apply_transform (bool, optional): If True, applies the MAIA transform (if possible) to</span>
<span class="sd">            the current selection, given that the parameter normalize is also True, and that</span>
<span class="sd">            lipid_name corresponds to an existing lipid. Defaults to False.</span>
<span class="sd">        ll_lipid_names (list(list(int)), optional): List of list of lipid names that must be</span>
<span class="sd">            MAIA-transformed, if apply_transform and normalize are True. The first list is used</span>
<span class="sd">            to separate channels, when applicable. Defaults to None.</span>
<span class="sd">        return_base64_string (bool, optional): If True, the base64 string of the image is</span>
<span class="sd">            returned directly, before any figure building. Defaults to False.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Depending on the inputted arguments, may either return a base64 string, a go.Image, or</span>
<span class="sd">            a Plotly Figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started RGB image computation for slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># Empty lipid names if no names provided</span>
    <span class="k">if</span> <span class="n">ll_lipid_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ll_lipid_names</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">l_t_bounds</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_t_bounds</span> <span class="ow">in</span> <span class="n">ll_t_bounds</span><span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Acquiring array_image for slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># Get RGB array for the current lipid selection</span>
    <span class="n">array_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rgb_array_per_lipid_selection</span><span class="p">(</span>
        <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">ll_t_bounds</span><span class="p">,</span>
        <span class="n">normalize_independently</span><span class="o">=</span><span class="n">normalize_independently</span><span class="p">,</span>
        <span class="n">projected_image</span><span class="o">=</span><span class="n">projected_image</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
        <span class="n">apply_transform</span><span class="o">=</span><span class="n">apply_transform</span><span class="p">,</span>
        <span class="n">ll_lipid_names</span><span class="o">=</span><span class="n">ll_lipid_names</span><span class="p">,</span>
        <span class="n">cache_flask</span><span class="o">=</span><span class="n">cache_flask</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning fig for slice &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># Build the correspondig figure</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lipid_heatmap_from_image</span><span class="p">(</span>
        <span class="n">array_image</span><span class="p">,</span>
        <span class="n">return_base64_string</span><span class="o">=</span><span class="n">return_base64_string</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">type_image</span><span class="o">=</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
        <span class="n">return_go_image</span><span class="o">=</span><span class="n">return_image</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_scatter_3D" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_scatter_3D</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This functions computes a figure representing, in a 3D scatter plot, the spots acquired
using spatial scRNAseq experiments.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Plotly.<span title="Plotly.Figure">Figure</span></code>
          </td>
          <td><p>A Plotly Figure containing a go.Scatter3d object representing the
acquired spots.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_scatter_3D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions computes a figure representing, in a 3D scatter plot, the spots acquired</span>
<span class="sd">    using spatial scRNAseq experiments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Plotly.Figure): A Plotly Figure containing a go.Scatter3d object representing the</span>
<span class="sd">            acquired spots.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting computing 3D scatter plot for scRNAseq experiments&quot;</span> <span class="o">+</span> <span class="n">logmem</span><span class="p">())</span>

    <span class="c1"># Get scatter figure for the scRNAseq spots</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">xmol</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">zmol</span><span class="p">,</span>
        <span class="n">z</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">_scRNAseq</span><span class="o">.</span><span class="n">ymol</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="c1"># Get root figure</span>
    <span class="n">root_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
        <span class="s2">&quot;volume_root&quot;</span><span class="p">,</span>
        <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_3D_root_volume</span><span class="p">,</span>
        <span class="n">differentiate_borders</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Remove inside of volume</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">),</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Change orientation</span>
    <span class="n">root_data_y</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
    <span class="n">root_data_z</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data_z</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">root_data_y</span>

    <span class="c1"># Remove parts of brain that prevent from clicking points</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">root_data_y_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">][(</span><span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">root_data_y_copy</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)]</span>

    <span class="c1"># Block interaction for skull</span>
    <span class="n">root_data</span><span class="p">[</span><span class="s2">&quot;hoverinfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;skip&quot;</span>
    <span class="n">scatter</span><span class="p">[</span><span class="s2">&quot;hoverinfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

    <span class="c1"># Build figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">root_data</span><span class="p">,</span> <span class="n">scatter</span><span class="p">])</span>

    <span class="c1"># Hide background</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Click on a point to see the corresponding scRNAseq data&quot;</span><span class="p">,</span>
        <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Set background color to zero</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

    <span class="c1"># Change orientation to have scatter dots face the reader</span>
    <span class="n">x_eye</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">y_eye</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">z_eye</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="c1"># up=dict(x=0, y=0, z=0),</span>
        <span class="c1"># center=dict(x=0, y=0, z=0),</span>
        <span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_eye</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_eye</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z_eye</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_spectrum_high_res" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_spectrum_high_res</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_xlim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">standardization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function returns the high-resolution spectrum of the requested slice between the two
provided m/z boundaries lb and hb. If boundaries are not provided, it returns an empty
spectrum.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The slice index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>lb</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The lower m/z boundary below which the spectrum to display must
be cropped. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>hb</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The higher m/z boundary below which the spectrum to display must
be cropped. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>annotations</code></td>
          <td>
                <code>list(tuple)</code>
          </td>
          <td><p>A list of m/z boundaries (one for each lipid to
annotate), corresponding to the position of colored box superimposed on the spectra.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>force_xlim</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If Truen the zoom level will be set to enclose lb and hb,
although that may not be the tightest region to enclose the data. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>plot</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If False, only the plotting data (m/z and intensities arrays)
will be returned. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>standardization</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the displayed spectrum is standardized with
MAIA when possible.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>cache_flask</code></td>
          <td>
                <code>flask_caching.<span title="flask_caching.Cache">Cache</span></code>
          </td>
          <td><p>Cache of the Flask database. If set to
None, the reading of memory-mapped data will not be multithreads-safe. Defaults to
None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Depending on the value of the boundaries, and the plot parameter, it may return a Plotly
Figure containing an empty spectrum, or a spectrum between the two
provided boundaries, or the corresponding data of such a spectrum.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_spectrum_high_res</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">lb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_xlim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">standardization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns the high-resolution spectrum of the requested slice between the two</span>
<span class="sd">    provided m/z boundaries lb and hb. If boundaries are not provided, it returns an empty</span>
<span class="sd">    spectrum.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): The slice index of the requested slice.</span>
<span class="sd">        lb (float, optional): The lower m/z boundary below which the spectrum to display must</span>
<span class="sd">            be cropped. Defaults to None.</span>
<span class="sd">        hb (float, optional): The higher m/z boundary below which the spectrum to display must</span>
<span class="sd">            be cropped. Defaults to None.</span>
<span class="sd">        annotations (list(tuple), optional): A list of m/z boundaries (one for each lipid to</span>
<span class="sd">            annotate), corresponding to the position of colored box superimposed on the spectra.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        force_xlim (bool, optional): If Truen the zoom level will be set to enclose lb and hb,</span>
<span class="sd">            although that may not be the tightest region to enclose the data. Defaults to False.</span>
<span class="sd">        plot (bool, optional): If False, only the plotting data (m/z and intensities arrays)</span>
<span class="sd">            will be returned. Defaults to True.</span>
<span class="sd">        standardization (bool, optional): If True, the displayed spectrum is standardized with</span>
<span class="sd">            MAIA when possible.</span>
<span class="sd">        cache_flask (flask_caching.Cache, optional): Cache of the Flask database. If set to</span>
<span class="sd">            None, the reading of memory-mapped data will not be multithreads-safe. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Depending on the value of the boundaries, and the plot parameter, it may return a Plotly</span>
<span class="sd">            Figure containing an empty spectrum, or a spectrum between the two</span>
<span class="sd">            provided boundaries, or the corresponding data of such a spectrum.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define default values for graph (empty)</span>
    <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">([],)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">([],)</span>

    <span class="c1"># If boundaries are provided, get their index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index_lb</span><span class="p">,</span> <span class="n">index_hb</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
            <span class="n">compute_index_boundaries</span><span class="p">,</span>
            <span class="n">cache_flask</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
            <span class="n">slice_index</span><span class="p">,</span>
            <span class="n">lb</span><span class="p">,</span>
            <span class="n">hb</span><span class="p">,</span>
            <span class="n">array_spectra_avg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum</span><span class="p">(</span>
                <span class="n">slice_index</span><span class="p">,</span> <span class="n">standardization</span><span class="o">=</span><span class="n">standardization</span>
            <span class="p">),</span>
            <span class="n">lookup_table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_lookup_mz_avg</span><span class="p">(</span><span class="n">slice_index</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">return_x_y</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_lb</span><span class="p">:</span><span class="n">index_hb</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">index_lb</span><span class="p">:</span><span class="n">index_hb</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

        <span class="c1"># Get x, y in a thread safe fashion</span>
        <span class="c1"># No need to clean memory as it&#39;s really small</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">compute_thread_safe_function</span><span class="p">(</span>
            <span class="n">return_x_y</span><span class="p">,</span>
            <span class="n">cache_flask</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
            <span class="n">slice_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">standardization</span><span class="o">=</span><span class="n">standardization</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># In case download without plotting</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="c1"># Define figure data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tozeroy&quot;</span><span class="p">)</span>

    <span class="c1"># Define figure layout</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">rangeslider</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fixedrange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">),</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;High resolution spectrum (averaged across pixels)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span>
            <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">},</span>
        <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Build figure layout</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

    <span class="c1"># Annotate selected lipids with vertical bars</span>
    <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">annotations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lb</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hb</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_vrect</span><span class="p">(</span>
                        <span class="n">x0</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x1</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="n">color</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span>
                    <span class="p">)</span>

    <span class="c1"># In case we don&#39;t want to zoom in too much on the selected lipid</span>
    <span class="k">if</span> <span class="n">force_xlim</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">lb</span><span class="p">,</span> <span class="n">hb</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_spectrum_low_res" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_spectrum_low_res</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function returns the full (low-resolution) spectrum of the requested slice.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The slice index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotations</code></td>
          <td>
                <code>list(tuple)</code>
          </td>
          <td><p>A list of m/z boundaries (one for each lipid to
annotate), corresponding to the position of colored box superimposed on the spectra.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="plotly.graph_objects">go</span>.<span title="plotly.graph_objects.Figure">Figure</span></code>
          </td>
          <td><p>A Plotly Figure representing the low-resolution spectrum.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_spectrum_low_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns the full (low-resolution) spectrum of the requested slice.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): The slice index of the requested slice.</span>
<span class="sd">        annotations (list(tuple), optional): A list of m/z boundaries (one for each lipid to</span>
<span class="sd">            annotate), corresponding to the position of colored box superimposed on the spectra.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (go.Figure): A Plotly Figure representing the low-resolution spectrum.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define figure data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum_downsampled</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_array_avg_spectrum_downsampled</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">line_color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">],</span>
        <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tozeroy&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Define figure layout</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">rangeslider</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fixedrange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">),</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
        <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Low resolution spectrum (averaged across pixels)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span>
            <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">},</span>
        <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0.3)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Build figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

    <span class="c1"># Annotate selected lipids with vertical bars</span>
    <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">annot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">],</span> <span class="n">annotations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">annot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_vrect</span><span class="p">(</span>
                    <span class="n">x0</span><span class="o">=</span><span class="n">annot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">x1</span><span class="o">=</span><span class="n">annot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="n">color</span><span class="p">],</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                    <span class="n">line_color</span><span class="o">=</span><span class="n">dic_colors</span><span class="p">[</span><span class="n">color</span><span class="p">],</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.compute_treemaps_figure" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_treemaps_figure</span><span class="p">(</span><span class="n">maxdepth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function is used to generate a Plotly Figure containing a treemap of the Allen Brain
Atlas hierarchy.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>maxdepth</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The depth of the treemap to generate. Defaults to 5.</p></td>
          <td>
                <code>5</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Plotly.<span title="Plotly.Figure">Figure</span></code>
          </td>
          <td><p>A Plotly Figure containing a treemap of the Allen Brain Atlas
hierarchy.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_treemaps_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to generate a Plotly Figure containing a treemap of the Allen Brain</span>
<span class="sd">    Atlas hierarchy.</span>

<span class="sd">    Args:</span>
<span class="sd">        maxdepth (int, optional): The depth of the treemap to generate. Defaults to 5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Plotly.Figure): A Plotly Figure containing a treemap of the Allen Brain Atlas</span>
<span class="sd">            hierarchy.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Build treemaps from list of children and parents</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">treemap</span><span class="p">(</span>
        <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">l_nodes</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">l_parents</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span>
    <span class="p">)</span>

    <span class="c1"># Improve layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">uniformtext</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">minsize</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">root_color</span><span class="o">=</span><span class="s2">&quot;#1d3d5c&quot;</span><span class="p">)</span>

    <span class="c1"># Set background color to zero</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.get_array_of_annotations" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_array_of_annotations</span><span class="p">(</span><span class="n">decrease_dimensionality_factor</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function returns the array of annotations from the Allen Brain Atlas, subsampled to
decrease the size of the output.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>decrease_dimensionality_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>An integer used for subsampling the array. The
higher, the higher the subsampling.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A 3D array of annotation, in which structures are annotated with specific
identifiers.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_array_of_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decrease_dimensionality_factor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns the array of annotations from the Allen Brain Atlas, subsampled to</span>
<span class="sd">    decrease the size of the output.</span>
<span class="sd">    Args:</span>
<span class="sd">        decrease_dimensionality_factor (int): An integer used for subsampling the array. The</span>
<span class="sd">            higher, the higher the subsampling.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A 3D array of annotation, in which structures are annotated with specific</span>
<span class="sd">            identifiers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get subsampled array of annotations</span>
    <span class="n">array_annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">bg_atlas</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span>
            <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
            <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
            <span class="p">::</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Bug correction for the last slice</span>
    <span class="n">array_annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">array_annotation</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">array_annotation</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.get_surface" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_surface</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">l_transform_parameters</span><span class="p">,</span> <span class="n">array_projection</span><span class="p">,</span> <span class="n">reduce_resolution_factor</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function returns a Plotly Surface representing the requested slice in 3D.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index of the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>l_transform_parameters</code></td>
          <td>
                <code>list(np.ndarray</code>
          </td>
          <td><p>A list of tuples containing the parameters
for the transformation of the slice coordinates from 2D to 3D and conversely.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_projection</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The coordinates of the requested slice in 2D.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>reduce_resolution_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Divides (reduce) the initial resolution of the
data. Needed as the resulting figure can be very heavy. Defaults to 20.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="plotly.graph_objects">go</span>.<span title="plotly.graph_objects.Surface">Surface</span></code>
          </td>
          <td><p>A Plotly Surface representing the requested slice in 3D.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_surface</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">slice_index</span><span class="p">,</span> <span class="n">l_transform_parameters</span><span class="p">,</span> <span class="n">array_projection</span><span class="p">,</span> <span class="n">reduce_resolution_factor</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns a Plotly Surface representing the requested slice in 3D.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): Index of the requested slice.</span>
<span class="sd">        l_transform_parameters (list(np.ndarray)): A list of tuples containing the parameters</span>
<span class="sd">            for the transformation of the slice coordinates from 2D to 3D and conversely.</span>
<span class="sd">        array_projection (np.ndarray): The coordinates of the requested slice in 2D.</span>
<span class="sd">        reduce_resolution_factor (int, optional): Divides (reduce) the initial resolution of the</span>
<span class="sd">            data. Needed as the resulting figure can be very heavy. Defaults to 20.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (go.Surface): A Plotly Surface representing the requested slice in 3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#  Get the parameters for the transformation of the coordinats from 2D to 3D</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">l_transform_parameters</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span>

    <span class="c1"># Build 3 empty lists, which will contain the 3D coordinates of the requested slice</span>
    <span class="n">ll_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ll_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ll_z</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop over the first 2D coordinate of the slice</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">l_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">l_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">l_z</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over the second 2D coordinate of the slice</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="c1"># Get rescaled 3D coordinates</span>
            <span class="n">x_atlas</span><span class="p">,</span> <span class="n">y_atlas</span><span class="p">,</span> <span class="n">z_atlas</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">slice_to_atlas_transform</span><span class="p">(</span>
                        <span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">reduce_resolution_factor</span><span class="p">,</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">reduce_resolution_factor</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">resolution</span>
                <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="n">l_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_atlas</span><span class="p">)</span>
            <span class="n">l_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_atlas</span><span class="p">)</span>
            <span class="n">l_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_atlas</span><span class="p">)</span>

        <span class="c1"># In case the 3D coordinate was not acquired, skip the current coordinate</span>
        <span class="k">if</span> <span class="n">l_x</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ll_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_x</span><span class="p">)</span>
            <span class="n">ll_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_y</span><span class="p">)</span>
            <span class="n">ll_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_z</span><span class="p">)</span>

    <span class="c1"># Build a 3D surface from the 3D coordinates for the current slice</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ll_z</span><span class="p">),</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ll_x</span><span class="p">),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ll_y</span><span class="p">),</span>
        <span class="n">surfacecolor</span><span class="o">=</span><span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">cmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">cmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">opacityscale</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
        <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">surface</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.return_empty_spectrum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_empty_spectrum</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function returns an empty spectrum, used to display when no spectrum is available.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Plotly Figure</code>
          </td>
          <td><p>A Plotly Figure representing an empty spectrum.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">return_empty_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns an empty spectrum, used to display when no spectrum is available.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Plotly Figure): A Plotly Figure representing an empty spectrum.&quot;&quot;&quot;</span>

    <span class="c1"># Define empty figure data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[],</span> <span class="n">y</span><span class="o">=</span><span class="p">[],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>

    <span class="c1"># Define figure layout</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">),</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Build figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

    <span class="c1"># Transparent background</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.return_heatmap_lipid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_heatmap_lipid</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function is used to either generate a Plotly Figure containing an empty go.Heatmap,
or complete the figure passed as argument with a proper layout that matches the theme of the
app.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>fig</code></td>
          <td>
                <code>Plotly Figure</code>
          </td>
          <td><p>A Plotly Figure whose layout must be completed. If None,
a new figure will be generated. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Plotly Figure</code>
          </td>
          <td><p>A Plotly Figure containing an empty go.Heatmap, or complete the figure
passed as argument with a proper layout that matches the theme of the app.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">return_heatmap_lipid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to either generate a Plotly Figure containing an empty go.Heatmap,</span>
<span class="sd">    or complete the figure passed as argument with a proper layout that matches the theme of the</span>
<span class="sd">    app.</span>

<span class="sd">    Args:</span>
<span class="sd">        fig (Plotly Figure, optional): A Plotly Figure whose layout must be completed. If None,</span>
<span class="sd">            a new figure will be generated. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Plotly Figure): A Plotly Figure containing an empty go.Heatmap, or complete the figure</span>
<span class="sd">            passed as argument with a proper layout that matches the theme of the app.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Build empty figure if not provided</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="p">[[]],</span> <span class="n">x</span><span class="o">=</span><span class="p">[],</span> <span class="n">y</span><span class="o">=</span><span class="p">[],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># Improve figure layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_dark&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Transparent background</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">plot_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">paper_bgcolor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0)&quot;</span>

    <span class="c1"># Dark Template</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;plotly_dark&quot;</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.shelve_all_arrays_annotation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shelve_all_arrays_annotation</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This functions precomputes and shelves the array of structure annotation used in a
3D representation of the brain (through self.compute_3D_volume_figure()), at different
resolutions. Once everything has been shelved, a boolean value is stored in the shelve
database, to indicate that the arrays do not need to be recomputed at next app startup.</p>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shelve_all_arrays_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions precomputes and shelves the array of structure annotation used in a</span>
<span class="sd">    3D representation of the brain (through self.compute_3D_volume_figure()), at different</span>
<span class="sd">    resolutions. Once everything has been shelved, a boolean value is stored in the shelve</span>
<span class="sd">    database, to indicate that the arrays do not need to be recomputed at next app startup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">decrease_dimensionality_factor</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
            <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;arrays_annotation&quot;</span><span class="p">,</span>
            <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array_of_annotations</span><span class="p">,</span>
            <span class="n">decrease_dimensionality_factor</span><span class="o">=</span><span class="n">decrease_dimensionality_factor</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Variable to signal everything has been computed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">dump_shelved_object</span><span class="p">(</span><span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_annotation_computed&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.shelve_all_l_array_2D" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shelve_all_l_array_2D</span><span class="p">(</span><span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This functions precomputes and shelves all the arrays of lipid expression used in a 3D
representation of the brain (through self.compute_3D_volume_figure()). Once everything has
been shelved, a boolean value is stored in the shelve database, to indicate that the arrays
do not need to be recomputed at next app startup.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>force_update</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the function will not overwrite existing files.
Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>sample</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, only a fraction of the precomputations are made (for
debug). Default to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>brain_1</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the data is precomputed for the brain 1. Else for
the brain 2. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shelve_all_l_array_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">brain_1</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This functions precomputes and shelves all the arrays of lipid expression used in a 3D</span>
<span class="sd">    representation of the brain (through self.compute_3D_volume_figure()). Once everything has</span>
<span class="sd">    been shelved, a boolean value is stored in the shelve database, to indicate that the arrays</span>
<span class="sd">    do not need to be recomputed at next app startup.</span>

<span class="sd">    Args:</span>
<span class="sd">        force_update (bool, optional): If True, the function will not overwrite existing files.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        sample (bool, optional): If True, only a fraction of the precomputations are made (for</span>
<span class="sd">            debug). Default to False.</span>
<span class="sd">        brain_1 (bool, optional): If True, the data is precomputed for the brain 1. Else for</span>
<span class="sd">            the brain 2. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Count number of lipids processed for sampling</span>
    <span class="n">n_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only a sample of the lipid arrays will be computed!&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate a click on all lipid names</span>
    <span class="n">df_annotations_MAIA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations_MAIA_transformed_lipids</span><span class="p">(</span><span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_annotations_MAIA</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">structures</span><span class="p">):</span>
            <span class="n">cations</span> <span class="o">=</span> <span class="n">df_annotations_MAIA</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_annotations_MAIA</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">structure</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">cation</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cation</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cations</span><span class="p">):</span>
                <span class="n">l_selected_lipids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">slice_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span>
                    <span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># Find lipid location</span>
                    <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">index</span><span class="p">[</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">structure</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">slice_index</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()[</span><span class="s2">&quot;cation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cation</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="p">)</span>

                    <span class="c1"># If several lipids correspond to the selection, we have a problem...</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;More than one lipid corresponds to the selection&quot;</span><span class="p">)</span>
                        <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">l_lipid_loc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="c1"># If no lipid correspond to the selection, set to -1</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">l_lipid_loc</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># add lipid index for each slice</span>
                    <span class="n">l_selected_lipids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_lipid_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Get final lipid name</span>
                <span class="n">lipid_string</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">structure</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cation</span>

                <span class="c1"># If lipid is present in at least one slice</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">l_selected_lipids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_list</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="s2">&quot;brain_1&quot;</span> <span class="k">if</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="s2">&quot;brain_2&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="c1"># Build the list of mz boundaries for each peak and each index</span>
                    <span class="n">lll_lipid_bounds</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span>
                            <span class="p">[</span>
                                <span class="p">(</span>
                                    <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">]),</span>
                                    <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]),</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lipid_1_index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">lipid_1_index</span> <span class="ow">in</span> <span class="n">l_selected_lipids</span>
                    <span class="p">]</span>

                    <span class="c1"># Compute 3D figures, selection is limited to one lipid</span>
                    <span class="n">name_lipid</span> <span class="o">=</span> <span class="n">lipid_string</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                        <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;arrays_expression_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">brain_1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name_lipid</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span><span class="p">,</span>
                        <span class="n">force_update</span><span class="o">=</span><span class="n">force_update</span><span class="p">,</span>
                        <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_l_array_2D</span><span class="p">,</span>
                        <span class="n">ignore_arguments_naming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ll_t_bounds</span><span class="o">=</span><span class="n">lll_lipid_bounds</span><span class="p">,</span>
                        <span class="n">brain_1</span><span class="o">=</span><span class="n">brain_1</span><span class="p">,</span>
                        <span class="n">cache_flask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No cache needed since launched at startup</span>
                    <span class="p">)</span>

                    <span class="n">n_processed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">n_processed</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">sample</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Variable to signal everything has been computed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">dump_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/3D_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_expression_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">brain_1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_computed&quot;</span><span class="p">,</span> <span class="kc">True</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.figures.Figures.shelve_arrays_basic_figures" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shelve_arrays_basic_figures</span><span class="p">(</span><span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>This function shelves in the database all the arrays of basic images computed in
self.compute_figure_basic_image(), across all slices and all types of arrays. This forces
the precomputations of these arrays, and allows to access them faster. Once everything has
been shelved, a boolean value is stored in the shelve database, to indicate that the arrays
do not need to be recomputed at next app startup.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>force_update</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the function will not overwrite existing files.
Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/figures.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shelve_arrays_basic_figures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function shelves in the database all the arrays of basic images computed in</span>
<span class="sd">    self.compute_figure_basic_image(), across all slices and all types of arrays. This forces</span>
<span class="sd">    the precomputations of these arrays, and allows to access them faster. Once everything has</span>
<span class="sd">    been shelved, a boolean value is stored in the shelve database, to indicate that the arrays</span>
<span class="sd">    do not need to be recomputed at next app startup.</span>

<span class="sd">    Args:</span>
<span class="sd">        force_update (bool, optional): If True, the function will not overwrite existing files.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">idx_slice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get_slice_number</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">type_figure</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;original_data&quot;</span><span class="p">,</span> <span class="s2">&quot;warped_data&quot;</span><span class="p">,</span> <span class="s2">&quot;projection_corrected&quot;</span><span class="p">,</span> <span class="s2">&quot;atlas&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">display_annotations</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="c1"># Force no annotation for the original data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">return_shelved_object</span><span class="p">(</span>
                    <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;figure_basic_image&quot;</span><span class="p">,</span>
                    <span class="n">force_update</span><span class="o">=</span><span class="n">force_update</span><span class="p">,</span>
                    <span class="n">compute_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_figure_basic_image</span><span class="p">,</span>
                    <span class="n">type_figure</span><span class="o">=</span><span class="n">type_figure</span><span class="p">,</span>
                    <span class="n">index_image</span><span class="o">=</span><span class="n">idx_slice</span><span class="p">,</span>
                    <span class="n">plot_atlas_contours</span><span class="o">=</span><span class="n">display_annotations</span>
                    <span class="k">if</span> <span class="n">type_figure</span> <span class="o">!=</span> <span class="s2">&quot;original_data&quot;</span>
                    <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">dump_shelved_object</span><span class="p">(</span>
        <span class="s2">&quot;figures/load_page&quot;</span><span class="p">,</span> <span class="s2">&quot;arrays_basic_figures_computed&quot;</span><span class="p">,</span> <span class="kc">True</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../atlas/" class="md-footer__link md-footer__link--prev" aria-label="Previous: atlas" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              atlas
            </div>
          </div>
        </a>
      
      
        
        <a href="../launch/" class="md-footer__link md-footer__link--next" aria-label="Next: launch" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              launch
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections"], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>