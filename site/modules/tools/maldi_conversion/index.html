
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A web application to explore the mouse Lipid Brain Atlas.">
      
      
        <meta name="author" content="Colas Droin">
      
      
        <link rel="canonical" href="https://lbae.epfl.ch/modules/tools/maldi_conversion/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Maldi conversion - LBAE technical documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#modules.tools.maldi_conversion" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="LBAE technical documentation" class="md-header__button md-logo" aria-label="LBAE technical documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LBAE technical documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Maldi conversion
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ColasDroin/lbae" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="LBAE technical documentation" class="md-nav__button md-logo" aria-label="LBAE technical documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    LBAE technical documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ColasDroin/lbae" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome page
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../main/" class="md-nav__link">
        main
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../app/" class="md-nav__link">
        app
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../index_py/" class="md-nav__link">
        index
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Modules
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modules" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Modules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../atlas_labels/" class="md-nav__link">
        atlas_labels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../atlas/" class="md-nav__link">
        atlas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figures/" class="md-nav__link">
        figures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../launch/" class="md-nav__link">
        launch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maldi_data/" class="md-nav__link">
        maldi_data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../scRNAseq/" class="md-nav__link">
        scRNAseq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../storage/" class="md-nav__link">
        storage
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_8" type="checkbox" id="__nav_5_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_8">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tools" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_8">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../atlas/" class="md-nav__link">
        Atlas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        Image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../lookup_tables/" class="md-nav__link">
        Lookup tables
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Maldi conversion
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Maldi conversion
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion" class="md-nav__link">
    modules.tools.maldi_conversion
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.compute_TIC_per_pixel" class="md-nav__link">
    compute_TIC_per_pixel()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.compute_standardization" class="md-nav__link">
    compute_standardization()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.extract_raw_data" class="md-nav__link">
    extract_raw_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.filter_peaks" class="md-nav__link">
    filter_peaks()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.get_array_peaks_to_correct" class="md-nav__link">
    get_array_peaks_to_correct()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.get_standardized_values" class="md-nav__link">
    get_standardized_values()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.load_file" class="md-nav__link">
    load_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.load_lipid_file" class="md-nav__link">
    load_lipid_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.load_peak_file" class="md-nav__link">
    load_peak_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.normalize_per_TIC_per_pixel" class="md-nav__link">
    normalize_per_TIC_per_pixel()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.process_raw_data" class="md-nav__link">
    process_raw_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.process_sparse_matrix" class="md-nav__link">
    process_sparse_matrix()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.return_array_pixel_indexes" class="md-nav__link">
    return_array_pixel_indexes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.return_average_spectrum" class="md-nav__link">
    return_average_spectrum()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.return_averaged_spectra_array" class="md-nav__link">
    return_averaged_spectra_array()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.standardize_values" class="md-nav__link">
    standardize_values()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        Misc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spectra/" class="md-nav__link">
        Spectra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../volume/" class="md-nav__link">
        Volume
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Pages
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pages" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Pages
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/home/" class="md-nav__link">
        home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/sidebar/" class="md-nav__link">
        sidebar
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/load_slice/" class="md-nav__link">
        load_slice
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/lipid_selection/" class="md-nav__link">
        lipid_selection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/region_analysis/" class="md-nav__link">
        region_analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/threeD_exploration/" class="md-nav__link">
        threeD_exploration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/scRNAseq/" class="md-nav__link">
        scRNAseq
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion" class="md-nav__link">
    modules.tools.maldi_conversion
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.compute_TIC_per_pixel" class="md-nav__link">
    compute_TIC_per_pixel()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.compute_standardization" class="md-nav__link">
    compute_standardization()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.extract_raw_data" class="md-nav__link">
    extract_raw_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.filter_peaks" class="md-nav__link">
    filter_peaks()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.get_array_peaks_to_correct" class="md-nav__link">
    get_array_peaks_to_correct()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.get_standardized_values" class="md-nav__link">
    get_standardized_values()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.load_file" class="md-nav__link">
    load_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.load_lipid_file" class="md-nav__link">
    load_lipid_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.load_peak_file" class="md-nav__link">
    load_peak_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.normalize_per_TIC_per_pixel" class="md-nav__link">
    normalize_per_TIC_per_pixel()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.process_raw_data" class="md-nav__link">
    process_raw_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.process_sparse_matrix" class="md-nav__link">
    process_sparse_matrix()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.return_array_pixel_indexes" class="md-nav__link">
    return_array_pixel_indexes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.return_average_spectrum" class="md-nav__link">
    return_average_spectrum()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.return_averaged_spectra_array" class="md-nav__link">
    return_averaged_spectra_array()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.maldi_conversion.standardize_values" class="md-nav__link">
    standardize_values()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/ColasDroin/lbae/edit/master/docs/modules/tools/maldi_conversion.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Maldi conversion</h1>

<div class="doc doc-object doc-module">


<a id="modules.tools.maldi_conversion"></a>
  <div class="doc doc-contents first">
  
      <p>This file contains functions used to convert the raw MALDI data to easily readable Numpy arrays.</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.compute_TIC_per_pixel" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_TIC_per_pixel</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function computes the Total Ion Content (TIC) per pixel of the raw data.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_spectra</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing spectrum data (pixel index, m/z and
intensity).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>n_pixels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Number of pixels in the acquisition.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array of len n_pixels containing the TIC for each pixel.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">compute_TIC_per_pixel</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes the Total Ion Content (TIC) per pixel of the raw data.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_spectra (np.ndarray): A numpy array containing spectrum data (pixel index, m/z and</span>
<span class="sd">            intensity).</span>
<span class="sd">        n_pixels (int): Number of pixels in the acquisition.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A numpy array of len n_pixels containing the TIC for each pixel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array_TIC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_pixels</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pix_idx</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">array_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">array_TIC</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pix_idx</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">intensity</span>
    <span class="k">return</span> <span class="n">array_TIC</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.compute_standardization" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_standardization</span><span class="p">(</span><span class="n">array_spectra_pixel</span><span class="p">,</span> <span class="n">idx_pixel</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">arrays_before_transfo</span><span class="p">,</span> <span class="n">arrays_after_transfo</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function takes the spectrum data of a given pixel, along with the corresponding pixel
index, and transforms the value of the lipids intensities annotated in 'array_peaks' according
to the transformation made in 'arrays_before_transfo' and 'arrays_after_transfo'.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_spectra_pixel</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing spectrum data (pixel index, m/z and
intensity) of pixel 'idx_pixel', sorted by mz.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>idx_pixel</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index of the current pixel whose spectrum is transformed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_peaks</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing the peak annotations (min peak, max peak,
number of pixels containing the peak, average value of the peak), filtered for the
lipids who have preliminarily been transformed. Sorted by min_mz.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>arrays_before_transfo</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array of shape (n_lipids, image_shape[0],
image_shape[1]) containing the cumulated intensities (summed over all bins) of the
lipids we want to visualize, for each pixel, before these intensities were transformed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>arrays_after_transfo</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array of shape (n_lipids, image_shape[0],
image_shape[1]) containing the cumulated intensities (summed over all bins) of the
lipids we want to visualize, for each pixel, after these intensities were transformed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Exception</code>
          </td>
          <td><p><em>description</em></p></td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing spectrum data (pixel index, m/z and intensity), of
pixel 'idx_pixel', sorted by mz, with lipids values transformed.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">compute_standardization</span><span class="p">(</span>
    <span class="n">array_spectra_pixel</span><span class="p">,</span> <span class="n">idx_pixel</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">arrays_before_transfo</span><span class="p">,</span> <span class="n">arrays_after_transfo</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function takes the spectrum data of a given pixel, along with the corresponding pixel</span>
<span class="sd">    index, and transforms the value of the lipids intensities annotated in &#39;array_peaks&#39; according</span>
<span class="sd">    to the transformation made in &#39;arrays_before_transfo&#39; and &#39;arrays_after_transfo&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_spectra_pixel (np.ndarray): A numpy array containing spectrum data (pixel index, m/z and</span>
<span class="sd">            intensity) of pixel &#39;idx_pixel&#39;, sorted by mz.</span>
<span class="sd">        idx_pixel (int): Index of the current pixel whose spectrum is transformed.</span>
<span class="sd">        array_peaks (np.ndarray): A numpy array containing the peak annotations (min peak, max peak,</span>
<span class="sd">            number of pixels containing the peak, average value of the peak), filtered for the</span>
<span class="sd">            lipids who have preliminarily been transformed. Sorted by min_mz.</span>
<span class="sd">        arrays_before_transfo (np.ndarray): A numpy array of shape (n_lipids, image_shape[0],</span>
<span class="sd">            image_shape[1]) containing the cumulated intensities (summed over all bins) of the</span>
<span class="sd">            lipids we want to visualize, for each pixel, before these intensities were transformed.</span>
<span class="sd">        arrays_after_transfo (np.ndarray): A numpy array of shape (n_lipids, image_shape[0],</span>
<span class="sd">            image_shape[1]) containing the cumulated intensities (summed over all bins) of the</span>
<span class="sd">            lipids we want to visualize, for each pixel, after these intensities were transformed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: _description_</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A numpy array containing spectrum data (pixel index, m/z and intensity), of</span>
<span class="sd">            pixel &#39;idx_pixel&#39;, sorted by mz, with lipids values transformed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define initial values</span>
    <span class="n">idx_peak</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx_mz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_peaks_transformed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx_mz</span> <span class="o">&lt;</span> <span class="n">array_spectra_pixel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">idx_peak</span> <span class="o">&lt;</span> <span class="n">array_peaks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">idx_pix</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">array_spectra_pixel</span><span class="p">[</span><span class="n">idx_mz</span><span class="p">]</span>
        <span class="n">min_mz</span><span class="p">,</span> <span class="n">max_mz</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">,</span> <span class="n">mz_estimated</span> <span class="o">=</span> <span class="n">array_peaks</span><span class="p">[</span><span class="n">idx_peak</span><span class="p">]</span>

        <span class="c1"># New window has been discovered</span>
        <span class="k">if</span> <span class="n">mz</span> <span class="o">&gt;=</span> <span class="n">min_mz</span> <span class="ow">and</span> <span class="n">mz</span> <span class="o">&lt;=</span> <span class="n">max_mz</span><span class="p">:</span>
            <span class="n">idx_min_mz</span> <span class="o">=</span> <span class="n">idx_mz</span>
            <span class="n">idx_max_mz</span> <span class="o">=</span> <span class="n">idx_mz</span>
            <span class="k">for</span> <span class="n">idx_mz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx_min_mz</span><span class="p">,</span> <span class="n">array_spectra_pixel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">idx_pix</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">array_spectra_pixel</span><span class="p">[</span><span class="n">idx_mz</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mz</span> <span class="o">&gt;</span> <span class="n">max_mz</span><span class="p">:</span>
                    <span class="n">idx_max_mz</span> <span class="o">=</span> <span class="n">idx_mz</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">break</span>

            <span class="c1"># Most likely, the annotation doesn&#39;t exist, so skip it</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">idx_max_mz</span> <span class="o">-</span> <span class="n">idx_min_mz</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Else compute a multiplicative factor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get array of intensity before and after correction for current pixel</span>
                <span class="n">intensity_before</span> <span class="o">=</span> <span class="n">arrays_before_transfo</span><span class="p">[</span><span class="n">idx_peak</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">idx_pixel</span><span class="p">]</span>
                <span class="n">intensity_after</span> <span class="o">=</span> <span class="n">arrays_after_transfo</span><span class="p">[</span><span class="n">idx_peak</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">idx_pixel</span><span class="p">]</span>

                <span class="c1"># Compute sum of expression between limits</span>
                <span class="n">integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array_spectra_pixel</span><span class="p">[</span><span class="n">idx_min_mz</span> <span class="p">:</span> <span class="n">idx_max_mz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

                <span class="c1"># Assess that this sum is equal to the one precomputed with MAIA</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integral</span> <span class="o">-</span> <span class="n">intensity_before</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">4</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idx_max_mz</span> <span class="o">-</span> <span class="n">idx_min_mz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There seems to be a problem with the computation of the integral&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">integral</span><span class="p">,</span> <span class="n">intensity_before</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">idx_min_mz</span><span class="p">,</span> <span class="n">idx_max_mz</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># print(integral, intensity_before)</span>
                    <span class="c1"># print(idx_min_mz, idx_max_mz)</span>
                    <span class="k">pass</span>

                <span class="c1"># To avoid division by 0 (altough it shouldn&#39;t happen)</span>
                <span class="k">if</span> <span class="n">intensity_before</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">intensity_before</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">correction</span> <span class="o">=</span> <span class="n">intensity_after</span> <span class="o">/</span> <span class="n">intensity_before</span>

                <span class="c1"># Correct for negative values for very small corrections</span>
                <span class="k">if</span> <span class="n">correction</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">correction</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Multiply all intensities in the window by the corrective coefficient</span>
                <span class="n">array_spectra_pixel</span><span class="p">[</span><span class="n">idx_min_mz</span> <span class="p">:</span> <span class="n">idx_max_mz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">correction</span>
                <span class="n">n_peaks_transformed</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Move on to the next peak</span>
            <span class="n">idx_peak</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mz</span> <span class="o">&gt;</span> <span class="n">max_mz</span><span class="p">:</span>
                <span class="n">idx_peak</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx_mz</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">array_spectra_pixel</span><span class="p">,</span> <span class="n">n_peaks_transformed</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.extract_raw_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_raw_data</span><span class="p">(</span><span class="n">t_index_path</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;/data/lipidatlas/data/app/data/temp/&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function loads the raw maldi data and turns it into a python friendly numpy array, along
with a given shape for the acquisition.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>t_index_path</code></td>
          <td>
                <code>tuple(int, str</code>
          </td>
          <td><p>A tuple containing the index of the slice (starting from
1)and the corresponding path for the raw data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>save</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, arrays for the extracted data are saved in a npz file.
Defaults to True (only option implemented for now for the rest of the pipeline).</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>output_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Path to save the output npz file. Defaults to
"/data/lipidatlas/data/app/data/temp/".</p></td>
          <td>
                <code>&#39;/data/lipidatlas/data/app/data/temp/&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The first array, of shape (3,n), contains, for the current
acquisition, the mz value (2nd column) and intensity (3rd column) for each pixel
(first column). The second array contains two integers representing the acquisition
shape.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_raw_data</span><span class="p">(</span>
    <span class="n">t_index_path</span><span class="p">,</span>
    <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="s2">&quot;/data/lipidatlas/data/app/data/temp/&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads the raw maldi data and turns it into a python friendly numpy array, along</span>
<span class="sd">    with a given shape for the acquisition.</span>

<span class="sd">    Args:</span>
<span class="sd">        t_index_path (tuple(int, str)): A tuple containing the index of the slice (starting from</span>
<span class="sd">            1)and the corresponding path for the raw data.</span>
<span class="sd">        save (bool, optional): If True, arrays for the extracted data are saved in a npz file.</span>
<span class="sd">            Defaults to True (only option implemented for now for the rest of the pipeline).</span>
<span class="sd">        output_path (str, optional): Path to save the output npz file. Defaults to</span>
<span class="sd">            &quot;/data/lipidatlas/data/app/data/temp/&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray, np.ndarray): The first array, of shape (3,n), contains, for the current</span>
<span class="sd">            acquisition, the mz value (2nd column) and intensity (3rd column) for each pixel</span>
<span class="sd">            (first column). The second array contains two integers representing the acquisition</span>
<span class="sd">            shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get slice path</span>
        <span class="n">slice_index</span> <span class="o">=</span> <span class="n">t_index_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">t_index_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Correct output path</span>
        <span class="k">if</span> <span class="s2">&quot;MouseBrain2&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">+=</span> <span class="s2">&quot;brain_2/&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">+=</span> <span class="s2">&quot;brain_1/&quot;</span>

        <span class="c1"># Load file in high and low resolution</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading files : &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">smz_high_res</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
        <span class="n">image_shape</span> <span class="o">=</span> <span class="n">smz_high_res</span><span class="o">.</span><span class="n">img_shape</span>

        <span class="c1"># Load df with different sortings (low_res will be averaged over m/z afterwards)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating and sorting dataframes&quot;</span><span class="p">)</span>
        <span class="n">df_high_res</span> <span class="o">=</span> <span class="n">process_sparse_matrix</span><span class="p">(</span><span class="n">smz_high_res</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">)</span>

        <span class="c1"># Convert df into arrays for easier manipulation with numba</span>
        <span class="n">array_high_res</span> <span class="o">=</span> <span class="n">df_high_res</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span>
                <span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;slice_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;raw.npz&quot;</span><span class="p">,</span>
                <span class="n">array_high_res</span><span class="o">=</span><span class="n">array_high_res</span><span class="p">,</span>
                <span class="n">image_shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">array_high_res</span><span class="p">,</span> <span class="n">image_shape</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.filter_peaks" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_peaks</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">array_mz_lipids_per_slice</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to filter out all the spectrum data in 'array_spectra' that
has not been annotated as peak in 'array_peaks' and that do not belong to
'array_mz_lipids_per_slice'.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_spectra</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing spectrum data (pixel index, m/z and
intensity), sorted by mz (but not necessarily by pixel index).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_peaks</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing the peak annotations (min peak, max peak,
number of pixels containing the peak, average value of the peak), sorted by min_mz.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_mz_lipids_per_slice</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A 1-D numpy array containing the per-slice mz
values of the lipids we want to visualize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list</code>
          </td>
          <td><p>m/z values corresponding to peaks that have been annotated and belong to lipids we
want to visualize.</p></td>
        </tr>
        <tr>
          <td>
                <code>list</code>
          </td>
          <td><p>m/z values of the lipids the lipids we want to visualize that have been kept.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">filter_peaks</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">array_mz_lipids_per_slice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to filter out all the spectrum data in &#39;array_spectra&#39; that</span>
<span class="sd">    has not been annotated as peak in &#39;array_peaks&#39; and that do not belong to</span>
<span class="sd">    &#39;array_mz_lipids_per_slice&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_spectra (np.ndarray): A numpy array containing spectrum data (pixel index, m/z and</span>
<span class="sd">            intensity), sorted by mz (but not necessarily by pixel index).</span>
<span class="sd">        array_peaks (np.ndarray): A numpy array containing the peak annotations (min peak, max peak,</span>
<span class="sd">            number of pixels containing the peak, average value of the peak), sorted by min_mz.</span>
<span class="sd">        array_mz_lipids_per_slice (np.ndarray): A 1-D numpy array containing the per-slice mz</span>
<span class="sd">            values of the lipids we want to visualize.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list): m/z values corresponding to peaks that have been annotated and belong to lipids we</span>
<span class="sd">            want to visualize.</span>
<span class="sd">        (list): m/z values of the lipids the lipids we want to visualize that have been kept.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define initial values</span>
    <span class="n">l_to_keep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idx_peak</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx_curr_mz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx_lipid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">l_n_pix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mz_lipid</span> <span class="o">=</span> <span class="n">array_mz_lipids_per_slice</span><span class="p">[</span><span class="n">idx_lipid</span><span class="p">]</span>
    <span class="n">l_mz_lipids_kept</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Need to initialize the set with an int inside and then delete it because numba is retarded</span>
    <span class="n">set_pix</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">set_pix</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">idx_curr_mz</span> <span class="o">&lt;</span> <span class="n">array_spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">idx_peak</span> <span class="o">&lt;</span> <span class="n">array_peaks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">idx_pix</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">array_spectra</span><span class="p">[</span><span class="n">idx_curr_mz</span><span class="p">]</span>
        <span class="n">min_mz</span><span class="p">,</span> <span class="n">max_mz</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">,</span> <span class="n">mz_estimated</span> <span class="o">=</span> <span class="n">array_peaks</span><span class="p">[</span><span class="n">idx_peak</span><span class="p">]</span>

        <span class="c1"># Either we are before the current window</span>
        <span class="k">if</span> <span class="n">mz</span> <span class="o">&lt;=</span> <span class="n">min_mz</span><span class="p">:</span>
            <span class="n">idx_curr_mz</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Either current mz is in the current window</span>
        <span class="k">elif</span> <span class="n">mz</span> <span class="o">&gt;=</span> <span class="n">min_mz</span> <span class="ow">and</span> <span class="n">mz</span> <span class="o">&lt;=</span> <span class="n">max_mz</span><span class="p">:</span>
            <span class="c1"># Adapt the index of the current lipid</span>
            <span class="k">while</span> <span class="n">mz_lipid</span> <span class="o">&lt;</span> <span class="n">min_mz</span> <span class="ow">and</span> <span class="n">idx_lipid</span> <span class="o">&lt;</span> <span class="n">array_mz_lipids_per_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">idx_lipid</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">mz_lipid</span> <span class="o">=</span> <span class="n">array_mz_lipids_per_slice</span><span class="p">[</span><span class="n">idx_lipid</span><span class="p">]</span>

            <span class="c1"># If we&#39;ve explored all lipids already, exit the loop</span>
            <span class="k">if</span> <span class="n">idx_lipid</span> <span class="o">==</span> <span class="n">array_mz_lipids_per_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">break</span>

            <span class="c1"># If mz lipid is not in the current peak, move on to the next</span>
            <span class="k">if</span> <span class="n">mz_lipid</span> <span class="o">&gt;</span> <span class="n">max_mz</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mz_estimated</span> <span class="o">-</span> <span class="n">mz_lipid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">idx_peak</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">l_n_pix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">set_pix</span><span class="p">))</span>
                <span class="n">set_pix</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># mz belong to a lipid we want to visualize</span>
                <span class="n">l_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx_curr_mz</span><span class="p">)</span>
                <span class="n">set_pix</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx_pix</span><span class="p">)</span>
                <span class="n">idx_curr_mz</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_mz_lipids_kept</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">l_mz_lipids_kept</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mz_lipid</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">mz_lipid</span> <span class="o">!=</span> <span class="n">l_mz_lipids_kept</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">l_mz_lipids_kept</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mz_lipid</span><span class="p">)</span>

        <span class="c1"># Either we&#39;re beyond, in which cas we move the window, and record the number of unique</span>
        <span class="c1"># pixels in the window for later check</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_peak</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">l_n_pix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">set_pix</span><span class="p">))</span>
            <span class="n">set_pix</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># * This piece of code is commented because it is not usable as such since the introduction of</span>
    <span class="c1"># * array_mz_lipids_per_slice as argument in the function, but it should still work if molecules</span>
    <span class="c1"># * not belonging to array_mz_lipids_per_slice are not excluded</span>
    <span class="c1"># if verbose:</span>
    <span class="c1">#     # Check that the pixel recorded are identical to the expected number of pixels recorded</span>
    <span class="c1">#     print(</span>
    <span class="c1">#         &quot;Difference between number of recorded pixels&quot;,</span>
    <span class="c1">#         np.sum(np.array(l_n_pix) - array_peaks[:, 2]),</span>
    <span class="c1">#     )</span>
    <span class="c1">#     print(np.array(l_n_pix)[-10:])</span>
    <span class="c1">#     print(array_peaks[-10:, 2])</span>

    <span class="k">return</span> <span class="n">l_to_keep</span><span class="p">,</span> <span class="n">l_mz_lipids_kept</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.get_array_peaks_to_correct" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_array_peaks_to_correct</span><span class="p">(</span><span class="n">l_lipids_float</span><span class="p">,</span> <span class="n">array_mz_lipids</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function computes an array similar to 'array_peaks', but containing only the lipids that
have been MAIA-transformed.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>l_lipids_float</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>A list containing the estimated m/z values of the lipids we want to
visualize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_mz_lipids</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A 1-D numpy array containing the per-slice mz
values of the lipids we want to visualize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_peaks</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing the peak annotations (min peak, max peak,
number of pixels containing the peak, average value of the peak), sorted by min_mz.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array similar to 'array_peaks', but containing only the lipids that have
been MAIA-transformed.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_array_peaks_to_correct</span><span class="p">(</span><span class="n">l_lipids_float</span><span class="p">,</span> <span class="n">array_mz_lipids</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes an array similar to &#39;array_peaks&#39;, but containing only the lipids that</span>
<span class="sd">    have been MAIA-transformed.</span>

<span class="sd">    Args:</span>
<span class="sd">        l_lipids_float (list): A list containing the estimated m/z values of the lipids we want to</span>
<span class="sd">            visualize.</span>
<span class="sd">        array_mz_lipids (np.ndarray): A 1-D numpy array containing the per-slice mz</span>
<span class="sd">            values of the lipids we want to visualize.</span>
<span class="sd">        array_peaks (np.ndarray): A numpy array containing the peak annotations (min peak, max peak,</span>
<span class="sd">            number of pixels containing the peak, average value of the peak), sorted by min_mz.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A numpy array similar to &#39;array_peaks&#39;, but containing only the lipids that have</span>
<span class="sd">            been MAIA-transformed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Low precision as the reference can be quite different from the actual m/z value estimated</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>

    <span class="c1"># First get the list of mz of the current slice</span>
    <span class="n">l_lipids_float_correct</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mz_lipid</span> <span class="ow">in</span> <span class="n">l_lipids_float</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Find the closest value in the whole array of annotations</span>
        <span class="n">idx_closest_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array_mz_lipids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz_lipid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">mz_per_slice</span><span class="p">,</span> <span class="n">mz_avg</span> <span class="o">=</span> <span class="n">array_mz_lipids</span><span class="p">[</span><span class="n">idx_closest_value</span><span class="p">]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mz_avg</span> <span class="o">-</span> <span class="n">mz_lipid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">precision</span><span class="p">:</span>
            <span class="n">l_lipids_float_correct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mz_per_slice</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find the annotation of the lipid </span><span class="si">{}</span><span class="s2"> in df_match.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mz_lipid</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closest mz value found was </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mz_avg</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">slice_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Slice index was </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c1"># for mz_per_slice, mz_avg in array_mz_lipids:</span>
        <span class="c1">#     if np.abs(mz_avg - mz_lipid) &lt;= precision:</span>
        <span class="c1">#         found = True</span>
        <span class="c1">#         l_lipids_float_correct.append(mz_per_slice)</span>
        <span class="c1">#         break</span>
        <span class="c1"># if not found:</span>
        <span class="c1">#     raise Exception(&quot;No lipid could be found for foldername with mz = &quot; + str(mz_lipid))</span>

    <span class="c1"># keep only the peak annotation that correspond to the lipids which have been transformed</span>
    <span class="n">rows_to_keep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Take higher precision as values should be perfectly identical here</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">4</span>
    <span class="k">for</span> <span class="n">mz_lipid</span> <span class="ow">in</span> <span class="n">l_lipids_float_correct</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="n">mini</span><span class="p">,</span> <span class="n">maxi</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">mz_est</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array_peaks</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mz_est</span> <span class="o">-</span> <span class="n">mz_lipid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">precision</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">rows_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Lipid with foldername with mz = &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mz_lipid</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; was in df_match.csv but not in ranges.csv&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">slice_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Slice index was </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
    <span class="n">array_peaks_to_correct</span> <span class="o">=</span> <span class="n">array_peaks</span><span class="p">[</span><span class="n">rows_to_keep</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">array_peaks_to_correct</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.get_standardized_values" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_standardized_values</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">path_array_data</span><span class="p">,</span> <span class="n">path_array_transformed_data</span><span class="p">,</span> <span class="n">remove_non_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function loads the values of the intensities of the the lipids whose expression have
been previously corrected using MAIA.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index of the current acquisition.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>path_array_data</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Path of the lipid intensities before transformation.
Defaults to "/data/lipidatlas/data/processed/BRAIN1".</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>path_array_transformed_data</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Path of the lipid intensities after
transformation. Defaults to "/data/lipidatlas/data/processed/BRAIN1_normalized".</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>ValueError</code>
          </td>
          <td><p>Some lipids have been transformed but the initial (untransformed) expression
data is missing.</p></td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list, list, <span title="numpy">np</span>.<span title="numpy.array">array</span>, <span title="numpy">np</span>.<span title="numpy.array">array</span></code>
          </td>
          <td><p>2 lists and 2 arrays containing respectively:
- The name of the folders containing the transformed lipid expression. The name is a
    string representing the mz value itself.
- The corresponding mz values as floats.
- The array of expression before transformation (having the same shape as the original
    acquisition).
- The array of expression after transformation (having the same shape as the original
    acquisition).</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_standardized_values</span><span class="p">(</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">path_array_data</span><span class="p">,</span>
    <span class="n">path_array_transformed_data</span><span class="p">,</span>
    <span class="n">remove_non_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads the values of the intensities of the the lipids whose expression have</span>
<span class="sd">    been previously corrected using MAIA.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): Index of the current acquisition.</span>
<span class="sd">        path_array_data (str, optional): Path of the lipid intensities before transformation.</span>
<span class="sd">            Defaults to &quot;/data/lipidatlas/data/processed/BRAIN1&quot;.</span>
<span class="sd">        path_array_transformed_data (str, optional): Path of the lipid intensities after</span>
<span class="sd">            transformation. Defaults to &quot;/data/lipidatlas/data/processed/BRAIN1_normalized&quot;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Some lipids have been transformed but the initial (untransformed) expression</span>
<span class="sd">            data is missing.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list, list, np.array, np.array): 2 lists and 2 arrays containing respectively:</span>
<span class="sd">            - The name of the folders containing the transformed lipid expression. The name is a</span>
<span class="sd">                string representing the mz value itself.</span>
<span class="sd">            - The corresponding mz values as floats.</span>
<span class="sd">            - The array of expression before transformation (having the same shape as the original</span>
<span class="sd">                acquisition).</span>
<span class="sd">            - The array of expression after transformation (having the same shape as the original</span>
<span class="sd">                acquisition).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First get list of lipids for which a transformation has been applied</span>
    <span class="n">l_lipids_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_array_data</span><span class="p">)</span>
    <span class="n">l_lipids_str_transformed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_array_transformed_data</span><span class="p">)</span>

    <span class="c1"># Return empty lists if no MALDI files exist yet</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipids_str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipids_str_transformed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Keep only lipid that have been transformed</span>
    <span class="n">l_lipids_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_lipids_str</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_lipids_str_transformed</span><span class="p">]</span>

    <span class="c1"># Assess that the two lists are identical</span>
    <span class="k">if</span> <span class="n">l_lipids_str</span> <span class="o">!=</span> <span class="n">l_lipids_str_transformed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The lipids before and after transformation are not the same&quot;</span><span class="p">)</span>

    <span class="c1"># Convert filename to float mz value</span>
    <span class="n">l_lipids_float</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l_lipids_str</span><span class="p">]</span>
    <span class="c1"># Sort the two lists by increasing m/z</span>
    <span class="n">l_lipids_str</span><span class="p">,</span> <span class="n">l_lipids_float</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">l_lipids_str</span><span class="p">,</span> <span class="n">l_lipids_float</span><span class="p">)))</span>

    <span class="c1"># Get the corresponding numpy arrays</span>
    <span class="n">l_arrays_before_transfo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">l_arrays_after_transfo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">set_idx_to_keep</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">lipid_str</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_lipids_str</span><span class="p">):</span>
        <span class="n">array_after_transfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">path_array_transformed_data</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">lipid_str</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_non_existing</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array_before_transfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">path_array_data</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">lipid_str</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># If the array doesn&#39;t exist, it means that the lipid doesn&#39;t exist for the current slice</span>
                <span class="k">continue</span>

        <span class="c1"># Create an array of zeros instead</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array_before_transfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">path_array_data</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">lipid_str</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">array_before_transfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">array_after_transfo</span><span class="p">)</span>

        <span class="n">l_arrays_before_transfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array_before_transfo</span><span class="p">)</span>
        <span class="n">l_arrays_after_transfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array_after_transfo</span><span class="p">)</span>
        <span class="n">set_idx_to_keep</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_lipids_str</span><span class="p">)</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">set_idx_to_keep</span><span class="p">],</span>
        <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l_lipids_float</span><span class="p">)</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">set_idx_to_keep</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_arrays_before_transfo</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_arrays_after_transfo</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.load_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function loads the specified MALDI file from the raw data format (.mzML and .UDP)
with the given resolution, and turns it into a scipy sparse matrix.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code>string</code>
          </td>
          <td><p>The path of the file to load.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>resolution</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The resolution of the file to load. Defaults to 1e-5.</p></td>
          <td>
                <code>1e-05</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>scipy.<span title="scipy.sparse">sparse</span></code>
          </td>
          <td><p>A sparse matrix containing the intensity for each m/z value.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads the specified MALDI file from the raw data format (.mzML and .UDP)</span>
<span class="sd">    with the given resolution, and turns it into a scipy sparse matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (string): The path of the file to load.</span>
<span class="sd">        resolution (float, optional): The resolution of the file to load. Defaults to 1e-5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (scipy.sparse): A sparse matrix containing the intensity for each m/z value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if imzML exists and load if possible</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.imzML&quot;</span><span class="p">):</span>
        <span class="n">smz</span> <span class="o">=</span> <span class="n">SmzMLobj</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.ibd&quot;</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.imzML&quot;</span><span class="p">,</span> <span class="n">mz_resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
        <span class="n">smz</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_unique_mz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load object from SmzMLobj</span>
        <span class="n">smz</span> <span class="o">=</span> <span class="n">SmzMLobj</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.mzML&quot;</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.UDP&quot;</span><span class="p">,</span> <span class="n">mz_resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
        <span class="n">smz</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_unique_mz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Compute shape of the spectra matrix to preload matrix</span>
    <span class="n">smz</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">smz</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.load_lipid_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_lipid_file</span><span class="p">(</span><span class="n">section_index</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function loads a set of specific lipid annotations containing a molecule ID, the average
mz for the molecule, the section index and potentially other information, from a csv file
located at the provided path. It returns an array of mz values corresponding to the lipids we
want to keep for further visualization.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>section_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The index of the current acquisition (first slice having index 1).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>path</code></td>
          <td>
                <code>string</code>
          </td>
          <td><p>The path of the csv file containing the lipids annotations.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array of m/z values corrsponding to the lipids that we want to
keep for further visualization (first column is per-slice value, second column is
averaged value). Sorted by individual slice value in the end.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_lipid_file</span><span class="p">(</span><span class="n">section_index</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads a set of specific lipid annotations containing a molecule ID, the average</span>
<span class="sd">    mz for the molecule, the section index and potentially other information, from a csv file</span>
<span class="sd">    located at the provided path. It returns an array of mz values corresponding to the lipids we</span>
<span class="sd">    want to keep for further visualization.</span>

<span class="sd">    Args:</span>
<span class="sd">        section_index (int): The index of the current acquisition (first slice having index 1).</span>
<span class="sd">        path (string): The path of the csv file containing the lipids annotations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A two-dimensional array of m/z values corrsponding to the lipids that we want to</span>
<span class="sd">            keep for further visualization (first column is per-slice value, second column is</span>
<span class="sd">            averaged value). Sorted by individual slice value in the end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load the peaks annotations using the last definition used for the csv file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="c1"># Drop the columns that we won&#39;t use afterwards</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;molecule_ID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Keep only the current section</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;section_ix&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">section_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Return a numpy array of mz values sorted by first column</span>
    <span class="n">array_mz_lipids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;mz_estimated&quot;</span><span class="p">,</span> <span class="s2">&quot;mz_estimated_total&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array_mz_lipids</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">array_mz_lipids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.load_peak_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_peak_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function loads the peaks annotations (including matrix peaks) from a csv file located
at the provided path. It returns a numpy array sorted by min peak value (m/z) annotation.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code>string</code>
          </td>
          <td><p>The path of the csv file containing the peaks annotations.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The sorted dataframe containing the annotations (min peak, max peak, number of
pixels containing the current molecule, estimated mz of the current molecule).</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_peak_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads the peaks annotations (including matrix peaks) from a csv file located</span>
<span class="sd">    at the provided path. It returns a numpy array sorted by min peak value (m/z) annotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (string): The path of the csv file containing the peaks annotations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): The sorted dataframe containing the annotations (min peak, max peak, number of</span>
<span class="sd">            pixels containing the current molecule, estimated mz of the current molecule).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load the peaks annotations using the last definition used for the csv file</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;/ranges&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="c1"># Drop the columns that we won&#39;t use afterwards</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;Unnamed: 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pixel_max_hits&quot;</span><span class="p">,</span>
            <span class="s2">&quot;percent_1_hit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;median_intensity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;difference&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Sort by increasing m/z annotation for the peaks</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">array</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.normalize_per_TIC_per_pixel" class="doc doc-heading">
<code class="highlight language-python"><span class="n">normalize_per_TIC_per_pixel</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">,</span> <span class="n">array_TIC</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function normalize each intensity value according to its (TIC), per pixel.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_spectra</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing spectrum data (pixel index, m/z and
intensity).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_TIC</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array of len n_pixels containing the TIC for each pixel.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing TIC-normalized spectrum data (pixel index, m/z and
intensity).</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">normalize_per_TIC_per_pixel</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">,</span> <span class="n">array_TIC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function normalize each intensity value according to its (TIC), per pixel.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_spectra (np.ndarray): A numpy array containing spectrum data (pixel index, m/z and</span>
<span class="sd">            intensity).</span>
<span class="sd">        array_TIC (np.ndarray): A numpy array of len n_pixels containing the TIC for each pixel.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A numpy array containing TIC-normalized spectrum data (pixel index, m/z and</span>
<span class="sd">            intensity).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pix_idx</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">array_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">array_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">array_TIC</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pix_idx</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">array_spectra</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.process_raw_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process_raw_data</span><span class="p">(</span><span class="n">t_index_path</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;/data/lipidatlas/data/app/data/temp/&#39;</span><span class="p">,</span> <span class="n">load_from_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function has been implemented to allow the parallelization of slice processing. It turns
the MALDI data into several numpy arrays and lookup tables:
- array_pixel_indexes_high_res: A numpy array of shape (n,2), it maps each pixel to two
    array_spectra_high_res indices, delimiting the corresponding spectrum.
- array_spectra_high_res: A numpy array of shape (2,m), it contains the concatenated spectra of
    each pixel. First row contains the m/z values, while second row contains the corresponding
    intensities.
- array_averaged_mz_intensity_low_res: A numpy array of shape (2, k), it contains the
    low-resolution spectrum averaged over all pixels. First row contains the m/z values, while
    second row contains the corresponding intensities.
- array_averaged_mz_intensity_high_res: Same as array_averaged_mz_intensity_low_res, but in
    higher resolution, with, therefore, a different shape.
- array_averaged_mz_intensity_high_res_after_standardization: Same as
    array_averaged_mz_intensity_high_res, but before applying MAIA standardization.
- image_shape: a tuple of integers, indicating the vertical and horizontal sizes of the
    corresponding slice.
- array_peaks_corrected: A two-dimensional array containing the peak annotations (min peak,
    max peak, average value of the peak), sorted by min_mz, but only for the lipids that
    have been transformed.
- array_corrective_factors: A three-dimensional numpy array equal to the ratio of
    'arrays_after_transfo' and 'arrays_before_transfo' containing the corrective factor used for
    lipid (first dimension) and each pixel (second and third dimension).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>t_index_path</code></td>
          <td>
                <code>tuple(int, str</code>
          </td>
          <td><p>A tuple containing the index of the slice (starting from 1)
and the corresponding path for the raw data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>save</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, output arrays are saved in a npz file. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>return_result</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, output arrays are returned by the function.
Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>output_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Path to save the output npz file. Defaults to
"/data/lipidatlas/data/app/data/temp/".</p></td>
          <td>
                <code>&#39;/data/lipidatlas/data/app/data/temp/&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>load_from_file</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, loads the extracted data from npz file. Only option
implemented for now.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Depending on 'return result', returns either nothing, either several np.ndarrays, described
above.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">process_raw_data</span><span class="p">(</span>
    <span class="n">t_index_path</span><span class="p">,</span>
    <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="s2">&quot;/data/lipidatlas/data/app/data/temp/&quot;</span><span class="p">,</span>
    <span class="n">load_from_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function has been implemented to allow the parallelization of slice processing. It turns</span>
<span class="sd">    the MALDI data into several numpy arrays and lookup tables:</span>
<span class="sd">    - array_pixel_indexes_high_res: A numpy array of shape (n,2), it maps each pixel to two</span>
<span class="sd">        array_spectra_high_res indices, delimiting the corresponding spectrum.</span>
<span class="sd">    - array_spectra_high_res: A numpy array of shape (2,m), it contains the concatenated spectra of</span>
<span class="sd">        each pixel. First row contains the m/z values, while second row contains the corresponding</span>
<span class="sd">        intensities.</span>
<span class="sd">    - array_averaged_mz_intensity_low_res: A numpy array of shape (2, k), it contains the</span>
<span class="sd">        low-resolution spectrum averaged over all pixels. First row contains the m/z values, while</span>
<span class="sd">        second row contains the corresponding intensities.</span>
<span class="sd">    - array_averaged_mz_intensity_high_res: Same as array_averaged_mz_intensity_low_res, but in</span>
<span class="sd">        higher resolution, with, therefore, a different shape.</span>
<span class="sd">    - array_averaged_mz_intensity_high_res_after_standardization: Same as</span>
<span class="sd">        array_averaged_mz_intensity_high_res, but before applying MAIA standardization.</span>
<span class="sd">    - image_shape: a tuple of integers, indicating the vertical and horizontal sizes of the</span>
<span class="sd">        corresponding slice.</span>
<span class="sd">    - array_peaks_corrected: A two-dimensional array containing the peak annotations (min peak,</span>
<span class="sd">        max peak, average value of the peak), sorted by min_mz, but only for the lipids that</span>
<span class="sd">        have been transformed.</span>
<span class="sd">    - array_corrective_factors: A three-dimensional numpy array equal to the ratio of</span>
<span class="sd">        &#39;arrays_after_transfo&#39; and &#39;arrays_before_transfo&#39; containing the corrective factor used for</span>
<span class="sd">        lipid (first dimension) and each pixel (second and third dimension).</span>

<span class="sd">    Args:</span>
<span class="sd">        t_index_path (tuple(int, str)): A tuple containing the index of the slice (starting from 1)</span>
<span class="sd">            and the corresponding path for the raw data.</span>
<span class="sd">        save (bool, optional): If True, output arrays are saved in a npz file. Defaults to True.</span>
<span class="sd">        return_result (bool, optional): If True, output arrays are returned by the function.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        output_path (str, optional): Path to save the output npz file. Defaults to</span>
<span class="sd">            &quot;/data/lipidatlas/data/app/data/temp/&quot;.</span>
<span class="sd">        load_from_file (bool, optional): If True, loads the extracted data from npz file. Only option</span>
<span class="sd">            implemented for now.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Depending on &#39;return result&#39;, returns either nothing, either several np.ndarrays, described</span>
<span class="sd">            above.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">load_from_file</span><span class="p">:</span>
        <span class="c1"># Get slice path</span>
        <span class="n">slice_index</span> <span class="o">=</span> <span class="n">t_index_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">t_index_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Correct output path</span>
        <span class="k">if</span> <span class="s2">&quot;MouseBrain2&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">+=</span> <span class="s2">&quot;brain_2/&quot;</span>
            <span class="n">brain_1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">+=</span> <span class="s2">&quot;brain_1/&quot;</span>
            <span class="n">brain_1</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;slice_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;raw.npz&quot;</span>
        <span class="n">npzfile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># Load individual arrays</span>
        <span class="n">array_high_res</span> <span class="o">=</span> <span class="n">npzfile</span><span class="p">[</span><span class="s2">&quot;array_high_res&quot;</span><span class="p">]</span>
        <span class="n">image_shape</span> <span class="o">=</span> <span class="n">npzfile</span><span class="p">[</span><span class="s2">&quot;image_shape&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Loading from arguments is not implemented yet&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compute and normalize pixels values according to TIC&quot;</span><span class="p">)</span>
    <span class="c1"># Get the TIC per pixel for normalization (must be done before filtering out peaks)</span>
    <span class="n">array_TIC</span> <span class="o">=</span> <span class="n">compute_TIC_per_pixel</span><span class="p">(</span><span class="n">array_high_res</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">array_high_res</span> <span class="o">=</span> <span class="n">normalize_per_TIC_per_pixel</span><span class="p">(</span><span class="n">array_high_res</span><span class="p">,</span> <span class="n">array_TIC</span><span class="p">)</span>

    <span class="c1"># Filter out the non-requested peaks and convert to array</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering out noise and matrix peaks&quot;</span><span class="p">)</span>

    <span class="c1"># Get the peak annotation file</span>
    <span class="n">array_peaks</span> <span class="o">=</span> <span class="n">load_peak_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Get the list of m/z values to keep for visualization</span>
    <span class="n">array_mz_lipids</span> <span class="o">=</span> <span class="n">load_lipid_file</span><span class="p">(</span>
        <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">10</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s2">&quot;data/annotations/df_match_brain_2.csv&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">brain_1</span>
        <span class="k">else</span> <span class="s2">&quot;data/annotations/df_match_brain_1.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get the arrays to standardize data with MAIA</span>
    <span class="p">(</span>
        <span class="n">l_lipids_str</span><span class="p">,</span>
        <span class="n">l_lipids_float</span><span class="p">,</span>
        <span class="n">arrays_before_transfo</span><span class="p">,</span>
        <span class="n">arrays_after_transfo</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">get_standardized_values</span><span class="p">(</span>
        <span class="n">slice_index</span> <span class="o">-</span> <span class="mi">10</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">brain_1</span> <span class="k">else</span> <span class="n">slice_index</span><span class="p">,</span>
        <span class="n">path_array_data</span><span class="o">=</span><span class="s2">&quot;/data/lipidatlas/data/processed/brain1/BRAIN1&quot;</span>
        <span class="k">if</span> <span class="n">brain_1</span>
        <span class="k">else</span> <span class="s2">&quot;/data/lipidatlas/data/processed/brain2/BRAIN2&quot;</span><span class="p">,</span>
        <span class="n">path_array_transformed_data</span><span class="o">=</span><span class="s2">&quot;/data/lipidatlas/data/processed/brain1/BRAIN1_normalized&quot;</span>
        <span class="k">if</span> <span class="n">brain_1</span>
        <span class="k">else</span> <span class="s2">&quot;/data/lipidatlas/data/processed/brain2/BRAIN2_normalized&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">SAMPLE_APP</span><span class="p">:</span>
        <span class="n">l_lipids_str</span> <span class="o">=</span> <span class="n">l_lipids_str</span><span class="p">[:</span><span class="n">N_SAMPLES</span><span class="p">]</span>
        <span class="n">l_lipids_float</span> <span class="o">=</span> <span class="n">l_lipids_float</span><span class="p">[:</span><span class="n">N_SAMPLES</span><span class="p">]</span>
        <span class="n">arrays_before_transfo</span> <span class="o">=</span> <span class="n">arrays_before_transfo</span><span class="p">[:</span><span class="n">N_SAMPLES</span><span class="p">]</span>
        <span class="n">arrays_after_transfo</span> <span class="o">=</span> <span class="n">arrays_after_transfo</span><span class="p">[:</span><span class="n">N_SAMPLES</span><span class="p">]</span>

    <span class="c1"># Get the array of MAIA-transformed lipids</span>
    <span class="n">array_peaks_MAIA</span> <span class="o">=</span> <span class="n">get_array_peaks_to_correct</span><span class="p">(</span>
        <span class="n">l_lipids_float</span><span class="p">,</span> <span class="n">array_mz_lipids</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="n">slice_index</span> <span class="o">-</span> <span class="mi">10</span>
    <span class="p">)</span>

    <span class="c1"># Filter out all the undesired values</span>
    <span class="n">l_to_keep_high_res</span><span class="p">,</span> <span class="n">l_mz_lipids_kept</span> <span class="o">=</span> <span class="n">filter_peaks</span><span class="p">(</span>
        <span class="n">array_high_res</span><span class="p">,</span> <span class="n">array_peaks_MAIA</span> <span class="k">if</span> <span class="n">SAMPLE_APP</span> <span class="k">else</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">array_mz_lipids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Keep only the requested peaks</span>
    <span class="n">array_high_res</span> <span class="o">=</span> <span class="n">array_high_res</span><span class="p">[</span><span class="n">l_to_keep_high_res</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prepare data for standardization&quot;</span><span class="p">)</span>
    <span class="c1"># Double sort by pixel and mz</span>
    <span class="n">array_high_res</span> <span class="o">=</span> <span class="n">array_high_res</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># Get arrays spectra and corresponding array_pixel_index tables for the high res</span>
    <span class="n">array_pixel_high_res</span> <span class="o">=</span> <span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">array_pixel_indexes_high_res</span> <span class="o">=</span> <span class="n">return_array_pixel_indexes</span><span class="p">(</span>
        <span class="n">array_pixel_high_res</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Standardize data&quot;</span><span class="p">)</span>
    <span class="c1"># Standardize a copy of a the data</span>
    <span class="p">(</span>
        <span class="n">array_high_res_standardized</span><span class="p">,</span>
        <span class="n">array_peaks_corrected</span><span class="p">,</span>
        <span class="n">array_corrective_factors</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">standardize_values</span><span class="p">(</span>
        <span class="n">array_high_res</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">array_pixel_indexes_high_res</span><span class="p">,</span>
        <span class="n">array_peaks</span><span class="p">,</span>
        <span class="n">array_mz_lipids</span><span class="p">,</span>
        <span class="n">l_lipids_float</span><span class="p">,</span>
        <span class="n">arrays_before_transfo</span><span class="p">,</span>
        <span class="n">arrays_after_transfo</span><span class="p">,</span>
        <span class="n">array_peaks_MAIA</span><span class="p">,</span>
        <span class="n">ignore_standardization</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_lipids_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Sort according to mz for averaging</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorting by m/z value for averaging&quot;</span><span class="p">)</span>
    <span class="n">array_high_res</span> <span class="o">=</span> <span class="n">array_high_res</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># Average low/high resolution arrays over identical mz across pixels</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting spectrums array averaged accross pixels&quot;</span><span class="p">)</span>
    <span class="n">array_averaged_mz_intensity_high_res</span> <span class="o">=</span> <span class="n">return_averaged_spectra_array</span><span class="p">(</span><span class="n">array_high_res</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Build the low-resolution averaged array from the high resolution averaged array&quot;</span><span class="p">)</span>
    <span class="n">array_averaged_mz_intensity_low_res</span> <span class="o">=</span> <span class="n">reduce_resolution_sorted_array_spectra</span><span class="p">(</span>
        <span class="n">array_averaged_mz_intensity_high_res</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="c1"># Same with the standardized data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorting by m/z value for averaging after standardization&quot;</span><span class="p">)</span>
    <span class="n">array_high_res_standardized</span> <span class="o">=</span> <span class="n">array_high_res_standardized</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">array_high_res_standardized</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Average low/high resolution arrays over identical mz across pixels</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting spectrums array averaged accross pixels&quot;</span><span class="p">)</span>
    <span class="n">array_averaged_mz_intensity_high_res_after_standardization</span> <span class="o">=</span> <span class="n">return_averaged_spectra_array</span><span class="p">(</span>
        <span class="n">array_high_res_standardized</span>
    <span class="p">)</span>

    <span class="c1"># Process more high-resolution data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Double sorting according to pixel and mz high-res array&quot;</span><span class="p">)</span>
    <span class="n">array_high_res</span> <span class="o">=</span> <span class="n">array_high_res</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Get arrays spectra and corresponding array_pixel_index tables for the high resolution</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting corresponding spectra arrays&quot;</span><span class="p">)</span>
    <span class="n">array_pixel_high_res</span> <span class="o">=</span> <span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">array_spectra_high_res</span> <span class="o">=</span> <span class="n">array_high_res</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">array_pixel_indexes_high_res</span> <span class="o">=</span> <span class="n">return_array_pixel_indexes</span><span class="p">(</span>
        <span class="n">array_pixel_high_res</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Save all array as a npz file as a temporary backup</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving : &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span>
            <span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;slice_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slice_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npz&quot;</span><span class="p">,</span>
            <span class="n">array_pixel_indexes_high_res</span><span class="o">=</span><span class="n">array_pixel_indexes_high_res</span><span class="p">,</span>
            <span class="n">array_spectra_high_res</span><span class="o">=</span><span class="n">array_spectra_high_res</span><span class="p">,</span>
            <span class="n">array_averaged_mz_intensity_low_res</span><span class="o">=</span><span class="n">array_averaged_mz_intensity_low_res</span><span class="p">,</span>
            <span class="n">array_averaged_mz_intensity_high_res</span><span class="o">=</span><span class="n">array_averaged_mz_intensity_high_res</span><span class="p">,</span>
            <span class="n">array_averaged_mz_intensity_high_res_after_standardization</span><span class="o">=</span><span class="n">array_averaged_mz_intensity_high_res_after_standardization</span><span class="p">,</span>
            <span class="n">image_shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">,</span>
            <span class="n">array_peaks_corrected</span><span class="o">=</span><span class="n">array_peaks_corrected</span><span class="p">,</span>
            <span class="n">array_corrective_factors</span><span class="o">=</span><span class="n">array_corrective_factors</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Returns all array if needed</span>
    <span class="k">if</span> <span class="n">return_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">array_pixel_indexes_high_res</span><span class="p">,</span>
            <span class="n">array_spectra_high_res</span><span class="p">,</span>
            <span class="n">array_averaged_mz_intensity_low_res</span><span class="p">,</span>
            <span class="n">array_averaged_mz_intensity_high_res</span><span class="p">,</span>
            <span class="n">array_averaged_mz_intensity_high_res_after_standardization</span><span class="p">,</span>
            <span class="n">image_shape</span><span class="p">,</span>
            <span class="n">array_peaks_corrected</span><span class="p">,</span>
            <span class="n">array_corrective_factors</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.process_sparse_matrix" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process_sparse_matrix</span><span class="p">(</span><span class="n">smz</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;m/z&#39;</span><span class="p">],</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function converts the space matrix into a dataframe sorted according to the 'sort'
parameter. It is possible to work only on a tiny subset of the matrix with the 'sample'
parameter for debugging purposes.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>smz</code></td>
          <td>
                <code>scipy.<span title="scipy.sparse">sparse</span></code>
          </td>
          <td><p>The sparse matrix obtained from the MALDI imaging.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sort</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>A list of column names according to which the final dataframe should
be sorted. Defaults to ["Pixel", "m/z"].</p></td>
          <td>
                <code>[&#39;Pixel&#39;, &#39;m/z&#39;]</code>
          </td>
        </tr>
        <tr>
          <td><code>sample</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>A boolean parameter to sample only a subset of the matrix. Defaults
to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>pandas.<span title="pandas.Dataframe">Dataframe</span></code>
          </td>
          <td><p>A sorted dataframe with three columns: pixels index, m/z, and intensity
value.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">process_sparse_matrix</span><span class="p">(</span><span class="n">smz</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pixel&quot;</span><span class="p">,</span> <span class="s2">&quot;m/z&quot;</span><span class="p">],</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function converts the space matrix into a dataframe sorted according to the &#39;sort&#39;</span>
<span class="sd">    parameter. It is possible to work only on a tiny subset of the matrix with the &#39;sample&#39;</span>
<span class="sd">    parameter for debugging purposes.</span>

<span class="sd">    Args:</span>
<span class="sd">        smz (scipy.sparse): The sparse matrix obtained from the MALDI imaging.</span>
<span class="sd">        sort (list, optional): A list of column names according to which the final dataframe should</span>
<span class="sd">            be sorted. Defaults to [&quot;Pixel&quot;, &quot;m/z&quot;].</span>
<span class="sd">        sample (bool, optional): A boolean parameter to sample only a subset of the matrix. Defaults</span>
<span class="sd">            to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (pandas.Dataframe): A sorted dataframe with three columns: pixels index, m/z, and intensity</span>
<span class="sd">            value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We&#39;re going to slice the matrix row by row, so it&#39;s faster to convert to csr rather than csc</span>
    <span class="n">S_row</span> <span class="o">=</span> <span class="n">smz</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="c1"># Turn S into a dict for later conversion into a dataframe</span>
    <span class="n">dic_spectra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Pixel&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;m/z&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S_row</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">S_row</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dic_spectra</span><span class="p">[</span><span class="s2">&quot;Pixel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">))</span>
        <span class="n">dic_spectra</span><span class="p">[</span><span class="s2">&quot;m/z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">smz</span><span class="o">.</span><span class="n">mz_vals</span><span class="p">[</span><span class="n">non_zero_indices</span><span class="p">])</span>
        <span class="n">dic_spectra</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">S_row</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">non_zero_indices</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">sample</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># Turn dict into a df for easier manipulation</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dic_spectra</span><span class="p">)</span>

    <span class="c1"># Sort</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Store image size as metadata</span>
    <span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;image_shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smz</span><span class="o">.</span><span class="n">img_shape</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.return_array_pixel_indexes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_array_pixel_indexes</span><span class="p">(</span><span class="n">array_pixel</span><span class="p">,</span> <span class="n">total_shape</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function returns an array of pixel indexes: for each pixel (corresponding to the index
of a given row of array_pixel_indexes), it returns the 2 boundaries in the corresponding
array_spectra (upper boundarie is included).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_pixel</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of length n containing the index of each pixel for each m/z
value.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>total_shape</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Total number of pixels in the slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>An array of shape (m,2) containing the boundary indices of each pixel in the
original spectra array.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">return_array_pixel_indexes</span><span class="p">(</span><span class="n">array_pixel</span><span class="p">,</span> <span class="n">total_shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns an array of pixel indexes: for each pixel (corresponding to the index</span>
<span class="sd">    of a given row of array_pixel_indexes), it returns the 2 boundaries in the corresponding</span>
<span class="sd">    array_spectra (upper boundarie is included).</span>

<span class="sd">    Args:</span>
<span class="sd">        array_pixel (np.ndarray): Array of length n containing the index of each pixel for each m/z</span>
<span class="sd">            value.</span>
<span class="sd">        total_shape (int): Total number of pixels in the slice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): An array of shape (m,2) containing the boundary indices of each pixel in the</span>
<span class="sd">            original spectra array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array_pixel_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">total_shape</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">array_pixel_indexes</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array_pixel</span><span class="p">):</span>
        <span class="c1"># First time pixel is encountered</span>
        <span class="k">if</span> <span class="n">array_pixel_indexes</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">array_pixel_indexes</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="c1"># Last time pixel is encountered</span>
        <span class="n">array_pixel_indexes</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">array_pixel_indexes</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.return_average_spectrum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_average_spectrum</span><span class="p">(</span><span class="n">array_intensity</span><span class="p">,</span> <span class="n">array_unique_counts</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns intensities averaged over all pixels, given the previously computed unique m/z value
across all pixels.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_intensity</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of length n containing the sorted intensities of all the
pixels of a given acquisition.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_unique_counts</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of length m containing the unique m/z values found
across all spectra from all pixels.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of length m containing the summed intensities for the unique m/z values
across all spectra from all pixels.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">return_average_spectrum</span><span class="p">(</span><span class="n">array_intensity</span><span class="p">,</span> <span class="n">array_unique_counts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns intensities averaged over all pixels, given the previously computed unique m/z value</span>
<span class="sd">    across all pixels.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_intensity (np.ndarray): Array of length n containing the sorted intensities of all the</span>
<span class="sd">            pixels of a given acquisition.</span>
<span class="sd">        array_unique_counts (np.ndarray)): Array of length m containing the unique m/z values found</span>
<span class="sd">            across all spectra from all pixels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): Array of length m containing the summed intensities for the unique m/z values</span>
<span class="sd">            across all spectra from all pixels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array_unique_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">array_unique_counts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># For each unique m/z value, sum corresponding intensities</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array_unique_counts</span><span class="p">):</span>
        <span class="n">array_unique_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array_intensity</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">count</span><span class="p">])</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="n">count</span>

    <span class="k">return</span> <span class="n">array_unique_intensity</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.return_averaged_spectra_array" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_averaged_spectra_array</span><span class="p">(</span><span class="n">array</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns full spectrum averaged over all pixels</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of shape (3,n) contaning pixel index, m/z values and intensities
in each row.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of shape (2,n) containing intensities averaged over unique m/z values
across all pixels.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">return_averaged_spectra_array</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns full spectrum averaged over all pixels</span>

<span class="sd">    Args:</span>
<span class="sd">        array (np.ndarray): Array of shape (3,n) contaning pixel index, m/z values and intensities</span>
<span class="sd">            in each row.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): Array of shape (2,n) containing intensities averaged over unique m/z values</span>
<span class="sd">            across all pixels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Take the transpose for easier browsing</span>
    <span class="n">array_spectra</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Get length of spectrum (i.e. unique mz values)</span>
    <span class="n">array_unique_mz</span><span class="p">,</span> <span class="n">array_unique_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get averaged array</span>
    <span class="n">array_unique_intensity</span> <span class="o">=</span> <span class="n">return_average_spectrum</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">array_unique_counts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">array_unique_mz</span><span class="p">,</span> <span class="n">array_unique_intensity</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.maldi_conversion.standardize_values" class="doc doc-heading">
<code class="highlight language-python"><span class="n">standardize_values</span><span class="p">(</span><span class="n">array_spectra</span><span class="p">,</span> <span class="n">array_pixel_indexes</span><span class="p">,</span> <span class="n">array_peaks</span><span class="p">,</span> <span class="n">array_mz_lipids</span><span class="p">,</span> <span class="n">l_lipids_float</span><span class="p">,</span> <span class="n">arrays_before_transfo</span><span class="p">,</span> <span class="n">arrays_after_transfo</span><span class="p">,</span> <span class="n">array_peaks_to_correct</span><span class="p">,</span> <span class="n">ignore_standardization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function rescale the intensity values of the lipids annotated with a Combat-like method
as part of the MAIA pipeline, using pre-computed intensities values.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_spectra</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing spectrum data (pixel index, m/z and
intensity), sorted by pixel index and mz.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_pixel_indexes</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array of shape (m,2) containing the boundary
indices of each pixel in the original spectra array.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_peaks</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing the peak annotations (min peak, max peak,
number of pixels containing the peak, average value of the peak), sorted by min_mz.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_mz_lipids</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A 1-D numpy array containing the per-slice mz
values of the lipids we want to visualize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>l_lipids_float</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>A list containing the estimated m/z values of the lipids we want to
visualize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>arrays_before_transfo</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array of shape (n_lipids, image_shape[0],
image_shape[1]) containing the cumulated intensities (summed over all bins) of the
lipids we want to visualize, for each pixel, before these intensities were transformed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>arrays_after_transfo</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array of shape (n_lipids, image_shape[0],
image_shape[1]) containing the cumulated intensities (summed over all bins) of the
lipids we want to visualize, for each pixel, after these intensities were transformed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_peaks_to_correct</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array similar to 'array_peaks', but containing
only the lipids that have been MAIA-transformed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ignore_standardization</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the standardization step is ignored. The function
is not useless as it still returns 'array_peaks_to_correct' and
'array_corrective_factors'.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array containing spectrum data (pixel index, m/z and intensity), sorted
by pixel index and mz, with lipids values transformed.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array similar to 'array_peaks', but containing only the lipids that have
been transformed.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A numpy array equal to the ratio of 'arrays_after_transfo' and
'arrays_before_transfo' containing the corrective factor used for lipid and each pixel.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/maldi_conversion.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">standardize_values</span><span class="p">(</span>
    <span class="n">array_spectra</span><span class="p">,</span>
    <span class="n">array_pixel_indexes</span><span class="p">,</span>
    <span class="n">array_peaks</span><span class="p">,</span>
    <span class="n">array_mz_lipids</span><span class="p">,</span>
    <span class="n">l_lipids_float</span><span class="p">,</span>
    <span class="n">arrays_before_transfo</span><span class="p">,</span>
    <span class="n">arrays_after_transfo</span><span class="p">,</span>
    <span class="n">array_peaks_to_correct</span><span class="p">,</span>
    <span class="n">ignore_standardization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function rescale the intensity values of the lipids annotated with a Combat-like method</span>
<span class="sd">    as part of the MAIA pipeline, using pre-computed intensities values.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_spectra (np.ndarray): A numpy array containing spectrum data (pixel index, m/z and</span>
<span class="sd">            intensity), sorted by pixel index and mz.</span>
<span class="sd">        array_pixel_indexes (np.ndarray): A numpy array of shape (m,2) containing the boundary</span>
<span class="sd">            indices of each pixel in the original spectra array.</span>
<span class="sd">        array_peaks (np.ndarray): A numpy array containing the peak annotations (min peak, max peak,</span>
<span class="sd">            number of pixels containing the peak, average value of the peak), sorted by min_mz.</span>
<span class="sd">        array_mz_lipids (np.ndarray): A 1-D numpy array containing the per-slice mz</span>
<span class="sd">            values of the lipids we want to visualize.</span>
<span class="sd">        l_lipids_float (list): A list containing the estimated m/z values of the lipids we want to</span>
<span class="sd">            visualize.</span>
<span class="sd">        arrays_before_transfo (np.ndarray): A numpy array of shape (n_lipids, image_shape[0],</span>
<span class="sd">            image_shape[1]) containing the cumulated intensities (summed over all bins) of the</span>
<span class="sd">            lipids we want to visualize, for each pixel, before these intensities were transformed.</span>
<span class="sd">        arrays_after_transfo (np.ndarray): A numpy array of shape (n_lipids, image_shape[0],</span>
<span class="sd">            image_shape[1]) containing the cumulated intensities (summed over all bins) of the</span>
<span class="sd">            lipids we want to visualize, for each pixel, after these intensities were transformed.</span>
<span class="sd">        array_peaks_to_correct (np.ndarray): A numpy array similar to &#39;array_peaks&#39;, but containing</span>
<span class="sd">            only the lipids that have been MAIA-transformed.</span>
<span class="sd">        ignore_standardization (bool): If True, the standardization step is ignored. The function</span>
<span class="sd">            is not useless as it still returns &#39;array_peaks_to_correct&#39; and</span>
<span class="sd">            &#39;array_corrective_factors&#39;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A numpy array containing spectrum data (pixel index, m/z and intensity), sorted</span>
<span class="sd">            by pixel index and mz, with lipids values transformed.</span>
<span class="sd">        (np.ndarray): A numpy array similar to &#39;array_peaks&#39;, but containing only the lipids that have</span>
<span class="sd">            been transformed.</span>
<span class="sd">        (np.ndarray): A numpy array equal to the ratio of &#39;arrays_after_transfo&#39; and</span>
<span class="sd">            &#39;arrays_before_transfo&#39; containing the corrective factor used for lipid and each pixel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_standardization</span><span class="p">:</span>
        <span class="c1"># Compute the transformed spectrum for each pixel</span>
        <span class="n">n_pix_transformed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_n_peaks_transformed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx_pixel</span><span class="p">,</span> <span class="p">[</span><span class="n">idx_pixel_min</span><span class="p">,</span> <span class="n">idx_pixel_max</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array_pixel_indexes</span><span class="p">):</span>
            <span class="n">array_spectra_pixel</span> <span class="o">=</span> <span class="n">array_spectra</span><span class="p">[</span><span class="n">idx_pixel_min</span> <span class="p">:</span> <span class="n">idx_pixel_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_spectra_pixel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">array_spectra_pixel</span><span class="p">,</span> <span class="n">n_peaks_transformed</span> <span class="o">=</span> <span class="n">compute_standardization</span><span class="p">(</span>
                    <span class="n">array_spectra_pixel</span><span class="p">,</span>
                    <span class="n">idx_pixel</span><span class="p">,</span>
                    <span class="n">array_peaks_to_correct</span><span class="p">,</span>
                    <span class="n">arrays_before_transfo</span><span class="p">,</span>
                    <span class="n">arrays_after_transfo</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Reattribute the corrected values to the intial spectrum</span>
                <span class="n">array_spectra</span><span class="p">[</span><span class="n">idx_pixel_min</span> <span class="p">:</span> <span class="n">idx_pixel_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_spectra_pixel</span>
                <span class="n">n_pix_transformed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">sum_n_peaks_transformed</span> <span class="o">+=</span> <span class="n">n_peaks_transformed</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="n">n_pix_transformed</span><span class="p">,</span>
            <span class="s2">&quot;have been transformed, with an average of &quot;</span><span class="p">,</span>
            <span class="n">sum_n_peaks_transformed</span> <span class="o">/</span> <span class="n">n_pix_transformed</span><span class="p">,</span>
            <span class="s2">&quot;peaks transformed&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Delete the n_pix column (3rd column) in array_peaks</span>
    <span class="n">array_peaks_to_correct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">array_peaks_to_correct</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get the array of corrective factors (per lipid per pixel), removing zero values</span>
    <span class="n">array_corrective_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">arrays_after_transfo</span> <span class="o">/</span> <span class="n">arrays_before_transfo</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span>
    <span class="p">)</span>

    <span class="c1"># Correct for negative values</span>
    <span class="n">array_corrective_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">array_corrective_factors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array_spectra</span><span class="p">,</span> <span class="n">array_peaks_to_correct</span><span class="p">,</span> <span class="n">array_corrective_factors</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../lookup_tables/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Lookup tables" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Lookup tables
            </div>
          </div>
        </a>
      
      
        
        <a href="../misc/" class="md-footer__link md-footer__link--next" aria-label="Next: Misc" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Misc
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections"], "search": "../../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>