
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A web application to explore the mouse Lipid Brain Atlas.">
      
      
        <meta name="author" content="Colas Droin">
      
      
        <link rel="canonical" href="https://lbae.epfl.ch/modules/tools/atlas/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Atlas - LBAE technical documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#modules.tools.atlas" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="LBAE technical documentation" class="md-header__button md-logo" aria-label="LBAE technical documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LBAE technical documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Atlas
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ColasDroin/lbae" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="LBAE technical documentation" class="md-nav__button md-logo" aria-label="LBAE technical documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    LBAE technical documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ColasDroin/lbae" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome page
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../main/" class="md-nav__link">
        main
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../app/" class="md-nav__link">
        app
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../index_py/" class="md-nav__link">
        index
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Modules
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modules" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Modules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../atlas_labels/" class="md-nav__link">
        atlas_labels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../atlas/" class="md-nav__link">
        atlas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../figures/" class="md-nav__link">
        figures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../launch/" class="md-nav__link">
        launch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maldi_data/" class="md-nav__link">
        maldi_data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../scRNAseq/" class="md-nav__link">
        scRNAseq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../storage/" class="md-nav__link">
        storage
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_8" type="checkbox" id="__nav_5_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_8">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tools" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_8">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Atlas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Atlas
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas" class="md-nav__link">
    modules.tools.atlas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.compute_array_images_atlas" class="md-nav__link">
    compute_array_images_atlas()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.compute_simplified_atlas_annotation" class="md-nav__link">
    compute_simplified_atlas_annotation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.fill_array_projection" class="md-nav__link">
    fill_array_projection()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.get_array_rows_from_atlas_mask" class="md-nav__link">
    get_array_rows_from_atlas_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.project_atlas_mask" class="md-nav__link">
    project_atlas_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.project_image" class="md-nav__link">
    project_image()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.slice_to_atlas_transform" class="md-nav__link">
    slice_to_atlas_transform()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.solve_plane_equation" class="md-nav__link">
    solve_plane_equation()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        Image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../lookup_tables/" class="md-nav__link">
        Lookup tables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../maldi_conversion/" class="md-nav__link">
        Maldi conversion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        Misc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spectra/" class="md-nav__link">
        Spectra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../volume/" class="md-nav__link">
        Volume
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Pages
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pages" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Pages
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/home/" class="md-nav__link">
        home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/sidebar/" class="md-nav__link">
        sidebar
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/load_slice/" class="md-nav__link">
        load_slice
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/lipid_selection/" class="md-nav__link">
        lipid_selection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/region_analysis/" class="md-nav__link">
        region_analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/threeD_exploration/" class="md-nav__link">
        threeD_exploration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../pages/scRNAseq/" class="md-nav__link">
        scRNAseq
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas" class="md-nav__link">
    modules.tools.atlas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.compute_array_images_atlas" class="md-nav__link">
    compute_array_images_atlas()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.compute_simplified_atlas_annotation" class="md-nav__link">
    compute_simplified_atlas_annotation()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.fill_array_projection" class="md-nav__link">
    fill_array_projection()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.get_array_rows_from_atlas_mask" class="md-nav__link">
    get_array_rows_from_atlas_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.project_atlas_mask" class="md-nav__link">
    project_atlas_mask()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.project_image" class="md-nav__link">
    project_image()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.slice_to_atlas_transform" class="md-nav__link">
    slice_to_atlas_transform()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.tools.atlas.solve_plane_equation" class="md-nav__link">
    solve_plane_equation()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/ColasDroin/lbae/edit/master/docs/modules/tools/atlas.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Atlas</h1>

<div class="doc doc-object doc-module">


<a id="modules.tools.atlas"></a>
  <div class="doc doc-contents first">
  
      <p>In this module, functions linking the MALDI data to the CCFv3 (e.g. getting mask or resolution 
change) are defined.</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.compute_array_images_atlas" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_array_images_atlas</span><span class="p">(</span><span class="n">array_coordinates_warped_data</span><span class="p">,</span> <span class="n">simplified_atlas_annotation</span><span class="p">,</span> <span class="n">atlas_reference</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">zero_out_of_annotation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to build a list of atlas images corresponding to the slices acquired
during the MALDI acquisition.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_coordinates_warped_data</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of coordinates of the warped,
high-resolution slices.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>simplified_atlas_annotation</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Simplified 3D array of annotations.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>atlas_reference</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>3D array of the atlas data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>resolution</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Resolution of the atlas.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>zero_out_of_annotation</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the produced set of images is such that
all the data that doesn't belong to a given structure is zeroed-out. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The first array is basically a list of atlas images corresponding
to the slices acquired during the MALDI acquisition. The second array is the
corresponding set of annotations.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">compute_array_images_atlas</span><span class="p">(</span>
    <span class="n">array_coordinates_warped_data</span><span class="p">,</span>
    <span class="n">simplified_atlas_annotation</span><span class="p">,</span>
    <span class="n">atlas_reference</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">,</span>
    <span class="n">zero_out_of_annotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to build a list of atlas images corresponding to the slices acquired</span>
<span class="sd">    during the MALDI acquisition.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_coordinates_warped_data (np.ndarray): Array of coordinates of the warped,</span>
<span class="sd">            high-resolution slices.</span>
<span class="sd">        simplified_atlas_annotation (np.ndarray): Simplified 3D array of annotations.</span>
<span class="sd">        atlas_reference (np.ndarray): 3D array of the atlas data.</span>
<span class="sd">        resolution (int): Resolution of the atlas.</span>
<span class="sd">        zero_out_of_annotation (bool, optional): If True, the produced set of images is such that</span>
<span class="sd">            all the data that doesn&#39;t belong to a given structure is zeroed-out. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray, np.ndarray): The first array is basically a list of atlas images corresponding</span>
<span class="sd">            to the slices acquired during the MALDI acquisition. The second array is the</span>
<span class="sd">            corresponding set of annotations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">array_coordinates_warped_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">array_projected_simplified_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
        <span class="n">array_images</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">simplified_atlas_annotation</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span>
    <span class="p">)</span>

    <span class="n">array_coor_rescaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">array_coordinates_warped_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="c1"># Inplace rounding for numba</span>
    <span class="n">np</span><span class="o">.</span><span class="n">round_</span><span class="p">(</span><span class="n">array_coordinates_warped_data</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">array_coor_rescaled</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">array_coor_rescaled</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">array_coor_rescaled</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">atlas_reference</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">array_coor_rescaled</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">atlas_reference</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">array_coor_rescaled</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">atlas_reference</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">array_coor_rescaled</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
                    <span class="n">array_projected_simplified_id</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">simplified_atlas_annotation</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">array_projected_simplified_id</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">zero_out_of_annotation</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">array_images</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_reference</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">array_images</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Correct for bug on inferior right margin</span>
    <span class="n">array_images</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">array_images</span><span class="p">,</span> <span class="n">array_projected_simplified_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.compute_simplified_atlas_annotation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_simplified_atlas_annotation</span><span class="p">(</span><span class="n">atlas_annotation</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to map the array of annotations (which can initially be very large
integers) to an array of annotations of similar size, but with annotations ranging from 0 to the
number of structures in the atlas.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>atlas_annotation</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Initial 3D array of annotations.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Simplified 3D array of annotations.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">compute_simplified_atlas_annotation</span><span class="p">(</span><span class="n">atlas_annotation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to map the array of annotations (which can initially be very large</span>
<span class="sd">    integers) to an array of annotations of similar size, but with annotations ranging from 0 to the</span>
<span class="sd">    number of structures in the atlas.</span>

<span class="sd">    Args:</span>
<span class="sd">        atlas_annotation (np.ndarray): Initial 3D array of annotations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): Simplified 3D array of annotations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute an array which map labels ids to increasing integers</span>
    <span class="n">unique_id_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">ni</span><span class="p">:</span> <span class="n">indi</span> <span class="k">for</span> <span class="n">indi</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atlas_annotation</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))}</span>

    <span class="n">simplified_atlas_annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">atlas_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">atlas_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">atlas_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">atlas_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">simplified_atlas_annotation</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_id_dic</span><span class="p">[</span><span class="n">atlas_annotation</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">simplified_atlas_annotation</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.fill_array_projection" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fill_array_projection</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">array_projection</span><span class="p">,</span> <span class="n">array_projection_filling</span><span class="p">,</span> <span class="n">array_projection_correspondence</span><span class="p">,</span> <span class="n">original_coor</span><span class="p">,</span> <span class="n">atlas_resolution</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">original_slice</span><span class="p">,</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">,</span> <span class="n">array_annotation</span><span class="p">,</span> <span class="n">nearest_neighbour_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">atlas_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sample_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function computes the correspondance between our initial, low-resolution, data from the
MALDI imaging, to the high-resolution space in which the registered data lives. To that end, it
computes and returns two arrays (which are passed as imputs, although empty, since numba won't
accept to create them in the scope of the function) : array_projection, which is the
high-resolution version of our initial data, in which each individual pixel has been mapped
according to the second array, array_projection_correspondence.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index of the slice to parametrize in space.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_projection</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>An empty, high-resolution, three-dimensional array which, at
the end of the function, should contain the data (one integer per coordinate,
corresponding to a pixel intensity) from our original acquisition. Note that, if no
correction is applied, since the original acquisition has a way lower resolution than
array_projection, the latter may be quite sparse.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_projection_filling</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>An empty, high-resolution, three-dimensional array
which is used to keep track of the state of array_projection; that is, which elements
have already been filled.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_projection_correspondence</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>An empty three-dimensional array which, at the
end of the function, associates, to each tripled of coordinates of the original
acquisition (slice_index, row_index, column_index), a tuple of coordinates corresponding
to the row_index and column_index of the warped higher-resolution image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>original_coor</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array which maps our initial (low-resolution)
data to the atlas coordinate system. That is, for each 2-D coordinate (x,y), it
associates a 3D coordinate (i,j,k) in the ccfv3.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>atlas_resolution</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The resolution used for the atlas, in um.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>a</code></td>
          <td>
                <code>tuple(float</code>
          </td>
          <td><p>The first of the three vectors used to parametrize the plane is space.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>u</code></td>
          <td>
                <code>tuple(float</code>
          </td>
          <td><p>The second of the three vectors used to parametrize the plane in space.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>v</code></td>
          <td>
                <code>tuple(float</code>
          </td>
          <td><p>The third of the three vectors used to parametrize the plane in space.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>original_slice</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array representing an image of the MALDI
acquisition.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_coordinates_high_res_slice</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array which maps the
high-dimensional warped data to the atlas coordinate system. That is, for each 2-D
coordinate (x,y), it associates a 3D coordinate (i,j,k) in the ccfv3.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_annotation</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A three-dimensional array containing the atlas annotation,
used to filter out the regions of our data which are outside the annotated brain, if
atlas_correction is True.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nearest_neighbour_correction</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, applies a neared-neighbour
correction, that is, for every empty pixel far from the image boundaries, it looks for
neighbours that are filled in a close window, and used the most represented value to
fill the empty pixel. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>atlas_correction</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, filters out pixels that are not annotated in the
ccfv3. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>sample_data</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the function will use the sampled version of the
slice data for the computations. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The first array is a high-resolution version of our initial data, in
which each individual pixel has been mapped according to the second array, which acts as
a mapping table.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">fill_array_projection</span><span class="p">(</span>
    <span class="n">slice_index</span><span class="p">,</span>
    <span class="n">array_projection</span><span class="p">,</span>
    <span class="n">array_projection_filling</span><span class="p">,</span>
    <span class="n">array_projection_correspondence</span><span class="p">,</span>
    <span class="n">original_coor</span><span class="p">,</span>
    <span class="n">atlas_resolution</span><span class="p">,</span>
    <span class="n">a</span><span class="p">,</span>
    <span class="n">u</span><span class="p">,</span>
    <span class="n">v</span><span class="p">,</span>
    <span class="n">original_slice</span><span class="p">,</span>
    <span class="n">array_coordinates_high_res_slice</span><span class="p">,</span>
    <span class="n">array_annotation</span><span class="p">,</span>
    <span class="n">nearest_neighbour_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">atlas_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sample_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function computes the correspondance between our initial, low-resolution, data from the</span>
<span class="sd">    MALDI imaging, to the high-resolution space in which the registered data lives. To that end, it</span>
<span class="sd">    computes and returns two arrays (which are passed as imputs, although empty, since numba won&#39;t</span>
<span class="sd">    accept to create them in the scope of the function) : array_projection, which is the</span>
<span class="sd">    high-resolution version of our initial data, in which each individual pixel has been mapped</span>
<span class="sd">    according to the second array, array_projection_correspondence.</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): Index of the slice to parametrize in space.</span>
<span class="sd">        array_projection (np.ndarray): An empty, high-resolution, three-dimensional array which, at</span>
<span class="sd">            the end of the function, should contain the data (one integer per coordinate,</span>
<span class="sd">            corresponding to a pixel intensity) from our original acquisition. Note that, if no</span>
<span class="sd">            correction is applied, since the original acquisition has a way lower resolution than</span>
<span class="sd">            array_projection, the latter may be quite sparse.</span>
<span class="sd">        array_projection_filling (np.ndarray): An empty, high-resolution, three-dimensional array</span>
<span class="sd">            which is used to keep track of the state of array_projection; that is, which elements</span>
<span class="sd">            have already been filled.</span>
<span class="sd">        array_projection_correspondence (np.ndarray): An empty three-dimensional array which, at the</span>
<span class="sd">            end of the function, associates, to each tripled of coordinates of the original</span>
<span class="sd">            acquisition (slice_index, row_index, column_index), a tuple of coordinates corresponding</span>
<span class="sd">            to the row_index and column_index of the warped higher-resolution image.</span>
<span class="sd">        original_coor (np.ndarray): A two-dimensional array which maps our initial (low-resolution)</span>
<span class="sd">            data to the atlas coordinate system. That is, for each 2-D coordinate (x,y), it</span>
<span class="sd">            associates a 3D coordinate (i,j,k) in the ccfv3.</span>
<span class="sd">        atlas_resolution (int): The resolution used for the atlas, in um.</span>
<span class="sd">        a (tuple(float)): The first of the three vectors used to parametrize the plane is space.</span>
<span class="sd">        u (tuple(float)): The second of the three vectors used to parametrize the plane in space.</span>
<span class="sd">        v (tuple(float)): The third of the three vectors used to parametrize the plane in space.</span>
<span class="sd">        original_slice (np.ndarray): A two-dimensional array representing an image of the MALDI</span>
<span class="sd">            acquisition.</span>
<span class="sd">        array_coordinates_high_res_slice (np.ndarray): A two-dimensional array which maps the</span>
<span class="sd">            high-dimensional warped data to the atlas coordinate system. That is, for each 2-D</span>
<span class="sd">            coordinate (x,y), it associates a 3D coordinate (i,j,k) in the ccfv3.</span>
<span class="sd">        array_annotation (np.ndarray): A three-dimensional array containing the atlas annotation,</span>
<span class="sd">            used to filter out the regions of our data which are outside the annotated brain, if</span>
<span class="sd">            atlas_correction is True.</span>
<span class="sd">        nearest_neighbour_correction (bool, optional): If True, applies a neared-neighbour</span>
<span class="sd">            correction, that is, for every empty pixel far from the image boundaries, it looks for</span>
<span class="sd">            neighbours that are filled in a close window, and used the most represented value to</span>
<span class="sd">            fill the empty pixel. Defaults to False.</span>
<span class="sd">        atlas_correction (bool, optional): If True, filters out pixels that are not annotated in the</span>
<span class="sd">            ccfv3. Defaults to False.</span>
<span class="sd">        sample_data (bool, optional): If True, the function will use the sampled version of the</span>
<span class="sd">            slice data for the computations. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray, np.ndarray): The first array is a high-resolution version of our initial data, in</span>
<span class="sd">            which each individual pixel has been mapped according to the second array, which acts as</span>
<span class="sd">            a mapping table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Start by inverting a simple system of linear equations for each coordinate in the initial data</span>
    <span class="c1"># to find the corresponding coordinate in the high-resolution space (this is not a trivial</span>
    <span class="c1"># problem as slices can be tilted)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mf">0.000000001</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># add small noise to solve singularity issues when inversion</span>

    <span class="k">for</span> <span class="n">i_original_slice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">original_coor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j_original_slice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">original_coor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">x_atlas</span><span class="p">,</span> <span class="n">y_atlas</span><span class="p">,</span> <span class="n">z_atlas</span> <span class="o">=</span> <span class="n">original_coor</span><span class="p">[</span><span class="n">i_original_slice</span><span class="p">,</span> <span class="n">j_original_slice</span><span class="p">]</span>

            <span class="c1"># Solve the system of linear equations</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y_atlas</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z_atlas</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="c1"># Ugly but numba won&#39;t accept any other way</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>

            <span class="c1"># If the high-resolution coordinate found be inversion exists, fill array_projection</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_slice</span><span class="p">[</span>
                        <span class="n">i_original_slice</span><span class="p">,</span> <span class="n">j_original_slice</span>
                    <span class="p">]</span>
                    <span class="n">array_projection_filling</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">array_projection_correspondence</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">i_original_slice</span><span class="p">,</span>
                        <span class="n">j_original_slice</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span>
                        <span class="n">j</span><span class="p">,</span>
                        <span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="n">i_original_slice</span><span class="p">,</span>
                        <span class="n">j_original_slice</span><span class="p">,</span>
                        <span class="n">original_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="c1"># Apply potential corrections</span>
    <span class="k">if</span> <span class="n">nearest_neighbour_correction</span> <span class="ow">or</span> <span class="n">atlas_correction</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="c1"># Look for the 3D atlas coordinate of out data</span>
                <span class="n">x_atlas</span><span class="p">,</span> <span class="n">y_atlas</span><span class="p">,</span> <span class="n">z_atlas</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">atlas_resolution</span>
                <span class="p">)</span>

                <span class="c1"># Ugly again, but numba doesn&#39;t support np.round</span>
                <span class="n">x_atlas</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x_atlas</span><span class="p">))</span>
                <span class="n">y_atlas</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y_atlas</span><span class="p">))</span>
                <span class="n">z_atlas</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">z_atlas</span><span class="p">))</span>

                <span class="c1"># If the current coordinate is contained in the ccfv3, proceed</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">x_atlas</span> <span class="o">&lt;</span> <span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">x_atlas</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">y_atlas</span> <span class="o">&lt;</span> <span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">y_atlas</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">z_atlas</span> <span class="o">&lt;</span> <span class="n">array_annotation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">z_atlas</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="c1"># If the current annotation in the ccfv3 maps to an existing structure</span>
                    <span class="k">if</span> <span class="n">array_annotation</span><span class="p">[</span><span class="n">x_atlas</span><span class="p">,</span> <span class="n">y_atlas</span><span class="p">,</span> <span class="n">z_atlas</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Nearest neighbour correction to fill most of the empty pixels in the</span>
                        <span class="c1"># high-resolution image</span>
                        <span class="k">if</span> <span class="n">nearest_neighbour_correction</span><span class="p">:</span>
                            <span class="c1"># If the pixel hasn&#39;t already been dealt with before (because of the</span>
                            <span class="c1"># way the projection is done and warping, this may happen)</span>
                            <span class="k">if</span> <span class="n">array_projection_filling</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Only fill missing areas if far from the sides</span>
                                <span class="k">if</span> <span class="p">(</span>
                                    <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">20</span>
                                    <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span>
                                    <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">20</span>
                                    <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span>
                                <span class="p">):</span>
                                    <span class="c1"># Look for neighbours that are filled in a close window</span>
                                    <span class="n">radius</span> <span class="o">=</span> <span class="mi">3</span>
                                    <span class="n">array_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                                        <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
                                    <span class="p">)</span>

                                    <span class="c1"># Temporary fill the window not to modify the value as they are</span>
                                    <span class="c1"># browsed and end up having an incremental nearest neighbor</span>
                                    <span class="c1"># correction</span>
                                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="p">(</span>
                                                <span class="n">i</span> <span class="o">+</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                                <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="ow">and</span> <span class="n">j</span> <span class="o">+</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                                <span class="ow">and</span> <span class="n">j</span> <span class="o">+</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">array_projection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            <span class="p">):</span>
                                                <span class="k">if</span> <span class="p">(</span>
                                                    <span class="n">array_projection_filling</span><span class="p">[</span>
                                                        <span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">y</span>
                                                    <span class="p">]</span>
                                                    <span class="o">==</span> <span class="mi">0</span>
                                                <span class="p">):</span>
                                                    <span class="n">array_window</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">radius</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">array_window</span><span class="p">[</span>
                                                        <span class="n">x</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">radius</span>
                                                    <span class="p">]</span> <span class="o">=</span> <span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">y</span><span class="p">]</span>
                                    <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_window</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg</span><span class="p">):</span>
                                        <span class="k">continue</span>
                                    <span class="n">clean_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array_window</span> <span class="o">-</span> <span class="n">avg</span><span class="p">)</span>
                                    <span class="c1"># Numba doesn&#39;t support nanargmin, so I have to implement it</span>
                                    <span class="c1"># myself...</span>
                                    <span class="n">mini</span> <span class="o">=</span> <span class="mi">10000</span>
                                    <span class="n">selected_pixel_x</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">selected_pixel_y</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="n">clean_window</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mini</span><span class="p">:</span>
                                                <span class="n">mini</span> <span class="o">=</span> <span class="n">clean_window</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                                                <span class="n">selected_pixel_x</span> <span class="o">=</span> <span class="n">x</span>
                                                <span class="n">selected_pixel_y</span> <span class="o">=</span> <span class="n">y</span>

                                    <span class="c1"># Fill the pixel in array projection with the most represented</span>
                                    <span class="c1"># value in the window</span>
                                    <span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_window</span><span class="p">[</span>
                                        <span class="n">selected_pixel_x</span><span class="p">,</span> <span class="n">selected_pixel_y</span>
                                    <span class="p">]</span>
                                    <span class="n">array_projection_correspondence</span><span class="p">[</span>
                                        <span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
                                    <span class="p">]</span> <span class="o">=</span> <span class="n">array_projection_correspondence</span><span class="p">[</span>
                                        <span class="n">slice_index</span><span class="p">,</span>
                                        <span class="n">i</span> <span class="o">+</span> <span class="n">selected_pixel_x</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span>
                                        <span class="n">j</span> <span class="o">+</span> <span class="n">selected_pixel_y</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span>
                                    <span class="p">]</span>
                    <span class="c1"># Wipe the pixels values that are not annotated in the atlas</span>
                    <span class="k">elif</span> <span class="n">atlas_correction</span><span class="p">:</span>
                        <span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">array_projection_filling</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">array_projection_correspondence</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Wipe the pixels values that are not in the ccfv3</span>
                <span class="k">elif</span> <span class="n">atlas_correction</span><span class="p">:</span>
                    <span class="n">array_projection</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">array_projection_filling</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">array_projection_correspondence</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">array_projection</span><span class="p">,</span> <span class="n">array_projection_correspondence</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.get_array_rows_from_atlas_mask" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_array_rows_from_atlas_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_remapped</span><span class="p">,</span> <span class="n">array_projection_correspondence_sliced</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is similar to spectra.sample_rows_from_path(), in that it returns the lower and
upper indexes of the rows belonging to the current mask (instead of path), as well as the
corresponding column boundaries for each row.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>mask</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array representing the (high-resolution, warped) mask
projected on the requested slice.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>mask_remapped</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>An empty two-dimensional array of the shape of the original
acquisition, passed a parameter as numba won't allow for np.uint8 creation inside of the
scope of the function. It is initially filled with the high-resolution warped mask
values, whose coordinates have been mapped back to the original data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_projection_correspondence_sliced</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array which
associates, to each couple of coordinates of the original acquisition (row_index,
column_index), a tuple of coordinates corresponding to the row_index and column_index of
the warped higher-resolution image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The first array contains the lower and upper indexes of the rows
belonging to the mask. The second array contains, for each row, the corresponding column
boundaries of the mask (there can be more than 2 for non-convex shapes).</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">get_array_rows_from_atlas_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_remapped</span><span class="p">,</span> <span class="n">array_projection_correspondence_sliced</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is similar to spectra.sample_rows_from_path(), in that it returns the lower and</span>
<span class="sd">    upper indexes of the rows belonging to the current mask (instead of path), as well as the</span>
<span class="sd">    corresponding column boundaries for each row.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask (np.ndarray): A two-dimensional array representing the (high-resolution, warped) mask</span>
<span class="sd">            projected on the requested slice.</span>
<span class="sd">        mask_remapped (np.ndarray): An empty two-dimensional array of the shape of the original</span>
<span class="sd">            acquisition, passed a parameter as numba won&#39;t allow for np.uint8 creation inside of the</span>
<span class="sd">            scope of the function. It is initially filled with the high-resolution warped mask</span>
<span class="sd">            values, whose coordinates have been mapped back to the original data.</span>
<span class="sd">        array_projection_correspondence_sliced (np.ndarray): A two-dimensional array which</span>
<span class="sd">            associates, to each couple of coordinates of the original acquisition (row_index,</span>
<span class="sd">            column_index), a tuple of coordinates corresponding to the row_index and column_index of</span>
<span class="sd">            the warped higher-resolution image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray, np.ndarray): The first array contains the lower and upper indexes of the rows</span>
<span class="sd">            belonging to the mask. The second array contains, for each row, the corresponding column</span>
<span class="sd">            boundaries of the mask (there can be more than 2 for non-convex shapes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Map back the mask coordinates to original data</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">x_original</span><span class="p">,</span> <span class="n">y_original</span> <span class="o">=</span> <span class="n">array_projection_correspondence_sliced</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">x_original</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">x_original</span> <span class="o">&lt;</span> <span class="n">mask_remapped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">y_original</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">y_original</span> <span class="o">&lt;</span> <span class="n">mask_remapped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">mask_remapped</span><span class="p">[</span><span class="n">x_original</span><span class="p">,</span> <span class="n">y_original</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>

    <span class="c1"># Then compute the column boundaries for each row</span>
    <span class="n">ll_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_remapped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">l_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_remapped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">mask_remapped</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="n">y</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">mask_remapped</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">first</span><span class="p">:</span>
                <span class="c1"># Correct for bug due to mask assignment with different resolution</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask_remapped</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">5</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">y</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">l_rows</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># If two boundaries have been obtained, add them to the list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ll_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_rows</span><span class="p">)</span>

    <span class="c1"># Get the indices of the first and last rows</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">ll_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">ll_rows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">l_rows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l_rows</span> <span class="ow">in</span> <span class="n">ll_rows</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Convert list of np.array to np array padded with zeros (for numba compatibility)</span>
    <span class="n">array_index_bound_column_per_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_len</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l_rows</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ll_rows</span><span class="p">):</span>
        <span class="n">array_index_bound_column_per_row</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_rows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_rows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">array_index_bound_column_per_row</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.project_atlas_mask" class="doc doc-heading">
<code class="highlight language-python"><span class="n">project_atlas_mask</span><span class="p">(</span><span class="n">stack_mask</span><span class="p">,</span> <span class="n">slice_coordinates_rescaled</span><span class="p">,</span> <span class="n">shape_atlas</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function projects a mask array_annotation (obtained from the atlas, sliced from a
3-dimensional object) on our two-dimensional, high-resolution warped data, for a given slice.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>stack_mask</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A three-dimensional array indexed with the ccfv3. It contains a
zero if the selected coordinate is outside the mask array_annotation, and 1 otherwise.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slice_coordinates_rescaled</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array mapping our slice
coordinate (rescaled and discretized) to the ccfv3.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>shape_atlas</code></td>
          <td>
                <code>tuple(int</code>
          </td>
          <td><p>A tuple of three integers representing the shape of the
ccfv3-indexed atlas.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array representing the projected mask on the requested slice.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">project_atlas_mask</span><span class="p">(</span><span class="n">stack_mask</span><span class="p">,</span> <span class="n">slice_coordinates_rescaled</span><span class="p">,</span> <span class="n">shape_atlas</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function projects a mask array_annotation (obtained from the atlas, sliced from a</span>
<span class="sd">    3-dimensional object) on our two-dimensional, high-resolution warped data, for a given slice.</span>

<span class="sd">    Args:</span>
<span class="sd">        stack_mask (np.ndarray): A three-dimensional array indexed with the ccfv3. It contains a</span>
<span class="sd">            zero if the selected coordinate is outside the mask array_annotation, and 1 otherwise.</span>
<span class="sd">        slice_coordinates_rescaled (np.ndarray): A two-dimensional array mapping our slice</span>
<span class="sd">            coordinate (rescaled and discretized) to the ccfv3.</span>
<span class="sd">        shape_atlas (tuple(int)): A tuple of three integers representing the shape of the</span>
<span class="sd">            ccfv3-indexed atlas.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A two-dimensional array representing the projected mask on the requested slice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define empty array for the projected mask, with the same dimension as the current slice</span>
    <span class="c1"># ! Delete this comment if everything is working, else switch back to int16 or int32</span>
    <span class="n">projected_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
        <span class="n">slice_coordinates_rescaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">stack_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slice_coordinates_rescaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slice_coordinates_rescaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">current_coor_rescaled</span> <span class="o">=</span> <span class="n">slice_coordinates_rescaled</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="c1"># If the current slice coordinate actually exists in the atlas, maps it to the</span>
            <span class="c1"># corresponding mask value</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">current_coor_rescaled</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">current_coor_rescaled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">shape_atlas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">current_coor_rescaled</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">shape_atlas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">current_coor_rescaled</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">shape_atlas</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">projected_mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack_mask</span><span class="p">[</span>
                    <span class="n">current_coor_rescaled</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_coor_rescaled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">current_coor_rescaled</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">]</span>
    <span class="k">return</span> <span class="n">projected_mask</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.project_image" class="doc doc-heading">
<code class="highlight language-python"><span class="n">project_image</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">original_image</span><span class="p">,</span> <span class="n">array_projection_correspondence</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to project the original maldi acquisition (low-resolution, possibly
tilted, and) into a warped and higher resolution, indexed with the Allen Mouse Brain Common
Coordinate Framework (ccfv3).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slice_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Index of the slice to project.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>original_image</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array representing the MADI data of the
current slice (e.g. for a given lipid selection).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>array_projection_correspondence</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A three-dimensional array which associates, to
each triplet of coordinates of the original acquisition (slice_index, row_index,
column_index), a tuple of coordinates corresponding to the row_index and column_index of
the warped higher-resolution image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A warped, high-resolution image, corresponding to the clean, registered version,
of our acquisition.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">project_image</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">original_image</span><span class="p">,</span> <span class="n">array_projection_correspondence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to project the original maldi acquisition (low-resolution, possibly</span>
<span class="sd">    tilted, and) into a warped and higher resolution, indexed with the Allen Mouse Brain Common</span>
<span class="sd">    Coordinate Framework (ccfv3).</span>

<span class="sd">    Args:</span>
<span class="sd">        slice_index (int): Index of the slice to project.</span>
<span class="sd">        original_image (np.ndarray): A two-dimensional array representing the MADI data of the</span>
<span class="sd">            current slice (e.g. for a given lipid selection).</span>
<span class="sd">        array_projection_correspondence (np.ndarray): A three-dimensional array which associates, to</span>
<span class="sd">            each triplet of coordinates of the original acquisition (slice_index, row_index,</span>
<span class="sd">            column_index), a tuple of coordinates corresponding to the row_index and column_index of</span>
<span class="sd">            the warped higher-resolution image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): A warped, high-resolution image, corresponding to the clean, registered version,</span>
<span class="sd">            of our acquisition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Correct index as slice names start at 1</span>
    <span class="n">slice_index</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># Define empty array for the high-resolution image</span>
    <span class="n">new_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">array_projection_correspondence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">original_image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Exclude the borders of the image to gain some time</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">array_projection_correspondence</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">array_projection_correspondence</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">):</span>
            <span class="c1"># Maps the original coordinates to the new one, with coordinate -1 corresponding</span>
            <span class="c1"># to unassigned</span>
            <span class="k">if</span> <span class="n">array_projection_correspondence</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">array_projection_correspondence</span><span class="p">[</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">new_image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_image</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">new_image</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.slice_to_atlas_transform" class="doc doc-heading">
<code class="highlight language-python"><span class="n">slice_to_atlas_transform</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">lambd</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function returns a 3D coordinate (in the ccfv3) from a 2D slice coordinate, using the
parameters obtained from the inversion made in solve_plane_equation().</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>a</code></td>
          <td>
                <code>tuple(float</code>
          </td>
          <td><p>The first of the three vectors used to parametrize the plane is space.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>u</code></td>
          <td>
                <code>tuple(float</code>
          </td>
          <td><p>The second of the three vectors used to parametrize the plane in space.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>v</code></td>
          <td>
                <code>tuple(float</code>
          </td>
          <td><p>The third of the three vectors used to parametrize the plane in space.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>lambd</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The first coordinate of our slice (height of the required point).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>mu</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The second coordinate of our slice (width of the required point).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>int, int, int</code>
          </td>
          <td><p>A 3D coordinate in the ccfv3, mapping our flat (2D) data to the atlas
coordinate system.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">slice_to_atlas_transform</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">lambd</span><span class="p">,</span> <span class="n">mu</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns a 3D coordinate (in the ccfv3) from a 2D slice coordinate, using the</span>
<span class="sd">    parameters obtained from the inversion made in solve_plane_equation().</span>

<span class="sd">    Args:</span>
<span class="sd">        a (tuple(float)): The first of the three vectors used to parametrize the plane is space.</span>
<span class="sd">        u (tuple(float)): The second of the three vectors used to parametrize the plane in space.</span>
<span class="sd">        v (tuple(float)): The third of the three vectors used to parametrize the plane in space.</span>
<span class="sd">        lambd (int): The first coordinate of our slice (height of the required point).</span>
<span class="sd">        mu (int): The second coordinate of our slice (width of the required point).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (int, int, int): A 3D coordinate in the ccfv3, mapping our flat (2D) data to the atlas</span>
<span class="sd">            coordinate system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Equation of a plan in space</span>
    <span class="n">x_atlas</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_atlas</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z_atlas</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x_atlas</span><span class="p">,</span> <span class="n">y_atlas</span><span class="p">,</span> <span class="n">z_atlas</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.tools.atlas.solve_plane_equation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">solve_plane_equation</span><span class="p">(</span><span class="n">array_coordinates_high_res_slice</span><span class="p">,</span> <span class="n">point_1</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span> <span class="n">point_2</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">point_3</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">))</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function defines and solves a system of linear equations for three points of the plane
(which corresponds to a slice in the ccfv3). The vectors returned by the function enable to
index the 2D slice in the 3D atlas space (ccfv3), cf. slice_to_atlas_transform(). Note that the
three points can not be taken at the extremities of the slice, as the registration made with
ABBA is buggued and the origin doesn't linearly maps to the 3D plane.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>array_coordinates_high_res_slice</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>A two-dimensional array which maps the
high-dimensional warped data to the atlas coordinate system. That is, for each 2-D
coordinate (x,y), it associates a 3D coordinate (i,j,k) in the ccfv3.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>point_1</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td><p>Couple of coordinates corresponding to the first point indexed on
the 3D plane. Defaults to (50, 51).</p></td>
          <td>
                <code>(50, 51)</code>
          </td>
        </tr>
        <tr>
          <td><code>point_2</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td><p>Couple of coordinates corresponding to the first point indexed on
the 3D plane. Defaults to (400, 200).</p></td>
          <td>
                <code>(200, 200)</code>
          </td>
        </tr>
        <tr>
          <td><code>point_3</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td><p>Couple of coordinates corresponding to the first point indexed on
the 3D plane. Defaults to (100, 101).</p></td>
          <td>
                <code>(100, 101)</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>tuple(float), tuple(float), tuple(float)</code>
          </td>
          <td><p>Three vectors allowing to parametrize the
coordinate of our slice in the ccfv3.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/tools/atlas.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">solve_plane_equation</span><span class="p">(</span>
    <span class="n">array_coordinates_high_res_slice</span><span class="p">,</span>
    <span class="n">point_1</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span>
    <span class="n">point_2</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
    <span class="n">point_3</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">),</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function defines and solves a system of linear equations for three points of the plane</span>
<span class="sd">    (which corresponds to a slice in the ccfv3). The vectors returned by the function enable to</span>
<span class="sd">    index the 2D slice in the 3D atlas space (ccfv3), cf. slice_to_atlas_transform(). Note that the</span>
<span class="sd">    three points can not be taken at the extremities of the slice, as the registration made with</span>
<span class="sd">    ABBA is buggued and the origin doesn&#39;t linearly maps to the 3D plane.</span>

<span class="sd">    Args:</span>
<span class="sd">        array_coordinates_high_res_slice (np.ndarray): A two-dimensional array which maps the</span>
<span class="sd">            high-dimensional warped data to the atlas coordinate system. That is, for each 2-D</span>
<span class="sd">            coordinate (x,y), it associates a 3D coordinate (i,j,k) in the ccfv3.</span>
<span class="sd">        point_1 (tuple, optional): Couple of coordinates corresponding to the first point indexed on</span>
<span class="sd">            the 3D plane. Defaults to (50, 51).</span>
<span class="sd">        point_2 (tuple, optional): Couple of coordinates corresponding to the first point indexed on</span>
<span class="sd">            the 3D plane. Defaults to (400, 200).</span>
<span class="sd">        point_3 (tuple, optional): Couple of coordinates corresponding to the first point indexed on</span>
<span class="sd">            the 3D plane. Defaults to (100, 101).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple(float), tuple(float), tuple(float)): Three vectors allowing to parametrize the</span>
<span class="sd">            coordinate of our slice in the ccfv3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define empty array for the linear system of equations</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">9</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Fill the matrices, such that Ax=b, where A represents the projection from 2D coordinates (x)</span>
    <span class="c1"># to the ccfv3 (b)</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_coordinates_high_res_slice</span><span class="p">[</span><span class="n">point_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Invert the system of equation</span>
    <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">u_atlas</span> <span class="o">=</span> <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span><span class="p">)</span>
    <span class="n">v_atlas</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">)</span>
    <span class="n">a_atlas</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a_atlas</span><span class="p">,</span> <span class="n">u_atlas</span><span class="p">,</span> <span class="n">v_atlas</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../storage/" class="md-footer__link md-footer__link--prev" aria-label="Previous: storage" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              storage
            </div>
          </div>
        </a>
      
      
        
        <a href="../image/" class="md-footer__link md-footer__link--next" aria-label="Next: Image" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Image
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections"], "search": "../../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>